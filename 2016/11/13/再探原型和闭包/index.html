<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">再探原型和闭包</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2016/11/13 23:44:59</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近看见一篇关于原型和闭包的博文，十分精彩，传送门：<a href="http://www.cnblogs.com/wangfupeng1988/p/3977924.html" target="_blank" rel="external">深入理解javascript原型和闭包（完结）-王福朋</a>。看完有种茅舍顿开的感觉，之前自己总结的原型链和闭包，实在是有失偏颇，因此在参考这篇文章，重新整理了原型链和作用域链的知识，加以巩固。<br><a id="more"></a></p>
<h2 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h2><h3 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h3><p>所有的对象都是由其构造函数创建，基础对象最基本的构造函数是Obecjt()。<br>每个对象都有一个” <strong> proto</strong> “的属性，指向该对象构造函数的原型，该属性也被称为隐式原型。<br>每个函数都有一个”prototype”的属性，表示这个构造函数的原型，函数的原型实际上是一个对象，并且该对象有一个construct的属性，指向构造函数本身。</p>
<p>同时，由于函数也是对象，所有函数的构造函数都是Function()。函数的隐式原型就是Function()的显式原型。<br>甚至连Object()函数的构造函数都是Function()，假设存在构造函数Aoo()和其实例化对象a，存在下面的关系：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">a.__proto__ == Foo.prototype; // 对象的隐式原型指向其构造函数的显式原型</div><div class="line"></div><div class="line">Foo.__proto__ == Function.prototype; // 函数的构造函数是Function()</div><div class="line"></div><div class="line">Foo.prototype.__proto__ == Object.prototype; // 原型也是一个对象，对象的基本构造函数是Object()</div><div class="line"></div><div class="line">Object.__proto__ == Function.prototype; // Object()函数的构造函数也是Function()</div><div class="line"></div><div class="line">Function.__proto__ == Function.prototype; // Function()函数是被自身创建的-_-</div><div class="line"></div><div class="line">Function.prototype.__proto__ == Object.prototype; // Function()的原型也是对象</div><div class="line"></div><div class="line">Object.prototype.__proto__ == null; // Object.prototype 是第一个对象，所有对象的基础属性和方法都源于此,所以他的隐式原型是null。</div></pre></td></tr></table></figure></p>
<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>JS中的继承是通过原型链来体现的：访问一个对象的属性时，先在基本属性中查找，如果没有，再沿着<strong>proto</strong>这条链向上找，这就是原型链。<br>如果将构造函数A的原型是构造函数B的实例对象，则A的实例对象就可以通过A.prototype获取到b的属性和方法（因为A.prototype == b）。<br>可以使用hasOwnProperty方法来判断一个属性到底是实例对象的还是其原型的。</p>
<p>可以通过使用instanceof来判断两个类是否存在继承关系，其规则为：<br>沿着左操作数的<strong>proto</strong>这条线来找，同时沿着右操作数的prototype这条线来找，如果两条线能找到同一个引用，即同一个对象，那么就返回true。如果找到终点还未重合，则返回false。<br>通过上面的关系，就可以解释下面的问题了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">console.log(Object instanceof Function); // true </div><div class="line">console.log(Function instanceof Function); // true</div><div class="line">console.log(Function instanceof Object); // true</div></pre></td></tr></table></figure></p>
<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><h3 id="环境上下文"><a href="#环境上下文" class="headerlink" title="环境上下文"></a>环境上下文</h3><p>环境上下文，分为全局上下文和函数上下文：</p>
<ul>
<li>全局上下文中的数据内容包括<ul>
<li>普通变量声明</li>
<li>函数声明</li>
<li>this</li>
</ul>
</li>
<li>函数上下文中的数据内容除了上面三种情形，还包括<ul>
<li>参数</li>
<li>arguments</li>
<li>自由变量（指不在该上下文中声明的变量）</li>
</ul>
</li>
</ul>
<p>所谓的执行环境上下文，指的是：在执行代码之前,解析器会进行变量声明提前，也就是说会把这段代码将要用到的所有变量都事先拿出来，有的直接赋值了，有的先用undefined占个空。</p>
<ul>
<li>变量、函数表达式声明，默认赋值为undefined占位；</li>
<li>this——赋值；</li>
<li>函数语句声明——赋值；</li>
</ul>
<h3 id="上下文栈"><a href="#上下文栈" class="headerlink" title="上下文栈"></a>上下文栈</h3><p>下面是代码执行的大致过程：</p>
<ol>
<li>在加载程序时，已经确定了全局上下文环境以及执行上下文（变量声明提前等准备工作），并随着程序的执行对变量进行赋值。    </li>
<li>在函数体的语句执行之前，arguments变量和函数的参数都已经被赋值。因此，函数每被调用一次，都会产生一个新的执行上下文环（即使是同一个函数（甚至是相同参数），在不同的调用下产生的上下文环境也是不一样的）。    </li>
<li>当程序运行到将要调用函数的时候，会生成该函数的上下文环境，然后将此上下文压入上下文环境栈并设置为活动状态。  </li>
<li>然后执行函数内部的代码，如果遇见函数调用则重复上述步骤：产生新的上下文-&gt;入栈并设置为活动状态-&gt;执行函数代码; </li>
<li>当这个函数调用完毕,则其上下文环境被销毁，从上下文环境栈弹出，此时程序又回到了其父作用域下的上下文环境，并在栈中将其置为活动状态</li>
<li>按照此过程进行，到最后上下文环境栈中只剩下了全局上下文环境（当然这是在没有闭包的情况下）</li>
</ol>
<h3 id="函数内部的数据内容"><a href="#函数内部的数据内容" class="headerlink" title="函数内部的数据内容"></a>函数内部的数据内容</h3><p>上面提到，函数上下文中的数据内容，除了普通变量声明，函数声明和this之外，还多了参数，arguments对象和自由变量。</p>
<h4 id="自由变量"><a href="#自由变量" class="headerlink" title="自由变量"></a>自由变量</h4><p>自由变量的定义：在fn函数中使用的变量x，却没有在A作用域中声明，对于fn函数作用域来说，x就是一个自由变量。<br>函数在定义的时候（不是调用的时候），就已经确定了函数体内部自由变量的作用域。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">var a = 10;</div><div class="line">function fn()&#123;</div><div class="line">    console.log(a);</div><div class="line">&#125;</div><div class="line"></div><div class="line">function foo(f)&#123;</div><div class="line">    var a = 20;</div><div class="line">    f();</div><div class="line">&#125;</div><div class="line"></div><div class="line">foo(fn); // 10</div></pre></td></tr></table></figure></p>
<h4 id="this"><a href="#this" class="headerlink" title="this"></a>this</h4><p>跟自由变量不同的是，函数内部的this取何值，是在函数真正被调用执行的时候确定的，因为函数定义的时候根本确定不了。</p>
<ul>
<li>如果函数作为构造函数用，那么其中的this就代表它即将new出来的对象,在原型链中，this代表的也都是当前对象的值;但是如果直接把构造函数当作普通函数调用，则其的this会变成window</li>
<li>如果函数作为对象的一个属性时，并且作为对象的一个属性被调用时，函数中的this指向该对象;但是如果方法函数被赋值到了另一个变量中，并没有作为obj的一个属性被调用，那么this的值就是window，此时就无法在函数中使用this获取原对象的属性</li>
<li>当一个函数被call和apply调用时，this的值就取传入的对象的值</li>
<li>全局环境下，this永远是window,普通函数在调用时，其中的this也都是window</li>
<li>闭包函数中的this也是window。</li>
</ul>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>JS中只有全局作用域和函数作用域，并没有“块级作用域”的概念，函数作用域是在函数定义时生成的。<br>作用域只是一个抽象的概念，其中没有变量。要通过作用域对应的执行上下文环境来获取变量的值。同一个作用域下，不同的调用会产生不同的执行上下文环境，继而产生不同的变量的值。所以，如果要查找一个作用域下某个变量的值，就需要找到这个作用域对应的执行上下文环境，再在其中寻找变量的值。牢牢记住，作用域中变量的值是在执行过程中产生的确定的，而作用域却是在函数创建时就确定了。  </p>
<p>作用域内部声明的变量（包括参数）会覆盖掉外部的同名变量，这正是我们需要的。那么，程序是如何确定作用域下的某个上下文中所使用的自由变量呢？</p>
<p>前面提到过：函数在定义的时候（不是调用的时候），就已经确定了函数体内部自由变量的作用域。<br>在fn函数中，取自由变量x的值时，要到创建fn函数的那个作用域中取,无论fn函数将在哪里调用。 如果跨了一步，还没找到呢？接着跨！一直跨到全局作用域为止。要是在全局作用域中都没有找到，那就是真的没有了。</p>
<p>这个一步一步“跨”来寻找自由变量的路线，就是我们常说的“作用域链”。</p>
<h3 id="闭包函数"><a href="#闭包函数" class="headerlink" title="闭包函数"></a>闭包函数</h3><p>了解了作用域链，理解闭包就十分轻松了。关于闭包，有一个不那么精准的定义：一个作为函数返回值或者函数参数的函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">// 作为函数返回值</div><div class="line">function fn()&#123;</div><div class="line">    var a = 100;</div><div class="line">    return function foo(x)&#123;</div><div class="line">        if (x &gt; a)&#123;</div><div class="line">            console.log(&quot;more&quot;);</div><div class="line">        &#125;else &#123;</div><div class="line">            console.log(&quot;less or equal&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">var a = 10;</div><div class="line">var f = fn();</div><div class="line">f(50); // &quot;less or equal&quot;</div><div class="line"></div><div class="line">// 作为参数</div><div class="line">var a = 10;</div><div class="line">var fn = function(x)&#123;</div><div class="line">    if (x &gt; a)&#123;</div><div class="line">        console.log(&quot;more&quot;);</div><div class="line">    &#125;else &#123;</div><div class="line">        console.log(&quot;less or equal&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">!(function(f)&#123;</div><div class="line">    // 这里的闭包是形参f而不是实参fn，fn只是一个普通的函数表达式声明的函数</div><div class="line">    var a = 100;</div><div class="line">    f(50); // &quot;more&quot;</div><div class="line">&#125;)(fn);</div></pre></td></tr></table></figure></p>
<p>在前面的上下文栈中提到：当函数调用结束，其执行上下文将从上下文栈中弹出并被销毁，其中的变量也随之被销毁，这里的例外就是闭包。</p>
<p>由于闭包函数是在函数内部定义的函数（函数可以创建一个独立的作用域），因此如果在闭包中使用其定义函数上下文中的自由变量，或者在其他地方调用该函数，则必须保证其定义函数的执行上下文仍然存在（如果跟普通的函数一样调用结束就被销毁，则就无法找到其中的数据内容了。），所以如果函数上下文中存在闭包，则在调用结束之后不会被销毁，而是保存在上下文栈中（尽管活动状态已经被切换为上一层），而之所以说使用闭包会增加内存开销，就是这个原因。</p>
<p>总之，理解闭包，弄清楚环境上下文和作用域链是十分必要的，此外，牢记“<strong>函数在定义的时候（不是调用的时候），就已经确定了函数体内部自由变量的作用域</strong> ”。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>这个世界上有无数优秀且勤奋的人，然而我并不是其中的一个。感谢这么多前辈愿意在互联网上分享自己的学习笔记和心得，我现在能做的就是抓紧学习，希望有朝一日也能为社区的发展贡献绵薄之力。加油吧！</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/原型" class="article_tag">#原型</a>
        
        <a href="/tags/闭包" class="article_tag">#闭包</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#原型链"><span class="toc-number">1.</span> <span class="toc-text">原型链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原型"><span class="toc-number">1.1.</span> <span class="toc-text">原型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#继承"><span class="toc-number">1.2.</span> <span class="toc-text">继承</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#闭包"><span class="toc-number">2.</span> <span class="toc-text">闭包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境上下文"><span class="toc-number">2.1.</span> <span class="toc-text">环境上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上下文栈"><span class="toc-number">2.2.</span> <span class="toc-text">上下文栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#函数内部的数据内容"><span class="toc-number">2.3.</span> <span class="toc-text">函数内部的数据内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自由变量"><span class="toc-number">2.3.1.</span> <span class="toc-text">自由变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#this"><span class="toc-number">2.3.2.</span> <span class="toc-text">this</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#作用域"><span class="toc-number">2.4.</span> <span class="toc-text">作用域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#闭包函数"><span class="toc-number">2.5.</span> <span class="toc-text">闭包函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最后"><span class="toc-number">3.</span> <span class="toc-text">最后</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>