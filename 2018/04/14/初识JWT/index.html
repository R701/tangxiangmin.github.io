<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">初识JWT</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2018/4/14 8:00:57</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/技术原理" class="hover-highlight">技术原理</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近一直在整理过去的项目经历，其中有一个使用vue-cli和Element-UI搭建的后台管理单页应用，其中的管理员权限认证用到了<code>JSON Web Token</code>，之前在做博客的后台管理系统的时候（虽然现在基本没用过了），也采用和同样的认证方式，当时只是简单对着文档进行实现，对其原理并没有很深刻的认识，因此决定稍作整理。<br><a id="more"></a></p>
<p>参考：</p>
<ul>
<li><a href="https://blog.leapoahead.com/2015/09/06/understanding-jwt/" target="_blank" rel="external">JSON Web Token - 在Web应用间安全地传递信息</a>，强烈推荐</li>
<li><a href="https://jwt.io/introduction/" target="_blank" rel="external">官方文档</a></li>
<li><a href="https://juejin.im/post/5a6c60166fb9a01caf37a5e5" target="_blank" rel="external">Token 认证的来龙去脉</a></li>
<li><a href="https://juejin.im/entry/5993a030f265da24941202c2" target="_blank" rel="external">讲真，别再使用JWT了！</a>，这里有个扩展阅读哈哈</li>
</ul>
<h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><p>在单页应用中，通过Token实现用户的身份权限认证，大致流程如下</p>
<ul>
<li>用户首次登陆输入账户密码，后台接口验证通过，则返回一个token值</li>
<li>用户接受到服务器传回的token后，然后保存在本地，</li>
<li>在之后的接口请求中都附带该token值，用于服务器进行用户身份权限校验</li>
<li>如果校验通过，则返回正常数据；如果不通过，返回401错误，跳转到登录界面</li>
</ul>
<p>其中由几个关键点，下面一一道来</p>
<h3 id="token"><a href="#token" class="headerlink" title="token"></a>token</h3><p>token包含一些关键信息，也可以转码成原始数据，这样后台才能解析token相关的信息。</p>
<p><strong>token生成</strong><br>需要防止token被修改过伪造，否则token进行的身份认证将毫无意义。</p>
<p>一般会通过密钥对token进行加密，密钥由后台控制，不会传递给前端。</p>
<p><strong>token有效期</strong><br>token包含过期校验，可以通过保存一个过期时间expries字段，也可以通过token的保存机制（比如cookie，下面会提到）来实现。</p>
<p>一旦token过期，则需要让旧的token失效，然后判断用户是不是仍在使用应用；如果是，则需要返回一个新的token，或者更新旧token的有效期。</p>
<h3 id="保存token"><a href="#保存token" class="headerlink" title="保存token"></a>保存token</h3><p>获取到token后，需要将其保存在本地，前端本地保存常见的有三种形式（这个好像是一个常见的面试题~）</p>
<p><strong>localStorage</strong></p>
<p>不能跨子域名共享，可以持久化保存，需要手动实现认证过期机制</p>
<p><strong>sessionStorage</strong></p>
<p>不能在子域名共享，也不能跨窗口共享，关闭窗口后就会被清除，如果业务比较敏感可以采用</p>
<p><strong>document.cookie</strong></p>
<p>可以跨子域名共享（将所有子域名的domain都修改成顶级域名即可），可以通过设置过期时间控制token的有效期。</p>
<p>需要注意的是这里只是把cookie作为前端存储机制，对应的cookie字段本身并不参与后台的权限认证逻辑中，这样可以避免CSRF攻击</p>
<h3 id="流程实现"><a href="#流程实现" class="headerlink" title="流程实现"></a>流程实现</h3><p>通过上面的流程，我们需要实现的主要有三个部分</p>
<ul>
<li>token的生成机制，如果保存基础信息，以及token的加密机制</li>
<li>前端在每次的请求中都需要附带对应的token，这可以通过请求拦截器处理。在项目中使用的是<code>axios.interceptors.request</code>，为请求头的添加一个自定义头部来实现的。</li>
<li>后台需要在每次请求中对token进行解析和判断，这个可以通过使用中间件实现（比如express中的<code>server.use</code>或者Laravel中的middleware），在中间件中对请求头中的token进行解码</li>
</ul>
<p>总之，这里的认证需要需要前后端的配合来实现</p>
<ul>
<li>前端负责保存token，并为每次请求附带上对应的token</li>
<li>后端负责生成和解析token,获取token内部信息，判断是否合法和过期，并决定对应操作</li>
</ul>
<h2 id="JSON-Web-Token"><a href="#JSON-Web-Token" class="headerlink" title="JSON Web Token"></a>JSON Web Token</h2><p>OK，上面大致了解了Token的作用和使用流程，接下来看一看一种实现Token的方式：<code>JSON Web Token</code>（简称JWT）。</p>
<h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>为了方便理解，从代码实现开始入手，这里用到的<a href="https://www.npmjs.com/package/jwt-simple" target="_blank" rel="external">jwt-simple</a>这个库。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> jwt = <span class="built_in">require</span>(<span class="string">"jwt-simple"</span>);</div><div class="line"><span class="comment">// 服务端密钥</span></div><div class="line"><span class="keyword">let</span> jwtSecret = <span class="string">"my_base_secret"</span>;</div><div class="line"></div><div class="line"><span class="keyword">let</span> Util =  &#123;</div><div class="line">    encode(params) &#123;</div><div class="line">        <span class="keyword">return</span> jwt.encode(params, jwtSecret);</div><div class="line">    &#125;,</div><div class="line">    verify(token) &#123;</div><div class="line">        <span class="keyword">let</span> data = jwt.decode(token, jwtSecret);</div><div class="line">        <span class="keyword">let</span> &#123; expires &#125; = data;</div><div class="line">        <span class="keyword">return</span> expires &gt; <span class="built_in">Date</span>.now();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 载荷</span></div><div class="line"><span class="keyword">let</span> data = &#123;</div><div class="line">    uid: <span class="number">100</span>,</div><div class="line">    name: <span class="string">'shymean'</span>,</div><div class="line">    expires: <span class="keyword">new</span> Data().getTime() + <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> token = Util.encode(data)</div><div class="line"><span class="comment">// eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1aWQiOjEwMCwibmFtZSI6InNoeW1lYW4ifQ.sbxKmBPjaQcXrfwBTxDkppXUa7ZJVvQ9ppw0Apnd_Jk</span></div><div class="line"><span class="built_in">console</span>.log(token)</div></pre></td></tr></table></figure>
<p>先不用管上面代码的具体含义，打印输出的token，通过两个<code>.</code>连接的三个子字符串组成的一个token。<br>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p>
<p><strong>载荷</strong><br>载荷指的是token保存的原始数据，即上面代码中的<code>data</code>变量，其中保存了一些信息，服务器通过解析JWT，然后可以获取到对应的信息。通过对data进行base64转码，就可以得到对应的子字符串。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> base64url = <span class="built_in">require</span>(<span class="string">'base64url'</span>)</div><div class="line"><span class="built_in">console</span>.log(base64url(<span class="built_in">JSON</span>.stringify(data)))</div></pre></td></tr></table></figure></p>
<p>得到的结果为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eyJ1aWQiOjEwMCwibmFtZSI6InNoeW1lYW4ifQ</div></pre></td></tr></table></figure></p>
<p>发现了什么？没错，就是上面的token中第二部分。base64可以通过解码还原成原始的数据，因此没有加密之说。</p>
<p><strong>头部</strong><br>头部用于描述jwt的基本信息，比如签名所使用的算法等。头部甚至可以是某种固定的形式，查看<code>jwt-simple</code>的源码可以发现，在其<code>encode</code>方法中<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!algorithm) &#123;</div><div class="line">    algorithm = <span class="string">'HS256'</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> header = &#123; <span class="attr">typ</span>: <span class="string">'JWT'</span>, <span class="attr">alg</span>: algorithm &#125;;</div></pre></td></tr></table></figure></p>
<p>然后同样对header进行base64编码，得到的结果为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</div></pre></td></tr></table></figure></p>
<p>就是上面的token中第一部分。同理，对header编码进行还原，可以获取JWT的基本信息。</p>
<p><strong>签名</strong><br>将头部和载荷通过<code>.</code>连接在一起，然后通过指定的<code>HS256</code>算法进行加密（关于HS256算法，可以移步<a href="http://8btc.com/article-136-1.html" target="_blank" rel="external">这里</a>），就可以得到加密后的内容，这个内容被称为签名。</p>
<p>在加密过程中，需要一个密钥，通过密钥和<code>HS256算法</code>，就可以得到加密后的签名。对应的加密可以通过<code>crypto</code>这个包来实现。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</div><div class="line"><span class="keyword">let</span> msg = <span class="string">'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1aWQiOjEwMCwibmFtZSI6InNoeW1lYW4ifQ'</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> base64str = crypto.createHmac(<span class="string">'sha256'</span>, jwtSecret).update(msg).digest(<span class="string">'base64'</span>);</div><div class="line"><span class="built_in">console</span>.log(base64str)</div><div class="line"></div><div class="line"><span class="comment">// sbxKmBPjaQcXrfwBTxDkppXUa7ZJVvQ9ppw0Apnd/Jk=</span></div></pre></td></tr></table></figure></p>
<p>最后将头部、载荷和签名通过<code>.</code>连接起来，就得到了上面的JWT。OK，现在我们理解了JWT的生成过程。</p>
<h3 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h3><p>可以看见，上面的载荷和头部都是简单的base64转码，只有签名是经过加密的，其中密钥保存在服务器上，不会泄露到客户端。<br>当服务器接收到JWT后，会根据头部的信息（加密类型和算法），<strong>再次</strong>对头部和载荷拼接的字符串进行加密，然后比较传回的签名和计算得到的签名，如果不一致，则表示数据已发生改变，token不可信任，否则，解析载荷的内容，获取token保存的信息。这就是为什么需要将头部、载荷和签名一起保存到JWT中的原因。</p>
<p>由于载荷采用的是base64编码，因此不能在载荷中放入敏感信息，比如用户密码等。但是由于签名的存在，在用户认证和权限判定等应用场景下还是可以使用的。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>这里我一直有一个疑问，如果恶意用户不修改头部和载荷，而是直接盗用了整个token，那么就可以完整地模拟权限用户了。这跟我们如何保存token有很大关系</p>
<ul>
<li>如果将token保存在本地（localStorage、sessionStorage），则需要注意XSS攻击，这样恶意脚本就可能获取到对应的token值。</li>
<li>如果将JWT保存在cookie中，然后设置为HttpOnly,则需要注意CSRF攻击，但是这样就需要后台去解析每次请求的Cookie字段了，一旦发生了CSRF攻击，则会绕过认证权限。</li>
</ul>
<p>因此这里就回到了前端的Web安全问题上了：XSS和CSRF。另外为在token中保存过期时间也是一个很有必要的事情，这样可以避免万一发生泄漏导致用户持久被攻击的问题。</p>
<p>过期问题随之而来的另外一个问题是在用户访问过程中token失效的处理措施，即后台更新过期时间策略。</p>
<p>关于JWT的具体使用场景，除了单页面身份认证，目前在项目中接触的并不是很多，有待进一步学习和整理。</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/JSON Web Token" class="article_tag">#JSON Web Token</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#业务场景"><span class="toc-number">1.</span> <span class="toc-text">业务场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#token"><span class="toc-number">1.1.</span> <span class="toc-text">token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#保存token"><span class="toc-number">1.2.</span> <span class="toc-text">保存token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流程实现"><span class="toc-number">1.3.</span> <span class="toc-text">流程实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-Web-Token"><span class="toc-number">2.</span> <span class="toc-text">JSON Web Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#组成"><span class="toc-number">2.1.</span> <span class="toc-text">组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#理解"><span class="toc-number">2.2.</span> <span class="toc-text">理解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意事项"><span class="toc-number">3.</span> <span class="toc-text">注意事项</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>