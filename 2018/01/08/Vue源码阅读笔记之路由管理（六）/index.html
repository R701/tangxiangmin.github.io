<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">Vue源码阅读笔记之路由管理（六）</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2018/1/8 9:20:51</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>我们可以通过<code>Vue</code>和<code>Vue-router</code>来构建单页面应用。在传统的web项目里面，往往存在多个页面映射不同的功能，而在单页面应用中，不同的页面对应的是不同的组件。</p>
<p>在之前的<a href="/article/%E5%8D%9A%E5%AE%A2%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93%E5%AE%9E%E8%B7%B5">博客同构渲染实践</a>和<a href="/article/history%E4%B8%8E%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E8%B7%AF%E7%94%B1">history与单页面应用路由</a>中，我尝试实现了单页面的路由管理，不过十分简陋，现在让我们来看看Vue-router的实现原理。</p>
<a id="more"></a>
<p>参考：</p>
<ul>
<li><a href="https://router.vuejs.org/zh-cn/essentials/getting-started.html" target="_blank" rel="external">官方文档</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>vue-router一个单独的项目，然后作为插件与vue进行绑定的，这赋予了开发者更大的选择自由。</p>
<p>跟分析Vue一样，克隆项目，安装依赖，然后从<code>package.json</code>的<code>npm run dev</code>脚本入手，该命令会通过express开启一个静态服务器，返回<code>examples</code>下相关的静态页面。<code>examples</code>目录下包含了相关的API使用方法，这对于源码分析很有帮助，基本上就不用我们自己写Demo了</p>
<p>在传统的后台MVC框架中，通过URL路由映射到对应的控制器方法，然后执行相关逻辑，最后展示视图。路由的声明又可以分为：</p>
<ul>
<li>显式声明，手动指定URL和对应的控制器方法，如Laravel、Express等</li>
<li>隐式声明，利用语言的自动加载机制，将URL映射到对应目录路径下的文件控制器方法，如ThinkPHP等</li>
</ul>
<p>那么，单页面应用中的路由该是什么样子的呢？首先，我们肯定需要关联路由和需要展示的视图；其次，我们需要模拟浏览器前进、后退等操作。</p>
<p>回想一下，Vue-router的使用方式十分简单，</p>
<ul>
<li>声明对应的页面组件，</li>
<li>通过组件构造<code>routes</code>数组，通过<code>routes</code>和其他配置参数实例化<code>router</code>对象</li>
<li>为Vue实例传入对应的<code>router</code>配置参数，在模板中通过<code>router-view</code>和<code>router-link</code>实现组件的跳转</li>
</ul>
<p>下面使用了examples中的一个例子，展示了一个基础的router对象实例化过程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /examples/basic/app.js</span></div><div class="line"><span class="comment">// 注册插件</span></div><div class="line">Vue.use(VueRouter)</div><div class="line"><span class="comment">// 定义组件</span></div><div class="line"><span class="keyword">const</span> Home = &#123; <span class="attr">template</span>: <span class="string">'&lt;div&gt;home&lt;/div&gt;'</span> &#125;</div><div class="line"><span class="keyword">const</span> Foo = &#123; <span class="attr">template</span>: <span class="string">'&lt;div&gt;foo&lt;/div&gt;'</span> &#125;</div><div class="line"><span class="keyword">const</span> Bar = &#123; <span class="attr">template</span>: <span class="string">'&lt;div&gt;bar&lt;/div&gt;'</span> &#125;</div><div class="line"><span class="comment">// 关联url和对应组件，组成构造参数，实例化router对象</span></div><div class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</div><div class="line">  mode: <span class="string">'history'</span>,</div><div class="line">  base: __dirname,</div><div class="line">  routes: [</div><div class="line">    &#123; <span class="attr">path</span>: <span class="string">'/'</span>, <span class="attr">component</span>: Home &#125;,</div><div class="line">    &#123; <span class="attr">path</span>: <span class="string">'/foo'</span>, <span class="attr">component</span>: Foo &#125;,</div><div class="line">    &#123; <span class="attr">path</span>: <span class="string">'/bar'</span>, <span class="attr">component</span>: Bar &#125;</div><div class="line">  ]</div><div class="line">&#125;)</div><div class="line"><span class="comment">// 将router作为配置参数，获得vm实例</span></div><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  router,</div><div class="line">  template: <span class="string">`</span></div><div class="line"><span class="string">    &lt;div id="app"&gt;</span></div><div class="line"><span class="string">      &lt;h1&gt;Basic&lt;/h1&gt;</span></div><div class="line"><span class="string">      &lt;ul&gt;</span></div><div class="line"><span class="string">        &lt;li&gt;&lt;router-link to="/"&gt;/&lt;/router-link&gt;&lt;/li&gt;</span></div><div class="line"><span class="string">        &lt;li&gt;&lt;router-link to="/foo"&gt;/foo&lt;/router-link&gt;&lt;/li&gt;</span></div><div class="line"><span class="string">        &lt;li&gt;&lt;router-link to="/bar"&gt;/bar&lt;/router-link&gt;&lt;/li&gt;</span></div><div class="line"><span class="string">        &lt;router-link tag="li" to="/bar" :event="['mousedown', 'touchstart']"&gt;</span></div><div class="line"><span class="string">          &lt;a&gt;/bar&lt;/a&gt;</span></div><div class="line"><span class="string">        &lt;/router-link&gt;</span></div><div class="line"><span class="string">      &lt;/ul&gt;</span></div><div class="line"><span class="string">      &lt;router-view class="view"&gt;&lt;/router-view&gt;</span></div><div class="line"><span class="string">    &lt;/div&gt;</span></div><div class="line"><span class="string">  `</span></div><div class="line">&#125;).$mount(<span class="string">'#app'</span>)</div></pre></td></tr></table></figure>
<p>通过上面这个流程，需要弄明白的一些问题有：</p>
<ul>
<li>VueRouter插件注册及<code>router-view</code>和<code>router-link</code>组件</li>
<li>配置参数<code>mode</code>和<code>routes</code>的处理</li>
</ul>
<ul>
<li>router对象的属性和方法</li>
</ul>
<p>按照上面demo程序执行的流程，我们一步一步进行分析。</p>
<h2 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h2><p>插件注册是在install方法中进行的，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/install.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">install</span> (<span class="params">Vue</span>) </span>&#123;</div><div class="line">   <span class="comment">// 全局混合，注册_router属性</span></div><div class="line">   Vue.mixin(&#123;</div><div class="line">    beforeCreate () &#123;</div><div class="line">      <span class="keyword">if</span> (isDef(<span class="keyword">this</span>.$options.router)) &#123;</div><div class="line">        <span class="keyword">this</span>._routerRoot = <span class="keyword">this</span></div><div class="line">        <span class="comment">// 设置this._router</span></div><div class="line">        <span class="keyword">this</span>._router = <span class="keyword">this</span>.$options.router</div><div class="line">        <span class="comment">// router初始化</span></div><div class="line">        <span class="keyword">this</span>._router.init(<span class="keyword">this</span>)</div><div class="line">        Vue.util.defineReactive(<span class="keyword">this</span>, <span class="string">'_route'</span>, <span class="keyword">this</span>._router.history.current)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">this</span>._routerRoot = (<span class="keyword">this</span>.$parent &amp;&amp; <span class="keyword">this</span>.$parent._routerRoot) || <span class="keyword">this</span></div><div class="line">      &#125;</div><div class="line">      registerInstance(<span class="keyword">this</span>, <span class="keyword">this</span>)</div><div class="line">    &#125;,</div><div class="line">    destroyed () &#123;</div><div class="line">      registerInstance(<span class="keyword">this</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$router'</span>, &#123;</div><div class="line">    get () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._router &#125;</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$route'</span>, &#123;</div><div class="line">    get () &#123; <span class="keyword">return</span> <span class="keyword">this</span>._routerRoot._route &#125;</div><div class="line">  &#125;)</div><div class="line">  <span class="comment">// 注册router-view和router-link全局组件</span></div><div class="line">  Vue.component(<span class="string">'RouterView'</span>, View)</div><div class="line">  Vue.component(<span class="string">'RouterLink'</span>, Link)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见在install主要就是为vm实例注入了_router对象，然后执行对应router的init方法。我们先来看看router对象的构造函数</p>
<h2 id="VueRouter构造函数"><a href="#VueRouter构造函数" class="headerlink" title="VueRouter构造函数"></a>VueRouter构造函数</h2><p>在前面的例子中，首先需要初始化路由构造参数，包括url和与之对应的组件，然后传入VueRouter构造函数实例一个router对象。我们来看看构造函数中是如何处理这些参数的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/index.js</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span> (options: RouterOptions = &#123;&#125;) &#123;</div><div class="line">    <span class="comment">// ...初始化相关属性</span></div><div class="line">    <span class="keyword">this</span>.options = options</div><div class="line">    <span class="comment">// 关联声明的路由</span></div><div class="line">    <span class="keyword">this</span>.matcher = createMatcher(options.routes || [], <span class="keyword">this</span>)</div><div class="line">		</div><div class="line">    <span class="keyword">let</span> mode = options.mode || <span class="string">'hash'</span></div><div class="line">    <span class="comment">// ...根据配置参数运行环境确定mode类型</span></div><div class="line">    <span class="keyword">this</span>.mode = mode</div><div class="line">    </div><div class="line">    <span class="comment">// 根据mode实例化对应的history对象</span></div><div class="line">    <span class="comment">// 我们上面选择的是history，因此暂时只需要了解HTML5History即可</span></div><div class="line">    <span class="keyword">switch</span> (mode) &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'history'</span>:</div><div class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> HTML5History(<span class="keyword">this</span>, options.base)</div><div class="line">        <span class="keyword">break</span></div><div class="line">      <span class="keyword">case</span> <span class="string">'hash'</span>:</div><div class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> HashHistory(<span class="keyword">this</span>, options.base, <span class="keyword">this</span>.fallback)</div><div class="line">        <span class="keyword">break</span></div><div class="line">      <span class="keyword">case</span> <span class="string">'abstract'</span>:</div><div class="line">        <span class="keyword">this</span>.history = <span class="keyword">new</span> AbstractHistory(<span class="keyword">this</span>, options.base)</div><div class="line">        <span class="keyword">break</span></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">          assert(<span class="literal">false</span>, <span class="string">`invalid mode: <span class="subst">$&#123;mode&#125;</span>`</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现插件的注册函数</span></div><div class="line">VueRouter.install = install</div><div class="line"><span class="comment">// 在浏览器中自动注册，这是Vue插件的基本实现形式</span></div><div class="line"><span class="keyword">if</span> (inBrowser &amp;&amp; <span class="built_in">window</span>.Vue) &#123;</div><div class="line">  <span class="built_in">window</span>.Vue.use(VueRouter)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>VueRouter构造函数内只做了两件事：初始化<code>this.matcher</code>和初始化<code>this.history</code>，我们暂时不要去深入这两个属性的作用，只需要知道他们在构造函数中被初始化即可。</p>
<h2 id="路由匹配matcher"><a href="#路由匹配matcher" class="headerlink" title="路由匹配matcher"></a>路由匹配matcher</h2><p>所谓路由，最基本的作用就是<strong>通过给定的url获得对应的视图内容</strong>，这就是<code>this.matcher</code>需要完成的工作。我们来看看<code>matcher</code>匹配器的初始化过程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/create-matcher.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createMatcher</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  routes: Array&lt;RouteConfig&gt;,</span></span></div><div class="line"><span class="function"><span class="params">  router: VueRouter</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Matcher</span> </span>&#123;</div><div class="line">  <span class="comment">// pathList是路由路径的数组，["", "/foo", "/bar"]</span></div><div class="line">  <span class="comment">// pathMap是一个以路径为键值的对象，对应每个路径相关的配置，这种形式被称为RouteRecord</span></div><div class="line">  <span class="comment">// nameMap是一个以路由名称为键值的对象，与pathMap对应路径指向的路由配置相同</span></div><div class="line">  <span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</div><div class="line">  </div><div class="line">  <span class="comment">// ...手动添加路由的接口，会更新pathList、pathMap和nameMap</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoutes</span> (<span class="params">routes</span>)</span>&#123;&#125;</div><div class="line">  <span class="comment">// 传入url匹配对应的路由对象，路由对象是根据路由记录初始化的</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">match</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">    raw: RawLocation,</span></span></div><div class="line"><span class="function"><span class="params">    currentRoute?: Route,</span></span></div><div class="line"><span class="function"><span class="params">    redirectedFrom?: Location</span></span></div><div class="line"><span class="function"><span class="params">  </span>): <span class="title">Route</span> </span>&#123;&#125;</div><div class="line">  <span class="comment">// ...一些其他辅助函数</span></div><div class="line">  <span class="comment">// mather对象上包含这两个方法</span></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    match,</div><div class="line">    addRoutes</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看见，<code>createMatcher</code>主要的作用就是通过<code>options.routes</code>，将对应的路由解析成字典，然后返回<code>match</code>和<code>addRoutes</code>两个闭包函数</p>
<h3 id="RouteRecord"><a href="#RouteRecord" class="headerlink" title="RouteRecord"></a>RouteRecord</h3><p>在match函数的返回值中提到了<strong>路由对象</strong>和<strong>路由记录</strong>的概念，路由对象我们都比较熟悉了，即<code>vm.$route</code>，那么路由记录是什么呢？我们先看看pathMap的形式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 转换前的route形式</span></div><div class="line">&#123; </div><div class="line">  path: <span class="string">'/foo'</span>, </div><div class="line">  component: Foo </div><div class="line">&#125;</div><div class="line">  </div><div class="line"><span class="comment">// pathMap的形式，这里只展示了部分路由</span></div><div class="line"><span class="comment">// 路径作为属性值，用于后面的路由匹配</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"/foo"</span>: &#123;</div><div class="line">    path: <span class="string">"/foo"</span>,</div><div class="line">    regex: &#123; <span class="attr">keys</span>: [] &#125;,</div><div class="line">    components: &#123; <span class="attr">default</span>: &#123; <span class="attr">template</span>: <span class="string">"&lt;div&gt;foo&lt;/div&gt;"</span> &#125; &#125;,</div><div class="line">    instances: &#123;&#125;,</div><div class="line">    meta: &#123;&#125;,</div><div class="line">    props: &#123;&#125;</div><div class="line">  &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见pathMap即以url为键名，一个保存路由相关信息的对象为键值的对象。将配置参数的route转换成<code>pathMap</code>形式的路由配置是在<code>addRouteRecord</code>中进行的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/create-route-map.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRouteRecord</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  pathList: Array&lt;string&gt;,</span></span></div><div class="line"><span class="function"><span class="params">  pathMap: Dictionary&lt;RouteRecord&gt;,</span></span></div><div class="line"><span class="function"><span class="params">  nameMap: Dictionary&lt;RouteRecord&gt;,</span></span></div><div class="line"><span class="function"><span class="params">  route: RouteCaddRouteRecordonfig, <span class="regexp">//</span> 这里就是配置参数中的route选项</span></span></div><div class="line"><span class="function"><span class="params">  parent?: RouteRecord,</span></span></div><div class="line"><span class="function"><span class="params">  matchAs?: string</span></span></div><div class="line"><span class="function"><span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">// 路由记录就是一个用来保存每个url的相关信息，包括正则、组件、命名等的对象</span></div><div class="line">  <span class="keyword">const</span> record: RouteRecord = &#123;</div><div class="line">    path: normalizedPath,</div><div class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</div><div class="line">    components: route.components || &#123; <span class="attr">default</span>: route.component &#125;,</div><div class="line">    instances: &#123;&#125;,</div><div class="line">    name,</div><div class="line">    parent,</div><div class="line">    matchAs,</div><div class="line">    redirect: route.redirect,</div><div class="line">    beforeEnter: route.beforeEnter,</div><div class="line">    meta: route.meta || &#123;&#125;,</div><div class="line">    props: route.props == <span class="literal">null</span></div><div class="line">      ? &#123;&#125;</div><div class="line">      : route.components</div><div class="line">        ? route.props</div><div class="line">        : &#123; <span class="attr">default</span>: route.props &#125;</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">  <span class="comment">// 递归为子路由生成RouteRecord </span></div><div class="line">  <span class="keyword">if</span> (route.children) &#123;</div><div class="line">    route.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;&#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 生成pathMap</span></div><div class="line">  <span class="keyword">if</span> (!pathMap[record.path]) &#123;</div><div class="line">    pathList.push(record.path)</div><div class="line">    pathMap[record.path] = record</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>route相关配置参数可以参考<a href="https://router.vuejs.org/zh-cn/api/options.html#routes" target="_blank" rel="external">官方文档</a>，上面展示了从配置参数到<code>RouteRecord</code>的转换过程。其中，<code>regex</code>值的生成使用了<a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="external">path-to-regexp</a>这个库（对于反向生成正则我一直十分好奇~）。</p>
<p>上面的过程也比较清晰，解析<code>options.routes</code>，然后生成对应URL的<code>RouteRecord</code>并保存在<code>pathMap</code>中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</div></pre></td></tr></table></figure>
<p>name选项并不是必须的，如果设置了该属性，则对应的路由会变成<a href="https://router.vuejs.org/zh-cn/essentials/named-routes.html" target="_blank" rel="external">命名路由</a>，所有的命名路由会解析到<code>nameMap</code>中，通常地，使用命名路由的查找效率要快一些，因为在match中对<code>pathMap</code>和<code>nameMap</code>有些差异。</p>
<h3 id="match"><a href="#match" class="headerlink" title="match"></a>match</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/create-matcher.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  raw: RawLocation, <span class="regexp">//</span> 目标url</span></span></div><div class="line"><span class="function"><span class="params">  currentRoute?: Route, <span class="regexp">//</span> 当前url对应的route对象</span></span></div><div class="line"><span class="function"><span class="params">  redirectedFrom?: Location <span class="regexp">//</span> 重定向</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</div><div class="line">  <span class="comment">// 从url中提取hash、path、query和name等信息</span></div><div class="line">  <span class="keyword">const</span> location = normalizeLocation(raw, currentRoute, <span class="literal">false</span>, router);</div><div class="line">  <span class="keyword">const</span> &#123; name &#125; = location;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (name) &#123;</div><div class="line">    <span class="comment">// 处理命名路由</span></div><div class="line">    <span class="keyword">const</span> record = nameMap[name];</div><div class="line">    <span class="keyword">const</span> paramNames = record.regex.keys</div><div class="line">      .filter(<span class="function"><span class="params">key</span> =&gt;</span> !key.optional)</div><div class="line">      .map(<span class="function"><span class="params">key</span> =&gt;</span> key.name);</div><div class="line">    <span class="keyword">if</span> (currentRoute &amp;&amp; <span class="keyword">typeof</span> currentRoute.params === <span class="string">"object"</span>) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> currentRoute.params) &#123;</div><div class="line">        <span class="keyword">if</span> (!(key <span class="keyword">in</span> location.params) &amp;&amp; paramNames.indexOf(key) &gt; <span class="number">-1</span>) &#123;</div><div class="line">          location.params[key] = currentRoute.params[key];</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (record) &#123;</div><div class="line">      location.path = fillParams(</div><div class="line">        record.path,</div><div class="line">        location.params,</div><div class="line">        <span class="string">`named route "<span class="subst">$&#123;name&#125;</span>"`</span></div><div class="line">      );</div><div class="line">      <span class="keyword">return</span> _createRoute(record, location, redirectedFrom);</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.path) &#123;</div><div class="line">    <span class="comment">// 处理非命名路由</span></div><div class="line">    location.params = &#123;&#125;;</div><div class="line">    <span class="comment">// 这里会遍历pathList，找到合适的record，因此命名路由的record查找效率更高</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pathList.length; i++) &#123;</div><div class="line">      <span class="keyword">const</span> path = pathList[i];</div><div class="line">      <span class="keyword">const</span> record = pathMap[path];</div><div class="line">      <span class="keyword">if</span> (matchRoute(record.regex, location.path, location.params)) &#123;</div><div class="line">        <span class="keyword">return</span> _createRoute(record, location, redirectedFrom);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// no match</span></div><div class="line">  <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在match中，主要通过当前URL确定对应的<code>RouteRecord</code>路由记录，然后调用<code>_createRoute</code>，并返回当前url对应的route对象。</p>
<h3 id="createRoute"><a href="#createRoute" class="headerlink" title="_createRoute"></a>_createRoute</h3><p>在<code>_createRoute</code>中会根据<code>RouteRecord</code>执行相关的路由操作，最后返回Route对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createRoute</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></div><div class="line"><span class="function"><span class="params">  location: Location,</span></span></div><div class="line"><span class="function"><span class="params">  redirectedFrom?: Location</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</div><div class="line">  <span class="comment">// 重定向</span></div><div class="line">  <span class="keyword">if</span> (record &amp;&amp; record.redirect) &#123;</div><div class="line">    <span class="keyword">return</span> redirect(record, redirectedFrom || location)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 别名</span></div><div class="line">  <span class="keyword">if</span> (record &amp;&amp; record.matchAs) &#123;</div><div class="line">    <span class="keyword">return</span> alias(record, location, record.matchAs)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 普通路由</span></div><div class="line">  <span class="keyword">return</span> createRoute(record, location, redirectedFrom, router)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里是重定向和别名路由的<a href="https://router.vuejs.org/zh-cn/essentials/redirect-and-alias.html" target="_blank" rel="external">文档传送门</a>。</p>
<p>现在我们知道了<code>this.mather.match</code>最终返回的就是<code>Route</code>对象，下面是一个Route对象包含的相关属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/util/route.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRoute</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  record: ?RouteRecord,</span></span></div><div class="line"><span class="function"><span class="params">  location: Location,</span></span></div><div class="line"><span class="function"><span class="params">  redirectedFrom?: ?Location,</span></span></div><div class="line"><span class="function"><span class="params">  router?: VueRouter</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Route</span> </span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="comment">// 终于看到了路由记录对象的真面目，每个url都对应一个路由记录，</span></div><div class="line">  <span class="comment">// 方便后续的根据url匹配对应的组件</span></div><div class="line">  <span class="keyword">const</span> route: Route = &#123;</div><div class="line">    name: location.name || (record &amp;&amp; record.name),</div><div class="line">    meta: (record &amp;&amp; record.meta) || &#123;&#125;,</div><div class="line">    path: location.path || <span class="string">'/'</span>,</div><div class="line">    hash: location.hash || <span class="string">''</span>,</div><div class="line">    query,</div><div class="line">    params: location.params || &#123;&#125;,</div><div class="line">    fullPath: getFullPath(location, stringifyQuery),</div><div class="line">    matched: record ? formatMatch(record) : []</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 禁止route对象改变</span></div><div class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.freeze(route)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，我们理清了从url生成对应route的过程。那么，match方法在何处调用呢？</p>
<p>我现在的猜想是：如果路由发生了改变，比如点击了一个连接，就需要根据目标url，匹配到对应的路由记录，重新生成新的route对象，然后加载对应的组件。</p>
<h2 id="路由初始化"><a href="#路由初始化" class="headerlink" title="路由初始化"></a>路由初始化</h2><p>在上面的install函数中，我们了解到VueRouter内部注册了一个全局混合，在<code>beforeCreate</code>时会调用<code>router.init</code>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">init (app: any <span class="comment">/* Vue component instance */</span>) &#123;</div><div class="line">    <span class="keyword">this</span>.apps.push(app)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.app) &#123;</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.app = app</div><div class="line">	<span class="comment">// 在构造函数中初始化history属性</span></div><div class="line">    <span class="keyword">const</span> history = <span class="keyword">this</span>.history</div><div class="line">	<span class="comment">// 在下面这两种模式存在进入的不是默认页的情形，因此需要调用transitionTo</span></div><div class="line">    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HTML5History) &#123;</div><div class="line">      history.transitionTo(history.getCurrentLocation())</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HashHistory) &#123;</div><div class="line">      <span class="comment">// 绑定hashChange事件，在下面的路由变化章节会解释</span></div><div class="line">      <span class="keyword">const</span> setupHashListener = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        history.setupListeners()</div><div class="line">      &#125;</div><div class="line">      history.transitionTo(</div><div class="line">        history.getCurrentLocation(),</div><div class="line">        setupHashListener,</div><div class="line">        setupHashListener</div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">  	<span class="comment">// listen中初始化history.cb = cb</span></div><div class="line">    history.listen(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</div><div class="line">      <span class="keyword">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">// 为vm实例注册_route属性</span></div><div class="line">        app._route = route</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看见，init函数内部主要调用了<code>history.transitionTo</code>和<code>history.listen</code>这两个方法，在上面的构造函数中我们知道了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.history = <span class="keyword">new</span> HTML5History(<span class="keyword">this</span>, options.base)</div></pre></td></tr></table></figure>
<p>接下来就去了解history对象。</p>
<h2 id="history对象"><a href="#history对象" class="headerlink" title="history对象"></a>history对象</h2><p>在VueRouter的构造函数中，我们发现，<code>router.history</code>实际上是根据<code>mode</code>实例化不同的History对象，三种history对象都继承自History基类。</p>
<p>我们知道<code>init</code>方法在<code>history</code>和<code>hash</code>模式下，会手动调用一次<code>transitionTo</code>，这是因为这两种模式（浏览器模式）存在进入的不是默认页的情形。</p>
<h3 id="transitionTo"><a href="#transitionTo" class="headerlink" title="transitionTo"></a>transitionTo</h3><p>在transitionTo中匹配目标rul的route对象，然后调用confirmTransition</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// src/history/base.js</span></div><div class="line">transitionTo (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">  	<span class="comment">// 匹配目标url的route对象</span></div><div class="line">    <span class="keyword">const</span> route = <span class="keyword">this</span>.router.match(location, <span class="keyword">this</span>.current)</div><div class="line">    <span class="comment">// 调用this.confirmTransition，执行路由转换</span></div><div class="line">    <span class="keyword">this</span>.confirmTransition(route, () =&gt; &#123;</div><div class="line">      <span class="comment">// ...跳转完成</span></div><div class="line">      <span class="keyword">this</span>.updateRoute(route)</div><div class="line">      onComplete &amp;&amp; onComplete(route)</div><div class="line">      <span class="keyword">this</span>.ensureURL()</div><div class="line">      <span class="comment">// fire ready cbs once</span></div><div class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.ready) &#123;</div><div class="line">        <span class="keyword">this</span>.ready = <span class="literal">true</span></div><div class="line">        <span class="keyword">this</span>.readyCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb(route) &#125;)</div><div class="line">      &#125;</div><div class="line">    &#125;, err =&gt; &#123;	</div><div class="line">      <span class="comment">// ...处理异常</span></div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="confirmTransition"><a href="#confirmTransition" class="headerlink" title="confirmTransition"></a>confirmTransition</h3><p>confirmTransition主要作用是处理链接跳转过程中相关逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">confirmTransition (route: Route, <span class="attr">onComplete</span>: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> current = <span class="keyword">this</span>.current</div><div class="line">    <span class="keyword">const</span> abort = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">      <span class="comment">// ... 实现abort函数</span></div><div class="line">	&#125;</div><div class="line">    </div><div class="line">    <span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt; = [].concat(</div><div class="line">      <span class="comment">// ...保存需要处理的逻辑队列,</span></div><div class="line">    )</div><div class="line">	</div><div class="line">    <span class="keyword">this</span>.pending = route</div><div class="line">    <span class="comment">// 迭代函数</span></div><div class="line">    <span class="keyword">const</span> iterator = <span class="function">(<span class="params">hook: NavigationGuard, next</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</div><div class="line">        <span class="keyword">return</span> abort()</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        hook(route, current, (to: any) =&gt; &#123;</div><div class="line">          	<span class="comment">// ...</span></div><div class="line">            next(to)</div><div class="line">        &#125;)</div><div class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        abort(e)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 依次执行队列</span></div><div class="line">    runQueue(queue, iterator, () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> postEnterCbs = []</div><div class="line">      <span class="keyword">const</span> isValid = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.current === route</div><div class="line">      <span class="comment">// 处理异步组件</span></div><div class="line">      <span class="keyword">const</span> enterGuards = extractEnterGuards(activated, postEnterCbs, isValid)</div><div class="line">      <span class="keyword">const</span> queue = enterGuards.concat(<span class="keyword">this</span>.router.resolveHooks)</div><div class="line">      runQueue(queue, iterator, () =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pending !== route) &#123;</div><div class="line">          <span class="keyword">return</span> abort()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.pending = <span class="literal">null</span></div><div class="line">        onComplete(route)</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.router.app) &#123;</div><div class="line">          <span class="keyword">this</span>.router.app.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            postEnterCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> &#123; cb() &#125;)</div><div class="line">          &#125;)</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div></pre></td></tr></table></figure>
<p>其中需要注意的是这个<code>runQueue</code>函数，他会依次将队列中的元素传入迭代器中执行，最后执行回调函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/util/async.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runQueue</span> (<span class="params">queue: Array&lt;?NavigationGuard&gt;, fn: Function, cb: Function</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> step = <span class="function"><span class="params">index</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (index &gt;= queue.length) &#123;</div><div class="line">      cb()</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">if</span> (queue[index]) &#123;</div><div class="line">        fn(queue[index], () =&gt; &#123;</div><div class="line">          step(index + <span class="number">1</span>)</div><div class="line">        &#125;)</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        step(index + <span class="number">1</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  step(<span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面整理了<code>transitionTo</code>的工作原理，其主要任务就是跳转到对应的url上，然后加载对应的视图，并触发相应的钩子函数。</p>
<h2 id="路由变化"><a href="#路由变化" class="headerlink" title="路由变化"></a>路由变化</h2><p>除了在init方法中会手动调用<code>transitionTo</code>之外，其他的调用应当是是通过注册url发生变化时的事件处理函数进行的，其中，</p>
<ul>
<li>点击链接会触发url的变化</li>
<li>浏览器后退也会触发url的变化</li>
<li>手动调用路由接口，也会触发url的变化</li>
</ul>
<h3 id="router-link"><a href="#router-link" class="headerlink" title="router-link"></a>router-link</h3><p>现在让我们来看看<code>router-link</code>组件的实现，组件的相关属性可参考<a href="https://router.vuejs.org/zh-cn/api/router-link.html" target="_blank" rel="external">官方文档</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  name: <span class="string">'RouterLink'</span>,</div><div class="line">  props: &#123;&#125;, <span class="comment">// ...相关属性</span></div><div class="line">  render (h: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> router = <span class="keyword">this</span>.$router</div><div class="line">    <span class="keyword">const</span> current = <span class="keyword">this</span>.$route</div><div class="line">    <span class="keyword">const</span> &#123; location, route, href &#125; = router.resolve(<span class="keyword">this</span>.to, current, <span class="keyword">this</span>.append)</div><div class="line">	<span class="comment">// ...导航状态类的处理</span></div><div class="line">    </div><div class="line">    <span class="comment">// 事件处理函数</span></div><div class="line">    <span class="keyword">const</span> handler = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</div><div class="line">      <span class="comment">// guardEvent函数用来判断当前路由跳转是否是有效的</span></div><div class="line">      <span class="keyword">if</span> (guardEvent(e)) &#123;</div><div class="line">        <span class="comment">// 替换路由或新增路由</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.replace) &#123;</div><div class="line">          router.replace(location)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          router.push(location)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="keyword">const</span> on = &#123; <span class="attr">click</span>: guardEvent &#125;</div><div class="line">    <span class="comment">// 相关的事件都会触发handler</span></div><div class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(<span class="keyword">this</span>.event)) &#123;</div><div class="line">      <span class="keyword">this</span>.event.forEach(<span class="function"><span class="params">e</span> =&gt;</span> &#123; on[e] = handler &#125;)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      on[<span class="keyword">this</span>.event] = handler</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> data: any = &#123;</div><div class="line">      class: classes</div><div class="line">    &#125;</div><div class="line">	<span class="comment">// ... 对渲染的标签进行处理</span></div><div class="line">    data.on = on</div><div class="line">    <span class="comment">// 执行渲染函数</span></div><div class="line">    <span class="keyword">return</span> h(<span class="keyword">this</span>.tag, data, <span class="keyword">this</span>.$slots.default)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见在点击（或者是其他指定的事件）router-link组件时，会调用<code>router.push</code>或<code>router.replace</code>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">push (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.history.push(location, onComplete, onAbort)</div><div class="line">&#125;</div><div class="line"></div><div class="line">replace (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.history.replace(location, onComplete, onAbort)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在不同的模式下，浏览器对应的事件是不一样的，这也是为什么会实例化不同的history的原因。接下来看看浏览器环境下相关事件与<code>transitionTo</code>是如何关联起来的</p>
<h3 id="HTML5History"><a href="#HTML5History" class="headerlink" title="HTML5History"></a>HTML5History</h3><p>在HTML5History的构造函数中，会监听<code>popstate</code>事件，关于HTML5提供的history API，可以参看<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API" target="_blank" rel="external">MDN文档</a>，其中</p>
<ul>
<li><code>push</code>是由<code>history.pushState</code>实现的</li>
<li><code>replace</code>是由<code>history.replaceState</code>实现的</li>
<li>浏览器后退由监听<code>popstate</code>事件实现的</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HTML5History</span> <span class="keyword">extends</span> <span class="title">History</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span> (router: Router, base: ?string) &#123;</div><div class="line">    <span class="comment">// 父类构造函数</span></div><div class="line">    <span class="keyword">super</span>(router, base)</div><div class="line">	</div><div class="line">    <span class="comment">// 滚动处理</span></div><div class="line">    <span class="keyword">const</span> expectScroll = router.options.scrollBehavior</div><div class="line">    <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (supportsScroll) &#123;</div><div class="line">      setupScroll()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> initLocation = getLocation(<span class="keyword">this</span>.base)</div><div class="line">    <span class="comment">// 监听浏览器的后退事件变化，执行transitionTo</span></div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'popstate'</span>, e =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> current = <span class="keyword">this</span>.current</div><div class="line">      <span class="keyword">const</span> location = getLocation(<span class="keyword">this</span>.base)</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.current === START &amp;&amp; location === initLocation) &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.transitionTo(location, route =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (supportsScroll) &#123;</div><div class="line">          handleScroll(router, route, current, <span class="literal">true</span>)</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 实现</span></div><div class="line">  push (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">this</span>.transitionTo(location, route =&gt; &#123;</div><div class="line">      pushState(cleanPath(<span class="keyword">this</span>.base + route.fullPath))</div><div class="line">      <span class="comment">// ...</span></div><div class="line">    &#125;, onAbort)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  replace (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">this</span>.transitionTo(location, route =&gt; &#123;</div><div class="line">      replaceState(cleanPath(<span class="keyword">this</span>.base + route.fullPath))</div><div class="line">      <span class="comment">// ...</span></div><div class="line">    &#125;, onAbort)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="HashHistory"><a href="#HashHistory" class="headerlink" title="HashHistory"></a>HashHistory</h3><p><code>hashChange</code>事件可查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/hashchange" target="_blank" rel="external">MDN文档</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">HashHistory</span> <span class="keyword">extends</span> <span class="title">History</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span> (router: Router, base: ?string, fallback: boolean) &#123;</div><div class="line">    <span class="keyword">super</span>(router, base)</div><div class="line">    <span class="comment">// check history fallback deeplinking</span></div><div class="line">    <span class="keyword">if</span> (fallback &amp;&amp; checkFallback(<span class="keyword">this</span>.base)) &#123;</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    ensureSlash()</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// setupListeners在router.init中才会被调用，防止过早触发</span></div><div class="line">  setupListeners () &#123;</div><div class="line">    <span class="keyword">const</span> router = <span class="keyword">this</span>.router</div><div class="line">    <span class="comment">// ... 处理滚动</span></div><div class="line">    <span class="comment">// 监听url变化，如果不支持popstate则会监听hashchange事件</span></div><div class="line">    <span class="built_in">window</span>.addEventListener(supportsPushState ? <span class="string">'popstate'</span> : <span class="string">'hashchange'</span>, () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> current = <span class="keyword">this</span>.current</div><div class="line">      <span class="keyword">if</span> (!ensureSlash()) &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">this</span>.transitionTo(getHash(), route =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (supportsScroll) &#123;</div><div class="line">          handleScroll(<span class="keyword">this</span>.router, route, current, <span class="literal">true</span>)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!supportsPushState) &#123;</div><div class="line">          replaceHash(route.fullPath)</div><div class="line">        &#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">  push (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">this</span>.transitionTo(location, route =&gt; &#123;</div><div class="line">      pushHash(route.fullPath)</div><div class="line">      <span class="comment">// ...</span></div><div class="line">    &#125;, onAbort)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  replace (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">this</span>.transitionTo(location, route =&gt; &#123;</div><div class="line">      replaceHash(route.fullPath)</div><div class="line">      <span class="comment">// ...</span></div><div class="line">    &#125;, onAbort)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK，现在我们知道了路由变化相关处理函数的注册过程。大体来说，就是根据选择的模式，底层调用浏览器不同的接口来实现的。</p>
<h2 id="视图变化"><a href="#视图变化" class="headerlink" title="视图变化"></a>视图变化</h2><p>当路由改变时，对应的router-view会加载相关的视图，我们来看看这部分是如何处理的</p>
<h3 id="router-view"><a href="#router-view" class="headerlink" title="router-view"></a>router-view</h3><p><code>router-view</code>相关的属性和使用方法可以参考<a href="https://router.vuejs.org/zh-cn/api/router-view.html" target="_blank" rel="external">官方文档</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  name: <span class="string">'RouterView'</span>,</div><div class="line">  functional: <span class="literal">true</span>,</div><div class="line">  props: &#123;</div><div class="line">    name: &#123;</div><div class="line">      type: <span class="built_in">String</span>,</div><div class="line">      <span class="keyword">default</span>: <span class="string">'default'</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  render (_, &#123; props, children, parent, data &#125;) &#123;</div><div class="line">    data.routerView = <span class="literal">true</span></div><div class="line">    <span class="keyword">const</span> h = parent.$createElement</div><div class="line">    <span class="keyword">const</span> name = props.name</div><div class="line">    <span class="comment">// 目标url的route对象</span></div><div class="line">    <span class="keyword">const</span> route = parent.$route</div><div class="line">    <span class="keyword">const</span> cache = parent._routerViewCache || (parent._routerViewCache = &#123;&#125;)</div><div class="line"></div><div class="line">    <span class="comment">// ...处理data.routerViewDepth</span></div><div class="line">    <span class="comment">// render previous view if the tree is inactive and kept-alive</span></div><div class="line">    <span class="keyword">if</span> (inactive) &#123;</div><div class="line">      <span class="keyword">return</span> h(cache[name], data, children)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> matched = route.matched[depth]</div><div class="line">    <span class="comment">// 找到name对应的组件</span></div><div class="line">    <span class="keyword">const</span> component = cache[name] = matched.components[name]</div><div class="line">    <span class="comment">// ...关联registration钩子</span></div><div class="line">    <span class="comment">// 注册data.hook.prepatch钩子函数</span></div><div class="line">    ;<span class="function">(<span class="params">data.hook || (data.hook = &#123;&#125;</span>)).<span class="params">prepatch</span> = (<span class="params">_, vnode</span>) =&gt;</span> &#123;</div><div class="line">      matched.instances[name] = vnode.componentInstance</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...处理props</span></div><div class="line">    <span class="comment">// 渲染组件</span></div><div class="line">    <span class="keyword">return</span> h(component, data, children)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看见，当route发生变化时，其内部会渲染目标url所匹配的路由记录保存的组件，这就是上面在router的配置函数传入，然后通过<code>addRouteRecord</code>生成的。</p>
<h3 id="link与view的关联"><a href="#link与view的关联" class="headerlink" title="link与view的关联"></a>link与view的关联</h3><p>上面提到了router-view的更新是根据route进行的，那么<code>vm.$route</code>的变化与路由的变化时如何关联起来的呢？回到前面，在<code>transitionTo</code>中向 <code>confirmTransition</code>传入了<code>onComplete</code>函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/history/base.js</span></div><div class="line">transitionTo (location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span>) &#123;</div><div class="line">    <span class="keyword">const</span> route = <span class="keyword">this</span>.router.match(location, <span class="keyword">this</span>.current)</div><div class="line">    <span class="keyword">this</span>.confirmTransition(route, () =&gt; &#123;</div><div class="line">       <span class="comment">// ...</span></div><div class="line">       <span class="keyword">this</span>.updateRoute(route)</div><div class="line">    &#125;)</div><div class="line">&#125;</div><div class="line">updateRoute (route: Route) &#123;</div><div class="line">  <span class="keyword">const</span> prev = <span class="keyword">this</span>.current</div><div class="line">  <span class="keyword">this</span>.current = route</div><div class="line">  <span class="comment">// cb是在router.init中调用listen注册</span></div><div class="line">  <span class="keyword">this</span>.cb &amp;&amp; <span class="keyword">this</span>.cb(route)</div><div class="line">  <span class="keyword">this</span>.router.afterHooks.forEach(<span class="function"><span class="params">hook</span> =&gt;</span> &#123;</div><div class="line">    hook &amp;&amp; hook(route, prev)</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line">listen (cb: <span class="built_in">Function</span>) &#123;</div><div class="line">  <span class="keyword">this</span>.cb = cb</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">history.listen(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</div><div class="line">  	app._route = route</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>可见，在执行<code>confirmTransition</code>完成路由的切换后，会调用<code>updateRoute</code>，然后修改<code>vm._route</code>，此时会重新渲染<code>router-view</code>组件。至此整个流程已整理完毕</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>上面整理了Vue-Router大致的运行流程和工作原理，了解了matcher的工作机制和不同模式下模拟的history实例，以及router-link和router-view的构造和关联。其中也有一些细节没有处理，比如滚动行为、avtiveClass、异步组件和<code>keep-alive</code>等特性。</p>
<p>现在回头看看，这一个多月基本都在学习Vue相关源码，还是有一些收获的，包括从Vue的使用到内部实现的一些理解，以及阅读源码的经验积累，还有对于Vue之外的关于编码的思考。其中我觉得，阅读源码最难的不是思考某个机制的实现，而是思考为什么作者需要这么处理。</p>
<p>也许某一天Vue就不再流行了，也许Vue-Router会被更好的框架替代，但我相信这一段时间的学习经历，对于自己而言还是很有帮助的，还有很长的路要走，自勉之。</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/Vue" class="article_tag">#Vue</a>
        
        <a href="/tags/源码分析" class="article_tag">#源码分析</a>
        
        <a href="/tags/Vue-router" class="article_tag">#Vue-router</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件安装"><span class="toc-number">2.</span> <span class="toc-text">插件安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VueRouter构造函数"><span class="toc-number">3.</span> <span class="toc-text">VueRouter构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由匹配matcher"><span class="toc-number">4.</span> <span class="toc-text">路由匹配matcher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RouteRecord"><span class="toc-number">4.1.</span> <span class="toc-text">RouteRecord</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match"><span class="toc-number">4.2.</span> <span class="toc-text">match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createRoute"><span class="toc-number">4.3.</span> <span class="toc-text">_createRoute</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由初始化"><span class="toc-number">5.</span> <span class="toc-text">路由初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#history对象"><span class="toc-number">6.</span> <span class="toc-text">history对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#transitionTo"><span class="toc-number">6.1.</span> <span class="toc-text">transitionTo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#confirmTransition"><span class="toc-number">6.2.</span> <span class="toc-text">confirmTransition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由变化"><span class="toc-number">7.</span> <span class="toc-text">路由变化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#router-link"><span class="toc-number">7.1.</span> <span class="toc-text">router-link</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTML5History"><span class="toc-number">7.2.</span> <span class="toc-text">HTML5History</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashHistory"><span class="toc-number">7.3.</span> <span class="toc-text">HashHistory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图变化"><span class="toc-number">8.</span> <span class="toc-text">视图变化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#router-view"><span class="toc-number">8.1.</span> <span class="toc-text">router-view</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#link与view的关联"><span class="toc-number">8.2.</span> <span class="toc-text">link与view的关联</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">9.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>