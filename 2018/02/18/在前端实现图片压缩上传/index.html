<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">在前端实现图片压缩上传</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2018/2/18 20:31:11</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近在整理之前实现的一些插件，刚好碰到了<strong>图片压缩上传</strong>这个问题，在移动端中，由于网速有限而手机照片往往比较大，导致图片上传比较缓慢，当时是通过HTML5中文件和二进制数据接口，配合Canvas实现在前端进行图片压缩的。这里稍作整理，权当复习。</p>
<a id="more"></a>
<p>整个项目放在<a href="https://github.com/web-plugins/minify-upload-img" target="_blank" rel="external">github</a>上面了。操作流程大致如下：</p>
<ul>
<li>获取到<code>input[type=file]</code>上传的图片文件</li>
<li>将图片文件绘制到canvas画布上</li>
<li>将canvas画布再转换成新的图片（此过程进行压缩），上传重新生成的图片</li>
</ul>
<p>这里需要先了解浏览器提供的相关接口。</p>
<h2 id="相关对象接口"><a href="#相关对象接口" class="headerlink" title="相关对象接口"></a>相关对象接口</h2><p>这里基本上都是补MDN文档上的基础知识了，只能说MDN太赞了！</p>
<h3 id="Blob对象"><a href="#Blob对象" class="headerlink" title="Blob对象"></a>Blob对象</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="external">Blob</a>是一种JavaScript对象类型，其作用是存储大量二进制数据<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回一个blob对象，array参数可以是</span></div><div class="line"><span class="comment">// ArrayBuffer</span></div><div class="line"><span class="comment">// ArrayBufferView</span></div><div class="line"><span class="comment">// Blob</span></div><div class="line"><span class="comment">// DOMString</span></div><div class="line"><span class="comment">// 其他类似对象的混合体</span></div><div class="line"></div><div class="line"><span class="comment">// 来自官方文档</span></div><div class="line"><span class="keyword">var</span> aFileParts = [<span class="string">'&lt;a id="a"&gt;&lt;b id="b"&gt;hey!&lt;/b&gt;&lt;/a&gt;'</span>]; <span class="comment">// an array consisting of a single DOMString</span></div><div class="line"><span class="keyword">var</span> oMyBlob = <span class="keyword">new</span> Blob(aFileParts, &#123;<span class="attr">type</span> : <span class="string">'text/html'</span>&#125;);</div><div class="line"><span class="built_in">console</span>.log(oMyBlob);</div></pre></td></tr></table></figure></p>
<p>常用的场景比如对较大文件进行分割（使用<code>blob.slice()</code>方法）。</p>
<h3 id="FileList"><a href="#FileList" class="headerlink" title="FileList"></a>FileList</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileList" target="_blank" rel="external">FileList</a>对象通常来自一个 input元素的files属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;input type=&quot;file&quot; id=&quot;imgFile&quot; multiple&gt;</div><div class="line"></div><div class="line">imgFile.onchange = function () &#123;</div><div class="line">    console.log(this.files); </div><div class="line">    // 选择三张图片，获得结果</div><div class="line">    // FileList &#123;0: File, 1: File, 2: File, length: 3&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看见<code>FileList</code>是一个类数组对象，且每个元素都是一个File对象</p>
<h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="external">File</a>对象包含文件的基本信息，以及文件内容的存取方法。此外，,File对象继承了Blob接口，因此也可以使用更多blob对象相关的方法。</p>
<p>我们这里需要处理的图像，就是一个file对象，file对象常用的属性有<code>name</code>（文件名）,<code>size</code>（文件尺寸）,<code>type</code>（MIME类型），至于相关的方法已经转移到了FileReader对象中了。</p>
<h3 id="FileReader"><a href="#FileReader" class="headerlink" title="FileReader"></a>FileReader</h3><p>HTML5允许JavaScript在用户上传文件之后在读取这些文件的内容<br><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader" target="_blank" rel="external">FileReader</a> 对象允许Web应用程序异步读取存储在用户计算机上的文件（或原始数据缓冲区）的内容。可以通过<code>FileReader()</code>构造函数来创建一个filereader对象。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以使用下面的方法来读取某个文件的内容</span></div><div class="line"><span class="comment">// 这些方法的参数均为file或blob对象</span></div><div class="line">fr.readAsArrayBuffer(file); <span class="comment">// ArrayBuffer对象表示的文件内容</span></div><div class="line">fr.readAsBinaryString(file); <span class="comment">// 原始二进制表示的文件内容</span></div><div class="line">fr.readAsDataURL(file); <span class="comment">// data: URL表示的文件内容</span></div><div class="line">fr.readAsText(file); <span class="comment">// 字符串表示的文件内容</span></div><div class="line"><span class="comment">// 此外需要注意这些方法都是异步的，当读取完毕内容存放在fr的result属性中</span></div><div class="line">fr.onloadend = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(fr.result);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 取消文件类容的读取</span></div><div class="line">fr.abort();</div><div class="line"><span class="comment">// 另外还有abort, load, loadstart, progress等事件</span></div></pre></td></tr></table></figure></p>
<h3 id="URL对象"><a href="#URL对象" class="headerlink" title="URL对象"></a>URL对象</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL" target="_blank" rel="external">URL</a>对象代表一个资源标识符对象，主要实现了URLUtils 中定义的属性，但是我们这里先只关注与文件相关的方面，也就是URL构造函数的两个静态方法:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回一个字符串，它的URL表示参数中的file或者blob对象，每次调用都会创建一个新的 URL 对象（即使参数相同）</span></div><div class="line"><span class="keyword">var</span> objectURL = URL.createObjectURL(blob);</div><div class="line"></div><div class="line"><span class="comment">//  创建的URL的生命周期和创建它的窗口中的 document 绑定，浏览器会在文档退出的时候自动释放它们，但是为了效率可以手动释放</span></div><div class="line">URL.revokeObjectURL(objectURL);</div></pre></td></tr></table></figure></p>
<h3 id="FromData"><a href="#FromData" class="headerlink" title="FromData"></a>FromData</h3><p><a href="(https://developer.mozilla.org/zh-CN/docs/Web/API/FormData/Using_FormData_Objects">FormData</a>)对象主要用来组装一组用 XMLHttpRequest发送请求的键/值对，可以更加灵活地发送Ajax请求。</p>
<p>可以使用<code>FormData</code>构造函数来获取一个fd对象：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 通过`FormData()`构造函数获取一个空对象</span></div><div class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> FormData();</div><div class="line"><span class="comment">// 也可以传入一个表单元素作为构造参数</span></div><div class="line"><span class="keyword">var</span> fd = <span class="keyword">new</span> FormData(formElm);</div></pre></td></tr></table></figure></p>
<p>fd对象中可以包含多种类型的数据，包括：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 普通key-value键值对</span></div><div class="line">fd.append(<span class="string">"user"</span>, <span class="string">"txm"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 文件对象</span></div><div class="line">formData.append(<span class="string">"userfile"</span>, fileInputElement.files[<span class="number">0</span>]);</div></pre></td></tr></table></figure></p>
<p>需要注意的是尽管调用了append方法增添数据，但是打印fd仍然显示问一个空对象。</p>
<h2 id="相关概念和思路"><a href="#相关概念和思路" class="headerlink" title="相关概念和思路"></a>相关概念和思路</h2><h3 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WindowBase64/Base64_encoding_and_decoding" target="_blank" rel="external">Base64</a>是网络上最常见的用于传输8Bit字节代码的编码方式之一，可用于在HTTP环境下传递较长的标识信息，Base64编码普遍应用于需要通过被设计为处理文本数据的媒介上储存和传输二进制数据而需要编码该二进制数据的场景（比如我们这里的异步传图片）。这样是为了保证数据的完整并且不用在传输过程中修改这些数据。<br>在网络传输中，将二进制文件(blob)保存为Base64编码的文本，这些文本可以内嵌在XML的标签中，因此二进制信息它可以随着XML文件被拷贝、下载而不用担心信息会缺失。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 对base64字符串进行解码，a表示ASCII，b表示base64</div><div class="line">atob()</div><div class="line">// 对blob对象进行编码</div><div class="line">btoa()</div></pre></td></tr></table></figure></p>
<h3 id="Canvas压缩图片"><a href="#Canvas压缩图片" class="headerlink" title="Canvas压缩图片"></a>Canvas压缩图片</h3><p>参考文档：</p>
<ul>
<li><a href="http://www.cnblogs.com/suntrain/p/6145827.html" target="_blank" rel="external">HTML5 CANVAS 实现图片压缩和裁切</a></li>
<li><a href="http://www.jb51.net/html5/503985.html" target="_blank" rel="external">解决canvas转base64/jpeg时透明区域变成黑色背景的方法</a></li>
</ul>
<p>主要的思路是使用<code>drawImage()</code>将上传图片绘制到画布上，再使用<code>toDataURL()</code>将画布另存为图片，通过指定质量达到压缩的效果。这个压缩效果还是十分明显的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">minify</span>(<span class="params">file, cb, quality</span>) </span>&#123;</div><div class="line">       quality = quality || <span class="number">0.5</span>;</div><div class="line">       <span class="comment">// 压缩图片</span></div><div class="line">       <span class="function"><span class="keyword">function</span> <span class="title">minifyImg</span>(<span class="params">source, quality</span>) </span>&#123;</div><div class="line">           <span class="keyword">var</span> w = source.width;</div><div class="line">           <span class="keyword">var</span> h = source.height;</div><div class="line"></div><div class="line">           <span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>);</div><div class="line">           canvas.width = w;</div><div class="line">           canvas.height = h;</div><div class="line"></div><div class="line">           <span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</div><div class="line">           <span class="comment">// 取出png转jpg的黑色背景</span></div><div class="line">           ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, w, h);</div><div class="line"></div><div class="line">           <span class="comment">// 将原图绘制在画布上，然后再将画布导出为图片，达到压缩的效果</span></div><div class="line">           ctx.drawImage(source, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">           <span class="keyword">return</span> canvas.toDataURL(<span class="string">"image/jpeg"</span>, quality);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       </div><div class="line">       <span class="keyword">var</span> imgURL = URL.createObjectURL(file);</div><div class="line"></div><div class="line">       <span class="keyword">var</span> source = <span class="keyword">new</span> Image();</div><div class="line">       source.src = imgURL;</div><div class="line">       source.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">           <span class="keyword">var</span> imgData = minifyImg(<span class="keyword">this</span>, quality);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (<span class="keyword">typeof</span> cb === <span class="string">"function"</span>) &#123;</div><div class="line">               cb(imgData);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<h2 id="图片异步上传"><a href="#图片异步上传" class="headerlink" title="图片异步上传"></a>图片异步上传</h2><p>既然获取到了压缩后的图片资源，上传过程就比较简单了。</p>
<p>将base64文本传递到后台，后台将文本还原成图片即可。下面是PHP的简单实现，相关接口只需要返回保存后的图片路径即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$imgData = $_REQUEST[<span class="string">'imgData'</span>];</div><div class="line">$base64 = explode(<span class="string">','</span>, $imgData)[<span class="number">1</span>];</div><div class="line">$img = base64_decode($base64);</div><div class="line">$url = <span class="string">'./test.jpg'</span>;</div><div class="line"><span class="keyword">if</span> (file_put_contents($url, $img)) &#123;</div><div class="line">    <span class="keyword">exit</span>(json_encode(<span class="keyword">array</span>(</div><div class="line">        url =&gt; $url</div><div class="line">    )));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
    </div>
    <footer class="article_ft">
        
        <a href="/tags/DOM" class="article_tag">#DOM</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#相关对象接口"><span class="toc-number">1.</span> <span class="toc-text">相关对象接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blob对象"><span class="toc-number">1.1.</span> <span class="toc-text">Blob对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FileList"><span class="toc-number">1.2.</span> <span class="toc-text">FileList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File"><span class="toc-number">1.3.</span> <span class="toc-text">File</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FileReader"><span class="toc-number">1.4.</span> <span class="toc-text">FileReader</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URL对象"><span class="toc-number">1.5.</span> <span class="toc-text">URL对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FromData"><span class="toc-number">1.6.</span> <span class="toc-text">FromData</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关概念和思路"><span class="toc-number">2.</span> <span class="toc-text">相关概念和思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#base64编码"><span class="toc-number">2.1.</span> <span class="toc-text">base64编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canvas压缩图片"><span class="toc-number">2.2.</span> <span class="toc-text">Canvas压缩图片</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图片异步上传"><span class="toc-number">3.</span> <span class="toc-text">图片异步上传</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>