<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">初识数据库约束</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/8/27 17:00:32</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/数据库" class="hover-highlight">数据库</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近实现了一个需求：后台解析上传的Excel数据并将其保存到数据库。由于数据比较敏感，且部分数据是由人工处理的，因此必须确保数据的准确性和唯一性，即在某几个字段相同的情况下其的数据必须唯一 。之前只是简单了解了数据库的约束，这里有必要深入一下。</p>
<a id="more"></a>
<p>实际上，在平常的使用中已经不知不觉接触到立刻</p>
<p>参考资料：</p>
<ul>
<li><a href="http://www.cnblogs.com/netsql/archive/2010/05/06/1729162.html" target="_blank" rel="external">数据库的约束简介</a></li>
<li><a href="http://www.cnblogs.com/shiy/p/6094218.html" target="_blank" rel="external">MySQL约束</a></li>
<li><a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A6%E6%9D%9F" target="_blank" rel="external">数据完整性约束</a></li>
</ul>
<h2 id="约束简介"><a href="#约束简介" class="headerlink" title="约束简介"></a>约束简介</h2><p>先来看看百科上给出的定义</p>
<blockquote>
<p>数据完整性约束指的是为了防止不符合规范的数据进入数据库，在用户对数据进行插入、修改、删除等操作时，DBMS自动按照一定的约束条件对数据进行监测，使不符合规范的数据不能进入数据库，以确保数据库中存储的数据正确、有效、相容。</p>
</blockquote>
<p>我的理解就是：为了保证数据的<strong>正确性</strong>，在设计表结构的时候，预先指定一些<strong>规则</strong>，这些规则将在数据发生改变时被触发，从而检测数据是否符合预期设计并决定该操作是否成功。</p>
<h3 id="正确性"><a href="#正确性" class="headerlink" title="正确性"></a>正确性</h3><p>数据的正确性表现为</p>
<ul>
<li>从数据内容来看，正确性表现为数据是否符合字段的的数据类型、精度等</li>
<li>从行关系来看，每行数据在表中都是唯一的记录，即可以通过某个特定的条件查询而不会产生歧义</li>
<li>从表关系来看，两个表的主键和外键的数据应保证一致，防止无意义的数据或联表查询错误</li>
</ul>
<h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3><p>查询相关资料得知，数据完整性约束的类型可以分为三种类型：</p>
<ul>
<li>与表有关的约束</li>
<li>域约束</li>
<li>断言</li>
</ul>
<p>这里要学习的是<strong>与表有关的约束</strong>，表约束指的是在表的数据列上强制执行的规则，实际上表约束中的某些规则并不陌生，比如<code>not null</code>，<code>primary key</code>等，下面一一道来。</p>
<h2 id="约束类型"><a href="#约束类型" class="headerlink" title="约束类型"></a>约束类型</h2><p>下面使用MYSQL进行相关测试，对应版本为<code>5.7.14</code>。</p>
<p>设置约束可以使用关键字，如<code>not null</code>，<code>primary key</code>等，也可以使用<code>CONSTRAINT</code>语法来指定。</p>
<table>
<thead>
<tr>
<th>约束</th>
<th>关键字</th>
<th>语句</th>
</tr>
</thead>
<tbody>
<tr>
<td>非空</td>
<td>username varchar(30) not null</td>
<td></td>
</tr>
<tr>
<td>主键</td>
<td>id INT PRIMARY KEY</td>
<td>CONSTRAINT pk_test_pk PRIMARY KEY(id)</td>
</tr>
<tr>
<td>唯一</td>
<td></td>
<td>CONSTRAINT uk_name_pwd UNIQUE(username, password)</td>
</tr>
<tr>
<td>外键</td>
<td>uid INT REFERENCES test_foreign(id)</td>
<td>CONSTRAINT fk_uid FOREIGN KEY(uid) REFERENCES test_foreign(id)</td>
</tr>
<tr>
<td>检查</td>
<td></td>
<td>CONSTRAINT age_more_2 CHECK(age &gt; 2)</td>
</tr>
</tbody>
</table>
<h3 id="非空约束"><a href="#非空约束" class="headerlink" title="非空约束"></a>非空约束</h3><p>非空约束用来确保某个字段必须有值，使用<code>NOT NULL</code>进行约束声明</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_null(</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	sex TINYINT</div><div class="line">);</div></pre></td></tr></table></figure>
<p>上面语句指定了<code>id</code>与<code>username</code>字段非空，现在如果插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> (username, sex) <span class="keyword">VALUES</span>(<span class="string">'txm'</span>, <span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>则控制台会报错</p>
<blockquote>
<p>Field ‘id’ doesn’t have a default value</p>
</blockquote>
<p>也就是说，有非空约束的字段，要么通过<code>DEFAULT</code>关键字指定默认值，要么就必须在修改该列时确保其数据非空。实际上<code>DEFAULT</code>也是一种约束，被称为<strong>默认约束</strong>。</p>
<p>在大多数MySQL建表规范中，建议将字段均设置为<code>not null</code>。在MySQL中，空字符串是一个有效的值，是占据存储空间的；而NULL不占用任何空间（使用<code>IS NLL</code>进行判断），含有空值的列很难进行查询优化，这里是相关文章的传送门：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000000646755" target="_blank" rel="external">为什么mysql字段要设置为not null?</a></li>
<li><a href="http://blog.csdn.net/kobejayandy/article/details/18184259" target="_blank" rel="external">MySQL建议列属性尽量为NOT NULL</a></li>
</ul>
<h3 id="唯一约束"><a href="#唯一约束" class="headerlink" title="唯一约束"></a>唯一约束</h3><p>前面的引子中提到的“保证数据唯一“，用到的就是唯一约束，唯一约束用来指定某个列或某几个列的组合其数据不能重复，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_unique(</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">30</span>),</div><div class="line">	<span class="keyword">password</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>),</div><div class="line">	<span class="keyword">CONSTRAINT</span> uk_name_pwd <span class="keyword">UNIQUE</span>(username, <span class="keyword">password</span>)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>这里定义了<code>username</code>和<code>password</code>的组合数据不能完全相同，即保证不会出现用户名和密码组合完全相同的情况。</p>
<p>我们先插入一条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_unique(<span class="keyword">id</span>, username, <span class="keyword">PASSWORD</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'txm'</span>, <span class="string">'123'</span>)</div></pre></td></tr></table></figure>
<p>然后再插入一条数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_unique(<span class="keyword">id</span>, username, <span class="keyword">PASSWORD</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'txm'</span>, <span class="string">'123'</span>)</div></pre></td></tr></table></figure>
<p>则控制台会报错</p>
<blockquote>
<p>Duplicate entry ‘txm-123’ for key ‘uk_name_pwd’</p>
</blockquote>
<p><code>&#39;txm-123</code>感觉其内部实现就是把多个字段的数据按顺序组合，然后判断其值是否相等，最后决定插入操作是否成功。</p>
<h3 id="主键约束"><a href="#主键约束" class="headerlink" title="主键约束"></a>主键约束</h3><p>主键应该是最熟悉的一种约束了，它相当于”非空约束 + 唯一约束”的组合。主键能够唯一区分表中的每个行，在MySQL中任何列都何以作为主键，只要他们满足：</p>
<ul>
<li>任意两行都不具有相同的主键值（不允许重复值）</li>
<li>每行必须有一个主键值，且该值不能为NULL（不允许空值）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_pk(</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</div><div class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">)</div></pre></td></tr></table></figure>
<p>需要注意的是，可以将一列或者多列的组合设置为主键，但是一张表最多只能设置一个主键（也可以不设置主键），否则会报下列错误</p>
<blockquote>
<p>Multiple primary key defined</p>
</blockquote>
<h3 id="检查约束"><a href="#检查约束" class="headerlink" title="检查约束"></a>检查约束</h3><p>检查约束可以通过为字段设置一个表达式来检测数据是否符合预期，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_check(</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</div><div class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	age <span class="built_in">INT</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	<span class="keyword">CONSTRAINT</span> age_more_2 <span class="keyword">CHECK</span>(age &gt; <span class="number">2</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p>尽管上述约束不会报错，但是为age字段设置为1也可以通过检测，因此检查约束在MySQL中是无效的。查到的一个解释是</p>
<blockquote>
<p>从规范中接受这些子句但又忽略子句的原因是为了提高兼容性，以便更容易地从其它SQL服务器中导入代码，并运行应用程序，创建带参考数据的表</p>
</blockquote>
<p>因此针对坚持约束，只能从前端解决这些问题了（这里的前端是PHP等服务端，不是Web前端，哈哈）。</p>
<h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><p>关系型数据库设计的基础是：<strong>相同的数据出现多次绝对不是一件好事情</strong>。于是一般的做法是将数据拆分成多张表，通过<strong>外键</strong>的形式将他们关联起来。</p>
<blockquote>
<p>外键为某个表中的一列，它包含了另一个表的主键值，定义了两个表之间的关系</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 主表</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_foreign ( </div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>, </div><div class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> </div><div class="line">); </div><div class="line"><span class="comment">-- 从表</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_foreign_sub (</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</div><div class="line">	uid <span class="built_in">INT</span>,</div><div class="line">	money <span class="built_in">FLOAT</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>外键在联结查询中的使用这里就不谈了，那么什么是外键约束呢？</p>
<p>上面的从表中，从表中的<code>uid</code>字段即为主表中的<code>id</code>主键，但是这只是我们所认为的，在没有任何约束的情况下，数据库只是把他们当作普通的字段而已。试想我们向从表中插入了一条uid在主表中并不存在的数据，或者从主表中删除了某条记录导致从表中的uid无法查询，数据的正确性和完整性就无法保证了。</p>
<p>因此，我们需要将从表的外键和主表的主键关联起来，需要注意的是：<strong>主表和从表必须使用<code>InnoDB</code>引擎，<code>MyISAM</code>暂不支持外键约束</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_foreign_sub_2 (</div><div class="line">	<span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span>,</div><div class="line">	money <span class="built_in">FLOAT</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	uid <span class="built_in">INT</span>,</div><div class="line">	<span class="keyword">CONSTRAINT</span> fk_uid FOREIGN <span class="keyword">KEY</span>(uid) <span class="keyword">REFERENCES</span> test_foreign(<span class="keyword">id</span>) <span class="comment">--关联外键约束</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>前面提到了从主表中删除某条记录导致从表中的数据残留的问题，也可以通过外键约束来进行处理，即：在删除主表数据时，将从表数据也删除（或者设置为null），这是通过<code>ON DELETE</code>子句来实现的：</p>
<ul>
<li><code>CASCADE</code>,将从表数据也删除</li>
<li><code>SET NULL</code>将从表数据置为NULL</li>
<li><code>SET DEFAULT</code>，将从表数据设置为默认值</li>
<li><code>NO ACTION</code>，如果删除主表数据影响数据完整性，该操作将被禁止</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE test_foreign_sub_4 (</div><div class="line">	id INT PRIMARY KEY,</div><div class="line">	money FLOAT(10, 2) NOT NULL,</div><div class="line">	uid INT REFERENCES test_foreign(id) ON DELETE CASCADE</div><div class="line">)</div></pre></td></tr></table></figure>
<p>关于外键更多资料，可以查看：</p>
<ul>
<li><p><a href="http://www.cnblogs.com/bhlsheji/p/5332910.html" target="_blank" rel="external">MySQL中的外键是什么、有什么作用</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/musings/p/5913269.html" target="_blank" rel="external">Mysql外键约束设置使用方法</a></p>
</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这里只是总结了约束的一些概念，每种约束都有自己的用处。毫无疑问，使用约束之后，在修改数据的时候效率将会降低，但是得到的是数据正确性的提升，两者如何取舍需要进一步的学习。</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/MySQL" class="article_tag">#MySQL</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#约束简介"><span class="toc-number">1.</span> <span class="toc-text">约束简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正确性"><span class="toc-number">1.1.</span> <span class="toc-text">正确性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#规则"><span class="toc-number">1.2.</span> <span class="toc-text">规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#约束类型"><span class="toc-number">2.</span> <span class="toc-text">约束类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#非空约束"><span class="toc-number">2.1.</span> <span class="toc-text">非空约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#唯一约束"><span class="toc-number">2.2.</span> <span class="toc-text">唯一约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主键约束"><span class="toc-number">2.3.</span> <span class="toc-text">主键约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检查约束"><span class="toc-number">2.4.</span> <span class="toc-text">检查约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#外键约束"><span class="toc-number">2.5.</span> <span class="toc-text">外键约束</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">3.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>