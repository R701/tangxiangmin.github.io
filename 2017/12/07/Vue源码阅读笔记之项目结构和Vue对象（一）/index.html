<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
            <a class="nav_item" href="/test">Test</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">Vue源码阅读笔记之项目结构和Vue对象（一）</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/12/7 8:35:12</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p><code>vue</code>是我接触到的第一个MVVM框架，在工作中使用也比较频繁。早前曾尝试过阅读源码，奈何功力不够，草草了事，收获的东西有限，现在决定重新阅读Vue及相关技术栈(<code>vue-router</code>，<code>vuex</code>，<code>axios</code>等)源码，并整理相关知识。除了加深对于Vue的理解之外，还希望能够提升阅读源码的能力~</p>
<a id="more"></a>
<p>此次阅读的是vue最新的版本是<code>2.5.9</code>，后续版本变更可能会导致摘取的相关代码不一致~</p>
<p>参考：</p>
<ul>
<li><a href="https://cn.vuejs.org/v2/guide/" target="_blank" rel="external">官方文档</a>和<a href="https://github.com/vuejs/vue" target="_blank" rel="external">官方源码</a></li>
<li><a href="http://hcysun.me/2017/03/03/Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" target="_blank" rel="external">Vue源码学习</a>，这篇教程十分精彩</li>
</ul>
<h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><h3 id="平台差异"><a href="#平台差异" class="headerlink" title="平台差异"></a>平台差异</h3><p>由于Vue有多个运行平台，包括浏览器、node环境(SSR渲染)、Weex等，因此在源码中有一些平台差异性的代码。这次阅读源码的首要目的是浏览器端的代码，然后了解SSR渲染的原理和实现。</p>
<h3 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h3><p><strong>运行开发者模式</strong></p>
<p>为了进行调试我们需要将项目跑起来，整个环境的搭建十分简单</p>
<ul>
<li>把项目fork并克隆到本地，</li>
<li><code>npm i</code>然后<code>npm run dev</code>进入开发者模式，会监听文件的变化然后修改<code>/dist/</code>目录下的输出</li>
<li>新建一个<code>index.html</code>文件然后引入源码文件<code>/dist/vue.js</code></li>
<li>修改<code>/src/core/index.js</code>代码，添加一个<code>console.log(&quot;hello vue&quot;)</code></li>
<li>即可在浏览器控制台发现对应的输出，OK，现在可以愉快的进行阅读和调试了</li>
</ul>
<p>打开<code>package.json</code>文件，可以发现还有一些其他的开发指令，针对不同的开发者模式，诸如<code>dev:weex</code>等,这里暂时先不研究了。</p>
<p>PS：由于加载的是编译后的文件，因此无法在源文件中使用webstrom与chrome的断点工具进行调试，我采用的是手动添加<code>debugger</code>关键字断点。还希望有其他好的调试方法的朋友指点一下。</p>
<p><strong>flow</strong></p>
<p><a href="https://flow.org/" target="_blank" rel="external">flow官网</a>上的介绍是</p>
<blockquote>
<p>Flow is a static type checker for your JavaScript code. It does a lot of work to make you more productive. Making you code faster, smarter, more confidently, and to a bigger scale.</p>
</blockquote>
<p>由于源码中均使用flow作为类型检测，因此需要掌握一些基本语法，避免阅读障碍。</p>
<p>知乎上尤大亲自回答了<a href="https://www.zhihu.com/question/46397274" target="_blank" rel="external">这个问题</a>。貌似vue最近添加了对于<code>TypeScript</code>的支持~</p>
<p><strong>rollup</strong></p>
<p>rollup是一个JS模块打包工具，与webpack类似。</p>
<p>这里倒是不需要深入其工作原理，这里是<a href="https://rollupjs.org/zh" target="_blank" rel="external">rollup.js教程</a>传送门。</p>
<p><strong>babel和eslint</strong></p>
<p>在修改源码时记得遵循eslint规范，或者直接修改其配置~</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>记得大佬跟我说过，阅读源码时先理解作者的设计思想，了解整体结构，切勿钻进某个细节实现。</p>
<p>从<code>npm run dev</code>这个命令入手，我们一步一步追踪代码的编译过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;dev&quot;: &quot;rollup -w -c build/config.js --environment TARGET:web-full-dev&quot;,</div></pre></td></tr></table></figure>
<p>找到<code>build/config.js</code>，这是rollup的配置文件，对应的环境变量为<code>TARGET:web-full-dev</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">'web-runtime-dev'</span>: &#123;</div><div class="line">    entry: resolve(<span class="string">'web/entry-runtime.js'</span>),</div><div class="line">    dest: resolve(<span class="string">'dist/vue.runtime.js'</span>),</div><div class="line">    format: <span class="string">'umd'</span>,</div><div class="line">    env: <span class="string">'development'</span>,</div><div class="line">    banner</div><div class="line">  &#125;,</div></pre></td></tr></table></figure>
<p>这里<code>resolve</code>函数为路径设置了别名，找到了项目的入口文件<code>web/entry-runtime-with-compiler.js</code>，实际上是<code>/src/platforms/web/entry-runtime-with-compiler.js</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import Vue from &apos;./runtime/index&apos;</div></pre></td></tr></table></figure>
<p>一步一步追踪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import Vue from &apos;core/index&apos;</div></pre></td></tr></table></figure>
<p>同理，这里的路径别名是<code>/src/core/index.js</code>,距离真相越来越近了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import Vue from &apos;./instance/index&apos;</div></pre></td></tr></table></figure>
<p>最后，我们终于找到了Vue构造函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>._init(options)</div><div class="line">&#125;</div><div class="line"></div><div class="line">initMixin(Vue)</div><div class="line">stateMixin(Vue)</div><div class="line">eventsMixin(Vue)</div><div class="line">lifecycleMixin(Vue)</div><div class="line">renderMixin(Vue)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</div></pre></td></tr></table></figure>
<p>下面几个方法的作用是为<code>Vue.prototype</code>上添加原型属性和方法，最后导出了Vue构造函数，在构造函数内部调用了<code>Vue.prototype._init</code>方法。</p>
<p>现在回头看看上面几个文件的作用</p>
<ul>
<li><code>/src/core/instance/index.js</code>，向<code>Vue.prototype</code>添加属性和方法</li>
<li><code>/src/core/index.js</code>，通过<code>initGlobalAPI(Vue)</code>向Vue添加静态属性和方法</li>
<li><code>/src/platforms/web/runtime/index.js</code>，添加了一些平台的特性方法及<code>Vue.config</code></li>
<li><code>/src/platforms/web/entry-runtime-with-compiler.js</code>，覆盖了<code>Vue.prototype.$mount</code>和<code>Vue.compile</code></li>
</ul>
<p>至此，我们了解了项目的大致结构，通过模块文件组织整个项目，Vue的源码是十分整洁的。接下来再逐步深入每个模块的细节，首先来看看Vue实例对象的属性和方法是如何挂载。</p>
<h2 id="Vue原型及对象"><a href="#Vue原型及对象" class="headerlink" title="Vue原型及对象"></a>Vue原型及对象</h2><p>有趣的是Vue是通过将构造函数作为参数传入不同模块函数，从而实现在原型上挂载属性和方法。</p>
<p>对着前面的路径图，发掘Vue原型上的属性和方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/index.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</div><div class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)</div><div class="line">  ) &#123;</div><div class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">this</span>._init(options)</div><div class="line">&#125;</div><div class="line"></div><div class="line">initMixin(Vue)</div><div class="line"><span class="comment">// Vue.prototype._init</span></div><div class="line"></div><div class="line">stateMixin(Vue)</div><div class="line"><span class="comment">// Object.defineProperty(Vue.prototype, '$data', dataDef)</span></div><div class="line"><span class="comment">// Object.defineProperty(Vue.prototype, '$props', propsDef)</span></div><div class="line"><span class="comment">// Vue.prototype.$set</span></div><div class="line"><span class="comment">// Vue.prototype.$delete</span></div><div class="line"><span class="comment">// Vue.prototype.$watch</span></div><div class="line"></div><div class="line">eventsMixin(Vue)</div><div class="line"><span class="comment">// Vue.prototype.$on</span></div><div class="line"><span class="comment">// Vue.prototype.$once</span></div><div class="line"><span class="comment">// Vue.prototype.$off</span></div><div class="line"><span class="comment">// Vue.prototype.$emit</span></div><div class="line"></div><div class="line">lifecycleMixin(Vue)</div><div class="line"><span class="comment">// Vue.prototype._update</span></div><div class="line"><span class="comment">// Vue.prototype.$forceUpdate</span></div><div class="line"><span class="comment">// Vue.prototype.$destroy</span></div><div class="line"></div><div class="line">renderMixin(Vue)</div><div class="line"><span class="comment">// Vue.prototype.$nextTick</span></div><div class="line"><span class="comment">// Vue.prototype._render</span></div></pre></td></tr></table></figure>
<p>然后是Vue构造函数的全局属性和方法，这是通过<code>initGlobalAPI(Vue)</code>注册的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/global-api/index.js</span></div><div class="line"></div><div class="line"><span class="built_in">Object</span>.defineProperty(Vue, <span class="string">'config'</span>, configDef)</div><div class="line">Vue.util</div><div class="line">Vue.set</div><div class="line">Vue.delete</div><div class="line">Vue.nextTick</div><div class="line">Vue.options</div><div class="line"></div><div class="line"><span class="comment">// ASSET_TYPES = [</span></div><div class="line"><span class="comment">//     'component',</span></div><div class="line"><span class="comment">//     'directive',</span></div><div class="line"><span class="comment">//     'filter'</span></div><div class="line"><span class="comment">// ]</span></div><div class="line">ASSET_TYPES.forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</div><div class="line">	Vue.options[type + <span class="string">'s'</span>] = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">Vue.options._base</div><div class="line">extend(Vue.options.components, builtInComponents)</div><div class="line"></div><div class="line">initUse(Vue)</div><div class="line"><span class="comment">// Vue.use</span></div><div class="line">initMixin(Vue)</div><div class="line"><span class="comment">// Vue.mixin</span></div><div class="line">initExtend(Vue)</div><div class="line"><span class="comment">// Vue.extend</span></div><div class="line">initAssetRegisters(Vue)</div><div class="line"><span class="comment">// Vue[ASSET_TYPES[i]] 对应Vue.component, Vue.directive, Vue.filter</span></div></pre></td></tr></table></figure>
<p>然后根据不同的运行环境，添加一些具有平台特性的属性的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/platforms/web/runtime/index.js</span></div><div class="line">Vue.config.mustUseProp</div><div class="line">Vue.config.isReservedTag</div><div class="line">Vue.config.isReservedAttr</div><div class="line">Vue.config.getTagNamespace</div><div class="line">Vue.config.isUnknownElement</div><div class="line"></div><div class="line">extend(Vue.options.directives, platformDirectives)</div><div class="line">extend(Vue.options.components, platformComponents)</div><div class="line"></div><div class="line">Vue.prototype.__patch__</div><div class="line">Vue.prototype.$mount</div></pre></td></tr></table></figure>
<p>快到终点啦</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/platform/web/entry-runtime-with-compiler.js</span></div><div class="line"></div><div class="line"><span class="comment">// 对mount方法进一步扩展</span></div><div class="line">Vue.prototype.$mount</div></pre></td></tr></table></figure>
<p>自此，我们顺着各个模块，从构造函数开始，基本理清了Vue及其原型相关的属性和方法。这里强烈建议先去官网<a href="https://cn.vuejs.org/v2/api/" target="_blank" rel="external">API文档</a>了解相关的属性方法的含义。</p>
<h2 id="Vue实例"><a href="#Vue实例" class="headerlink" title="Vue实例"></a>Vue实例</h2><p>大致了解了Vue原型之后，接下来看看vue实例的属性和方法。</p>
<p>在构造函数中，我们发现调用了<code>this._init(options)</code>方法，即<code>Vue.prototype._init</code>方法，我们现在开始深入这个方法。</p>
<h3 id="合并配置参数"><a href="#合并配置参数" class="headerlink" title="合并配置参数"></a>合并配置参数</h3><p>首先遇见的第一个问题就是合并配置参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vm.$options = mergeOptions(</div><div class="line">    resolveConstructorOptions(vm.constructor), <span class="comment">// 实际上返回Vue.options</span></div><div class="line">    options || &#123;&#125;, <span class="comment">// 我们传入的配置参数</span></div><div class="line">    vm</div><div class="line">)</div></pre></td></tr></table></figure>
<p>这个<code>mergeOptions</code>的工具函数就是用来合并配置参数并将结果挂载到<code>vm.$options</code>上的，非常重要。参看<a href="自定义合并策略">文档</a>，Vue允许我们自定义合并策略的选项。所谓自定义策略就是允许我们自己决定如何合并Vue.options和传入的这两个配置参数。</p>
<p>先来看看源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/util/options.js</span></div><div class="line"><span class="keyword">const</span> strats = config.optionMergeStrategies</div><div class="line"></div><div class="line"><span class="comment">// strats的每个属性都是配置对象上相关键值的合并策略</span></div><div class="line">strats.el = strats.propsData = <span class="function"><span class="keyword">function</span> (<span class="params">parent, child, vm, key</span>) </span>&#123;&#125;</div><div class="line">strats.data = <span class="function"><span class="keyword">function</span> (<span class="params">parentVal: any, childVal: any, vm?: Component</span>): ?<span class="title">Function</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// 合并相关的声明周期钩子函数</span></div><div class="line">LIFECYCLE_HOOKS.forEach(<span class="function"><span class="params">hook</span> =&gt;</span> &#123;</div><div class="line">  strats[hook] = mergeHook</div><div class="line">&#125;)</div><div class="line"><span class="comment">// 合并component、directive和filter</span></div><div class="line">ASSET_TYPES.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</div><div class="line">  strats[type + <span class="string">'s'</span>] = mergeAssets</div><div class="line">&#125;)</div><div class="line"><span class="comment">// 合并watch，</span></div><div class="line"><span class="comment">// 这里注释提到Watchers hashes should not overwrite one，so we merge them as arrays.</span></div><div class="line">strats.watch = <span class="function"><span class="keyword">function</span> (<span class="params">parent, child, vm, key</span>) </span>&#123;&#125;</div><div class="line">strats.props = strats.methods = strats.inject = strats.computed = <span class="function"><span class="keyword">function</span> (<span class="params">parent, child, vm, key</span>) </span>&#123;&#125;</div><div class="line"></div><div class="line">strats.provide = mergeDataOrFn</div><div class="line"></div><div class="line"><span class="comment">// 默认的合并策略，如果传入的配置参数存在，则直接返回，否则返回vue.options</span></div><div class="line"><span class="keyword">const</span> defaultStrat = <span class="function"><span class="keyword">function</span> (<span class="params">parentVal: any, childVal: any</span>): <span class="title">any</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> childVal === <span class="literal">undefined</span></div><div class="line">    ? parentVal</div><div class="line">    : childVal</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  parent: Object,</span></span></div><div class="line"><span class="function"><span class="params">  child: Object,</span></span></div><div class="line"><span class="function"><span class="params">  vm?: Component</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;  <span class="keyword">const</span> options = &#123;&#125;</div><div class="line">  <span class="comment">// ....</span></div><div class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</div><div class="line">    mergeField(key)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</div><div class="line">    <span class="keyword">if</span> (!hasOwn(parent, key)) &#123;</div><div class="line">      mergeField(key)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 这里就是调用相关的合并策略，然后合并字段</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mergeField</span> (<span class="params">key</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> strat = strats[key] || defaultStrat</div><div class="line">    options[key] = strat(parent[key], child[key], vm, key)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> options</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>策略对象内置了基本属性的合并策略，此外我们也可以通过<code>Vue.config.optionMergeStrategies</code>实现自定义属性的合并策略。上面策略对象的相关属性想必大家都不陌生，不论是在组件还是在实例的构建中，上面的参数都或多或少有使用过。</p>
<p>配置参数的合并结果最终会以<code>vm.$options = options</code>的形式关联到vm实例上，至此我们对于配置参数是如何绑定到vm实例上的应该有了一个大致的印象。</p>
<p>那么，为什么要通过这么绕的方式来合并配置参数呢？往常用过的插件中，往往只是提供一个默认的配置参数，然后通过传入的配置参数简单覆盖即可？</p>
<p>我的理解是：由于Vue允许使用自定义属性，这样可以方便扩展~对应文档中的使用方法，可以精准到为每个字段设置不同的合并策略，下面是文档中的一个demo</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Vue.config.optionMergeStrategies._my_option = <span class="function"><span class="keyword">function</span> (<span class="params">parent, child, vm</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> child + <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> Profile = Vue.extend(&#123;</div><div class="line">  _my_option: <span class="number">1</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// Profile.options._my_option = 2</span></div></pre></td></tr></table></figure>
<h3 id="实例属性和方法"><a href="#实例属性和方法" class="headerlink" title="实例属性和方法"></a>实例属性和方法</h3><p>现在我们重新回到<code>Vue.prototype._init</code>这个方法中，实际上整个构造函数就是为实例添加相关的属性，把代码简化之后是下面的形式，追踪到每个初始化工具函数中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/init.js</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> vm = <span class="keyword">this</span></div><div class="line">vm._uid = uid++</div><div class="line">vm._isVue = <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">// merge options</span></div><div class="line"><span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</div><div class="line">  initInternalComponent(vm, options)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  vm.$options = mergeOptions(</div><div class="line">    resolveConstructorOptions(vm.constructor),</div><div class="line">    options || &#123;&#125;,</div><div class="line">    vm</div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line">initProxy(vm)</div><div class="line"><span class="comment">// vm._renderProxy = new Proxy(vm, handlers)</span></div><div class="line"></div><div class="line">vm._self = vm</div><div class="line"></div><div class="line">initLifecycle(vm)</div><div class="line"><span class="comment">// vm.$parent = parent</span></div><div class="line"><span class="comment">// vm.$root = parent ? parent.$root : vm</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// vm.$children = []</span></div><div class="line"><span class="comment">// vm.$refs = &#123;&#125;</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// vm._watcher = null</span></div><div class="line"><span class="comment">// vm._inactive = null</span></div><div class="line"><span class="comment">// vm._directInactive = false</span></div><div class="line"><span class="comment">// vm._isMounted = false</span></div><div class="line"><span class="comment">// vm._isDestroyed = false</span></div><div class="line"><span class="comment">// vm._isBeingDestroyed = false</span></div><div class="line"></div><div class="line">initEvents(vm)</div><div class="line"><span class="comment">// vm._events = Object.create(null)</span></div><div class="line"><span class="comment">// vm._hasHookEvent = false</span></div><div class="line"></div><div class="line">initRender(vm)</div><div class="line"><span class="comment">// vm._vnode = null </span></div><div class="line"><span class="comment">// vm._staticTrees</span></div><div class="line"><span class="comment">// vm.$slots </span></div><div class="line"><span class="comment">// vm.$scopedSlots</span></div><div class="line"><span class="comment">// vm._c</span></div><div class="line"><span class="comment">// vm.$createElement</span></div><div class="line"><span class="comment">// defineReactive</span></div><div class="line"></div><div class="line"><span class="comment">// 调用beforeCreate钩子函数</span></div><div class="line">callHook(vm, <span class="string">'beforeCreate'</span>)</div><div class="line"></div><div class="line">initInjections(vm) <span class="comment">// resolve injections before data/props</span></div><div class="line"><span class="comment">// defineReactive</span></div><div class="line"></div><div class="line">initState(vm)</div><div class="line"><span class="comment">// vm._watchers</span></div><div class="line"><span class="comment">// initProps</span></div><div class="line"><span class="comment">// initMethods</span></div><div class="line"><span class="comment">// initData</span></div><div class="line"><span class="comment">// initComputed</span></div><div class="line"><span class="comment">// initWatch</span></div><div class="line"></div><div class="line">initProvide(vm) <span class="comment">// resolve provide after data/props</span></div><div class="line"><span class="comment">// vm._provided</span></div><div class="line"></div><div class="line"><span class="comment">// 调用created钩子函数</span></div><div class="line">callHook(vm, <span class="string">'created'</span>)</div><div class="line"></div><div class="line"><span class="comment">// 将vm实例挂载到el上，进行渲染</span></div><div class="line"><span class="keyword">if</span> (vm.$options.el) &#123;</div><div class="line">  vm.$mount(vm.$options.el)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，我们了解到了vm实例上面相关属性的来源。</p>
<p>其中，在<code>initState</code>方法中，会根据<code>vm.$options</code>的相关属性，执行下面 的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/state.js</span></div><div class="line">vm._watchers = []</div><div class="line"><span class="keyword">const</span> opts = vm.$options</div><div class="line"><span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</div><div class="line"><span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</div><div class="line"><span class="keyword">if</span> (opts.data) &#123;</div><div class="line">  initData(vm)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  observe(vm._data = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</div><div class="line"><span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</div><div class="line">  initWatch(vm, opts.watch)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>事实上，在最简单的<code>Hello World</code>Demo中，上面的不少工作都会被跳过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">  &#123;&#123; msg &#125;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">  <span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span></div><div class="line"><span class="javascript">    el: <span class="string">"#app"</span>,</span></div><div class="line"><span class="undefined">    data: &#123;</span></div><div class="line"><span class="javascript">      msg: <span class="string">"Hello World"</span></span></div><div class="line"><span class="undefined">    &#125;,</span></div><div class="line"><span class="undefined">  &#125;)</span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>只需要简单的改变<code>vm.$data.msg</code>的值，就可以观察到Vue的响应式工作了，查看框架的工作流程可以发现这里调用的是<code>initData(vm)</code>方法，相关的分析在下一章进行。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>虽然在工作中一直在使用Vue，却对于内部的运行机制不是很了解，这加上Vue的入门比较简单，让我有种难以言喻的危机感。</p>
<p>网上现在有不少关于Vue源码分析的教程，有的写得挺不错的，但终归是别人总结的，如果没有真正阅读代码，肯定会漏掉一些东西，加上Vue的版本迭代也比较快，因此决定自己尝试进行源码分析，水平有限，慢慢来折腾吧~</p>
<p>### </p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/Vue" class="article_tag">#Vue</a>
        
        <a href="/tags/源码分析" class="article_tag">#源码分析</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#预备知识"><span class="toc-number">1.</span> <span class="toc-text">预备知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#平台差异"><span class="toc-number">1.1.</span> <span class="toc-text">平台差异</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开发环境搭建"><span class="toc-number">1.2.</span> <span class="toc-text">开发环境搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-number">2.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue原型及对象"><span class="toc-number">3.</span> <span class="toc-text">Vue原型及对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vue实例"><span class="toc-number">4.</span> <span class="toc-text">Vue实例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#合并配置参数"><span class="toc-number">4.1.</span> <span class="toc-text">合并配置参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例属性和方法"><span class="toc-number">4.2.</span> <span class="toc-text">实例属性和方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>