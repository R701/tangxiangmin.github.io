<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">Vue源码阅读笔记之语法细节（四）</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/12/21 9:14:43</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>这是”Vue源码阅读笔记”系列第四篇文章。上一章我们分析了Vue的模板编译和渲染过程，却忽略了模板中的很多细节，比如属性绑定、事件绑定、指令和计算属性等。此外还有混合、自定义属性监听等一些细节没有处理，由于后续的分析中这些细节不可避免，因此趁热打铁，来梳理一下Vue相关的一些细节。</p>
<a id="more"></a>
<h2 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h2><p>Vue的模板语法实际上有不少，下面先简单总结一下：</p>
<ul>
<li><code></code>形式插入数据</li>
<li><code>v-for</code>、<code>v-if</code>、<code>v-html</code>等指令</li>
<li><code>v-bind:</code>属性绑定，缩写<code>:</code></li>
<li><code>v-on</code>事件监听，缩写<code>@</code></li>
<li>指令修饰符<code>.</code></li>
<li><code>computed</code>计算属性</li>
<li><code>filters</code>过滤器，在模板中使用<code>|</code>进行修饰</li>
</ul>
<h3 id="入门示例"><a href="#入门示例" class="headerlink" title="入门示例"></a>入门示例</h3><p>然后写一个包含上面语法的简单例子来实验一下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span> @<span class="attr">click.stop</span>=<span class="string">"changeMsg"</span> <span class="attr">title</span>=<span class="string">"this is static Title"</span> <span class="attr">:class</span>=<span class="string">"&#123;'text-red': isWarn&#125;"</span> <span class="attr">v-html</span>=<span class="string">"formatHtml"</span>&gt;</span></div><div class="line">  		</div><div class="line">  	<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in arr"</span> <span class="attr">v-if</span>=<span class="string">"item%2"</span>&gt;</span>&#123;&#123;item | double&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">"#app"</span>,</div><div class="line">  data: &#123;</div><div class="line">    msg: <span class="string">"Hello World"</span>,</div><div class="line">    arr: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</div><div class="line">    isWarn: <span class="literal">true</span></div><div class="line">  &#125;,</div><div class="line">  computed: &#123;</div><div class="line">    formatDate() &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>().toDateString();</div><div class="line">    &#125;,</div><div class="line">    formatHtml() &#123;</div><div class="line">      <span class="keyword">return</span> <span class="string">`&lt;span&gt;<span class="subst">$&#123;<span class="keyword">this</span>.formatDate&#125;</span>&lt;/span&gt;`</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  filters: &#123;</div><div class="line">    double(val) &#123;</div><div class="line">      <span class="keyword">return</span> val * <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  methods: &#123;</div><div class="line">    changeMsg() &#123;</div><div class="line">      <span class="keyword">this</span>.msg = <span class="string">"Now msg has changed"</span>;</div><div class="line">    &#125;,</div><div class="line">    listenChild(e) &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"msg from child"</span>);</div><div class="line">      <span class="built_in">console</span>.log(e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="分析render函数"><a href="#分析render函数" class="headerlink" title="分析render函数"></a>分析render函数</h3><p>我们先来看看编译得到的render函数是什么样子的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">with</span> (<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="keyword">return</span> _c(<span class="string">"div"</span>, &#123; <span class="attr">attrs</span>: &#123; <span class="attr">id</span>: <span class="string">"app"</span> &#125; &#125;, [</div><div class="line">      _c(<span class="string">"h1"</span>, &#123;</div><div class="line">        class: &#123; "text-red": isWarn &#125;,</div><div class="line">        attrs: &#123; <span class="attr">title</span>: <span class="string">"this is static Title"</span> &#125;,</div><div class="line">        domProps: &#123; <span class="attr">innerHTML</span>: _s(formatHtml) &#125;,</div><div class="line">        on: &#123;</div><div class="line">          click: <span class="function"><span class="keyword">function</span>(<span class="params">$event</span>) </span>&#123;</div><div class="line">            $event.stopPropagation();</div><div class="line">            changeMsg($event);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;),</div><div class="line">      _v(<span class="string">" "</span>),</div><div class="line">      _c(</div><div class="line">        <span class="string">"ul"</span>,</div><div class="line">        _l(arr, <span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> item % <span class="number">2</span> ? _c(<span class="string">"li"</span>, [_v(_s(_f(<span class="string">"double"</span>)(item)))]) : _e();</div><div class="line">        &#125;)</div><div class="line">      )</div><div class="line">    ]);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>通过render函数，我们可以先猜一猜对应的模板语法哈哈~</p>
<ul>
<li>title等保留属性保留在attrs属性下，<code>v-html</code>指令会保留在domProps属性下，对应<code>innerHTML</code></li>
<li>class会直接保留在<code>class</code>属性下</li>
<li><code>v-for</code>会编译成<code>_l(arr, cb)</code>函数，<code>v-if</code>会生成三目运算符</li>
<li>过滤器会编译成<code>_f(&quot;double&quot;)(item)</code></li>
<li>计算属性会编译成<code>_s(formatHtml)</code></li>
<li><code>@</code>等注册的事件保留在on属性下，修饰符<code>.stop</code>会调用<code>stopPropagation</code></li>
</ul>
<p>参考<a href="https://cn.vuejs.org/v2/guide/render-function.html#深入-data-对象" target="_blank" rel="external">官方文档</a>关于<code>createElement</code>方法的配置对象，在<a href="/article/Vue源码阅读笔记之模板渲染（三）">模板渲染</a>这章中我们了解render函数的生成过程，以及<code>_l</code>、<code>_f</code>等辅助函数的大致作用。看来接下来还是需要去看一看模板解析的内部实现，先定个小要求：<strong>不拘泥于实现细节</strong></p>
<h3 id="模板解析的细节"><a href="#模板解析的细节" class="headerlink" title="模板解析的细节"></a>模板解析的细节</h3><p>在上一章我们知道了模板解析的具体工作是在<code>baseCompile</code>中进行的，实际工作又分为了3步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 解析模板为AST</span></div><div class="line"><span class="keyword">const</span> ast = parse(template.trim(), options)</div><div class="line"><span class="comment">// 优化AST ，标记不会变化的子节点树</span></div><div class="line">optimize(ast, options)</div><div class="line"><span class="comment">// 根据AST生成render函数</span></div><div class="line"><span class="keyword">const</span> code = generate(ast, options)</div></pre></td></tr></table></figure>
<p>AST（抽象语法树）实际上就是将模板转换成JavaScript对象的结果。在<code>parse</code>中使用了大量的正则对标签和属性进行提取，然后返回根节点的AST对象。</p>
<p>相对于原始模板标签，JS对象更容易操作，我们先看一看AST长啥样子</p>
<p><img src="http://otdr0meos.bkt.clouddn.com/blog/Vue_AST.png" alt=""></p>
<ul>
<li>标签上不同的属性被解析到不同的节点上，比如指令解析在attrsList中</li>
</ul>
<ul>
<li>而节点上的static属性，是在第二步添加的。</li>
</ul>
<p>而对于第三步，具体一点来说就是根据AST语法树的节点属性，拼接执行函数。而我们要现在要了解的就是<code>generate</code>，主要是看看模板中的指令在内部的实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/compler/codegen/index.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  ast: ASTElement | void,</span></span></div><div class="line"><span class="function"><span class="params">  options: CompilerOptions</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">CodegenResult</span> </span>&#123;</div><div class="line">  <span class="comment">// 根据options生成对应的CodegenState对象，该对象只有一些属性用来保存编译过程中的数据</span></div><div class="line">  <span class="keyword">const</span> state = <span class="keyword">new</span> CodegenState(options)</div><div class="line">  <span class="keyword">const</span> code = ast ? genElement(ast, state) : <span class="string">'_c("div")'</span></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    render: <span class="string">`with(this)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span>,</div><div class="line">    staticRenderFns: state.staticRenderFns</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="generate函数"><a href="#generate函数" class="headerlink" title="generate函数"></a>generate函数</h3><p>调用<code>genElement</code>，传入根节点的ast，然后生成对应的code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 通过ast和state生成code</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genElement</span> (<span class="params">el: ASTElement, state: CodegenState</span>): <span class="title">string</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (el.staticRoot &amp;&amp; !el.staticProcessed) &#123;</div><div class="line">    <span class="keyword">return</span> genStatic(el, state)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.once &amp;&amp; !el.onceProcessed) &#123;</div><div class="line">    <span class="keyword">return</span> genOnce(el, state)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.for &amp;&amp; !el.forProcessed) &#123;</div><div class="line">    <span class="keyword">return</span> genFor(el, state)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.if &amp;&amp; !el.ifProcessed) &#123;</div><div class="line">    <span class="keyword">return</span> genIf(el, state)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.tag === <span class="string">'template'</span> &amp;&amp; !el.slotTarget) &#123;</div><div class="line">    <span class="keyword">return</span> genChildren(el, state) || <span class="string">'void 0'</span></div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.tag === <span class="string">'slot'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> genSlot(el, state)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// component or element</span></div><div class="line">    <span class="keyword">let</span> code</div><div class="line">    <span class="keyword">if</span> (el.component) &#123;</div><div class="line">      code = genComponent(el.component, el, state)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 处理ast相关数据属性</span></div><div class="line">      <span class="keyword">const</span> data = el.plain ? <span class="literal">undefined</span> : genData(el, state)</div><div class="line">	  <span class="comment">// 处理子节点	</span></div><div class="line">      <span class="keyword">const</span> children = el.inlineTemplate ? <span class="literal">null</span> : genChildren(el, state, <span class="literal">true</span>)</div><div class="line">      code = <span class="string">`_c('<span class="subst">$&#123;el.tag&#125;</span>'<span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> data</span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> children</span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span>)`</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// module transforms</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.transforms.length; i++) &#123;</div><div class="line">      code = state.transforms[i](el, code)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> code</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 生成子节点</span></div></pre></td></tr></table></figure>
<p><code>genData</code>展示了如何将ast节点的属性值转换为<code>createElement</code>函数的配置项，这个过程貌似跟写编译器很像~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genData</span> (<span class="params">el: ASTElement, state: CodegenState</span>): <span class="title">string</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> data = <span class="string">'&#123;'</span></div><div class="line"></div><div class="line">  <span class="comment">// directives first.</span></div><div class="line">  <span class="comment">// directives may mutate the el's other properties before they are generated.</span></div><div class="line">  <span class="keyword">const</span> dirs = genDirectives(el, state)</div><div class="line">  <span class="keyword">if</span> (dirs) data += dirs + <span class="string">','</span></div><div class="line"></div><div class="line">  <span class="comment">// key</span></div><div class="line">  <span class="keyword">if</span> (el.key) &#123;</div><div class="line">    data += <span class="string">`key:<span class="subst">$&#123;el.key&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// ref</span></div><div class="line">  <span class="keyword">if</span> (el.ref) &#123;</div><div class="line">    data += <span class="string">`ref:<span class="subst">$&#123;el.ref&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (el.refInFor) &#123;</div><div class="line">    data += <span class="string">`refInFor:true,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// pre</span></div><div class="line">  <span class="keyword">if</span> (el.pre) &#123;</div><div class="line">    data += <span class="string">`pre:true,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// record original tag name for components using "is" attribute</span></div><div class="line">  <span class="keyword">if</span> (el.component) &#123;</div><div class="line">    data += <span class="string">`tag:"<span class="subst">$&#123;el.tag&#125;</span>",`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// module data generation functions</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.dataGenFns.length; i++) &#123;</div><div class="line">    data += state.dataGenFns[i](el)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// attributes</span></div><div class="line">  <span class="keyword">if</span> (el.attrs) &#123;</div><div class="line">    data += <span class="string">`attrs:&#123;<span class="subst">$&#123;genProps(el.attrs)&#125;</span>&#125;,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// DOM props</span></div><div class="line">  <span class="keyword">if</span> (el.props) &#123;</div><div class="line">    data += <span class="string">`domProps:&#123;<span class="subst">$&#123;genProps(el.props)&#125;</span>&#125;,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// event handlers</span></div><div class="line">  <span class="keyword">if</span> (el.events) &#123;</div><div class="line">    data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events, <span class="literal">false</span>, state.warn)&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (el.nativeEvents) &#123;</div><div class="line">    data += <span class="string">`<span class="subst">$&#123;genHandlers(el.nativeEvents, <span class="literal">true</span>, state.warn)&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// slot target</span></div><div class="line">  <span class="comment">// only for non-scoped slots</span></div><div class="line">  <span class="keyword">if</span> (el.slotTarget &amp;&amp; !el.slotScope) &#123;</div><div class="line">    data += <span class="string">`slot:<span class="subst">$&#123;el.slotTarget&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// scoped slots</span></div><div class="line">  <span class="keyword">if</span> (el.scopedSlots) &#123;</div><div class="line">    data += <span class="string">`<span class="subst">$&#123;genScopedSlots(el.scopedSlots, state)&#125;</span>,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// component v-model</span></div><div class="line">  <span class="keyword">if</span> (el.model) &#123;</div><div class="line">    data += <span class="string">`model:&#123;value:<span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">      el.model.value</span></span></div><div class="line"><span class="string"><span class="subst">    &#125;</span>,callback:<span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">      el.model.callback</span></span></div><div class="line"><span class="string"><span class="subst">    &#125;</span>,expression:<span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">      el.model.expression</span></span></div><div class="line"><span class="string"><span class="subst">    &#125;</span>&#125;,`</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// inline-template</span></div><div class="line">  <span class="keyword">if</span> (el.inlineTemplate) &#123;</div><div class="line">    <span class="keyword">const</span> inlineTemplate = genInlineTemplate(el, state)</div><div class="line">    <span class="keyword">if</span> (inlineTemplate) &#123;</div><div class="line">      data += <span class="string">`<span class="subst">$&#123;inlineTemplate&#125;</span>,`</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  data = data.replace(<span class="regexp">/,$/</span>, <span class="string">''</span>) + <span class="string">'&#125;'</span></div><div class="line">  <span class="comment">// v-bind data wrap</span></div><div class="line">  <span class="keyword">if</span> (el.wrapData) &#123;</div><div class="line">    data = el.wrapData(data)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// v-on data wrap</span></div><div class="line">  <span class="keyword">if</span> (el.wrapListeners) &#123;</div><div class="line">    data = el.wrapListeners(data)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> data</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面展示了最主要的执行流程 ，从<code>genElement</code>生成根节点开始</p>
<ul>
<li>在<code>genData</code>中，通过当前ast节点参数（来自于模板解析时解析标签的属性），拼接<code>createElement</code>函数的配置项参数</li>
</ul>
<ul>
<li>调用<code>genChildren</code>生成子节点，而在<code>genChildren</code>中又会递归调用<code>genElement</code>从而生成虚拟DOM树。</li>
<li><code>genElement</code>会根据当前标签属性的特性，生成特定的代码片段（就是函数内部前面那一段判断）</li>
</ul>
<p>理解了<code>genData</code>和<code>genChildren</code>，实际上对于整个模板解析的细节就差不多了~通过拼接代码，最后一个<code>with(this)</code>绑定到当前vm实例，然后执行编译函数就可以了。那么接下来的问题就是：编译函数中访问的属性和方法是如何绑定到vm上的呢？</p>
<p>实际上，在第二章分析了<code>initData</code>实现响应式数据，实际上vm实例还包括了其他的一些状态，比如<code>computed</code>、<code>watch</code>等，我们来简单看看他们的实现。</p>
<h2 id="其他的state"><a href="#其他的state" class="headerlink" title="其他的state"></a>其他的state</h2><p>跟data参数一样，其他的状态大致的流程也是：配置参数-&gt;<code>$options</code>-&gt;<code>initState()</code>进行的。</p>
<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><blockquote>
<p> 计算属性可以避免在模板中放入太多的逻辑。对于任何复杂逻辑，你都应当使用<strong>计算属性</strong></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/state.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initComputed</span> (<span class="params">vm: Component, computed: Object</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> watchers = vm._computedWatchers = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</div><div class="line">    <span class="keyword">const</span> userDef = computed[key]</div><div class="line">    <span class="comment">// 默认computed属性定义为函数则只有getter</span></div><div class="line">    <span class="comment">// 但是可以通过get和get对象提供setter和getter</span></div><div class="line">    <span class="keyword">const</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">'function'</span> ? userDef : userDef.get</div><div class="line">    <span class="comment">// 实例化一个新的wathcer</span></div><div class="line">    watchers[key] = <span class="keyword">new</span> Watcher(</div><div class="line">      vm,</div><div class="line">      getter || noop,</div><div class="line">      noop,</div><div class="line">      computedWatcherOptions</div><div class="line">    )</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</div><div class="line">      defineComputed(vm, key, userDef)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>计算属性是会被缓存的，<strong>缓存</strong>的意思是：只有在计算属性的的相关依赖发生改变时才会重新求值。比如前面的demo中，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">computed: &#123;</div><div class="line">  formatHtml()&#123;</div><div class="line">  	<span class="keyword">return</span> <span class="string">`&lt;p&gt;<span class="subst">$&#123;<span class="keyword">this</span>.formatDate&#125;</span>&lt;/p&gt;`</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于在访问<code>this.formatDate</code>时会在<code>formatDate</code>的get中收集依赖，因此当其发生变化时，对应的计算属性也会发生变化。</p>
<p>但多次访问同一个计算属性时，其结果是会被缓存的，这也是<code>computed</code>和<code>methods</code>的不同，下面是具体的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineComputed</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  target: any,</span></span></div><div class="line"><span class="function"><span class="params">  key: string,</span></span></div><div class="line"><span class="function"><span class="params">  userDef: Object | Function</span></span></div><div class="line"><span class="function"><span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> shouldCache = !isServerRendering()</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="comment">// 修改get，防止重复计算</span></div><div class="line">    sharedPropertyDefinition.get = shouldCache</div><div class="line">      ? createComputedGetter(key)</div><div class="line">      : userDef</div><div class="line">    sharedPropertyDefinition.set = noop</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    sharedPropertyDefinition.get = userDef.get</div><div class="line">      ? shouldCache &amp;&amp; userDef.cache !== <span class="literal">false</span></div><div class="line">        ? createComputedGetter(key)</div><div class="line">        : userDef.get</div><div class="line">      : noop</div><div class="line">    sharedPropertyDefinition.set = userDef.set</div><div class="line">      ? userDef.set</div><div class="line">      : noop</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 最后直接上计算属性的key绑定到当前vm对象属性上</span></div><div class="line">  <span class="comment">// 而不是通过代理的方式访问，这也是跟data不同的地方</span></div><div class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span> (<span class="params">key</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key]</div><div class="line">    <span class="keyword">if</span> (watcher) &#123;</div><div class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</div><div class="line">        watcher.evaluate()</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (Dep.target) &#123;</div><div class="line">        watcher.depend()</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 实际上返回的watcher的value值</span></div><div class="line">      <span class="keyword">return</span> watcher.value</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里居然发现了一个<code>cache</code>的配置，意思是可以强制不缓存计算属性值而是每次都调用<code>get</code>。表示教程文档里面居然没有看见这个选项~看源码的意外收获</p>
<h3 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h3><blockquote>
<p>Vue 通过 <code>watch</code> 选项提供了一个更通用的方法，实现自定义的侦听器，来响应数据的变化。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/state.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWatch</span> (<span class="params">vm: Component, watch: Object</span>) </span>&#123;</div><div class="line">  <span class="comment">// 遍历watch属性，依次注册</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</div><div class="line">    <span class="keyword">const</span> handler = watch[key]</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handler)) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.length; i++) &#123;</div><div class="line">        createWatcher(vm, key, handler[i])</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      createWatcher(vm, key, handler)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWatcher</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  vm: Component,</span></span></div><div class="line"><span class="function"><span class="params">  keyOrFn: string | Function,</span></span></div><div class="line"><span class="function"><span class="params">  handler: any,</span></span></div><div class="line"><span class="function"><span class="params">  options?: Object</span></span></div><div class="line"><span class="function"><span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (isPlainObject(handler)) &#123;</div><div class="line">    options = handler</div><div class="line">    handler = handler.handler</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">'string'</span>) &#123;</div><div class="line">    handler = vm[handler]</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> vm.$watch(keyOrFn, handler, options)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 在前面的学习中我们知道<code>vm.$watch</code>是在<code>stateMixin(Vue)</code>中注册的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/state.js</span></div><div class="line">Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">    expOrFn: string | Function,</span></span></div><div class="line"><span class="function"><span class="params">    cb: any,</span></span></div><div class="line"><span class="function"><span class="params">    options?: Object</span></span></div><div class="line"><span class="function"><span class="params">  </span>): <span class="title">Function</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></div><div class="line">    <span class="keyword">if</span> (isPlainObject(cb)) &#123;</div><div class="line">      <span class="keyword">return</span> createWatcher(vm, expOrFn, cb, options)</div><div class="line">    &#125;</div><div class="line">    options = options || &#123;&#125;</div><div class="line">    options.user = <span class="literal">true</span></div><div class="line">  	<span class="comment">// 实例化一个watcher对象</span></div><div class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> Watcher(vm, expOrFn, cb, options)</div><div class="line">    <span class="keyword">if</span> (options.immediate) &#123;</div><div class="line">      cb.call(vm, watcher.value)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unwatchFn</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      watcher.teardown()</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看见，watch配置实际上是提供了为指定属性额外注册Watcher的接口，当对应属性发生变化时，会通知所有的watcher，在watcher内部的<code>run</code>方法中可以找到对应的回调执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this.cb.call(this.vm, value, oldValue)</div></pre></td></tr></table></figure>
<p>此时新值和旧值都会被当做参数传入回调然后运行。</p>
<h3 id="methods"><a href="#methods" class="headerlink" title="methods"></a>methods</h3><p>方法是经常用到的一个配置项，其注册也十分简单，在内部通过<code>bind</code>直接绑定到当前vm实例上</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/state.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMethods</span> (<span class="params">vm: Component, methods: Object</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> props = vm.$options.props</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</div><div class="line">    <span class="comment">// ... 省略判断</span></div><div class="line">    vm[key] = methods[key] == <span class="literal">null</span> ? noop : bind(methods[key], vm)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后就可以直接通过<code>this.methodName</code>进行访问了</p>
<h3 id="props"><a href="#props" class="headerlink" title="props"></a>props</h3><p>属性是组件系统一个非常重要的概念，在下一章我们会专门分析props，因此这里暂时略过~</p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="filters"><a href="#filters" class="headerlink" title="filters"></a>filters</h3><blockquote>
<p>Vue.js 允许你自定义过滤器，可被用于一些常见的文本格式化</p>
</blockquote>
<p>过滤器这个概念在很多其他的模板引擎中也是存在的，比如<code>swig</code>。可以把他当做是辅助函数的语法糖，比如格式化日期、添加图片前缀的功能，可以通过过滤器来实现，减少模板中的逻辑，从而更方便维护。</p>
<p>从上面的<code>-f()</code>函数入手</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveFilter</span> (<span class="params">id: string</span>): <span class="title">Function</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> resolveAsset(<span class="keyword">this</span>.$options, <span class="string">'filters'</span>, id, <span class="literal">true</span>) || identity</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>resolveFilter</code>实际上只是<code>resolveAsset</code>的快捷方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveAsset</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  options: Object,</span></span></div><div class="line"><span class="function"><span class="params">  type: string,</span></span></div><div class="line"><span class="function"><span class="params">  id: string,</span></span></div><div class="line"><span class="function"><span class="params">  warnMissing?: boolean</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</div><div class="line">  <span class="comment">/* istanbul ignore if */</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> id !== <span class="string">'string'</span>) &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 提取vm.$options上对应的资源项</span></div><div class="line">  <span class="keyword">const</span> assets = options[type]</div><div class="line">  <span class="comment">// check local registration variations first</span></div><div class="line">  <span class="keyword">if</span> (hasOwn(assets, id)) <span class="keyword">return</span> assets[id]</div><div class="line">  <span class="keyword">const</span> camelizedId = camelize(id)</div><div class="line">  <span class="keyword">if</span> (hasOwn(assets, camelizedId)) <span class="keyword">return</span> assets[camelizedId]</div><div class="line">  <span class="keyword">const</span> PascalCaseId = capitalize(camelizedId)</div><div class="line">  <span class="keyword">if</span> (hasOwn(assets, PascalCaseId)) <span class="keyword">return</span> assets[PascalCaseId]</div><div class="line">  <span class="comment">// fallback to prototype chain</span></div><div class="line">  <span class="keyword">const</span> res = assets[id] || assets[camelizedId] || assets[PascalCaseId]</div><div class="line">  <span class="keyword">return</span> res</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>过滤器可以是局部注册，也可以通过<code>Vue.filter</code>全局注册。实际上全局注册其内部也只是在实例上添加了对应的属性而已。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/global-api/assets.js</span></div><div class="line"><span class="keyword">this</span>.options[type + <span class="string">'s'</span>][id] = definition</div></pre></td></tr></table></figure>
<p>我觉得只需要把过滤器理解为一个针对模板数据的辅助函数即可。而过滤器的参数顺序和串联使用，反倒是更应该掌握的地方~</p>
<h3 id="directive"><a href="#directive" class="headerlink" title="directive"></a>directive</h3><blockquote>
<p>除了核心功能默认内置的指令 (<code>v-model</code> 和 <code>v-show</code>)，Vue 也允许注册自定义指令。如果需要对普通 DOM 元素进行底层操作，这时候就会用到自定义指令</p>
</blockquote>
<p>尽管MVVM框架中大部分时候是通过数据去驱动视图的，但是在某些时候还是需要我们直接操作DOM节点，自定义指令这时候就非常有用了。下面我们来看看源码中是如何处理内置指令和自定义指令的。</p>
<p>我们可以在render函数的第二个参数中找到<code>directives</code>相关的配置，在前面生成render函数的的<code>genData</code>中，可以看见首先处理的就是<code>genDirectives</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDirectives</span> (<span class="params">el: ASTElement, state: CodegenState</span>): <span class="title">string</span> | <span class="title">void</span> </span>&#123;</div><div class="line">  <span class="keyword">const</span> dirs = el.directives</div><div class="line">  <span class="keyword">if</span> (!dirs) <span class="keyword">return</span></div><div class="line">  <span class="keyword">let</span> res = <span class="string">'directives:['</span></div><div class="line">  <span class="keyword">let</span> hasRuntime = <span class="literal">false</span></div><div class="line">  <span class="keyword">let</span> i, l, dir, needRuntime</div><div class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = dirs.length; i &lt; l; i++) &#123;</div><div class="line">    dir = dirs[i]</div><div class="line">    needRuntime = <span class="literal">true</span></div><div class="line">    <span class="keyword">const</span> gen: DirectiveFunction = state.directives[dir.name]</div><div class="line">    <span class="keyword">if</span> (gen) &#123;</div><div class="line">      <span class="comment">// v-html等内置的指令会在这里直接执行</span></div><div class="line">      needRuntime = !!gen(el, dir, state.warn)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (needRuntime) &#123;</div><div class="line">      <span class="comment">// 其他的会拼接成render函数的配置项</span></div><div class="line">      hasRuntime = <span class="literal">true</span></div><div class="line">      res += <span class="string">`&#123;name:"<span class="subst">$&#123;dir.name&#125;</span>",rawName:"<span class="subst">$&#123;dir.rawName&#125;</span>"<span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        dir.value ? <span class="string">`,value:(<span class="subst">$&#123;dir.value&#125;</span>),expression:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.value)&#125;</span>`</span> : <span class="string">''</span></span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        dir.arg ? <span class="string">`,arg:"<span class="subst">$&#123;dir.arg&#125;</span>"`</span> : <span class="string">''</span></span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        dir.modifiers ? <span class="string">`,modifiers:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.modifiers)&#125;</span>`</span> : <span class="string">''</span></span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span>&#125;,`</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (hasRuntime) &#123;</div><div class="line">    <span class="keyword">return</span> res.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">']'</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>内置的指令</strong></p>
<p>从代码中可以发现，内置的指令会在编译时立即执行。其中，<code>state.directives</code>来自于其构造函数中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">CodegenState</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span> (options: CompilerOptions) &#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">   </div><div class="line">    <span class="comment">// 这里合并baseDirectives和配置项的directives</span></div><div class="line">    <span class="comment">// baseDirectives包括v-on，v-bind和v-cloak</span></div><div class="line">    <span class="comment">// options.directives包括v-model，v-text和v-html</span></div><div class="line">    <span class="keyword">this</span>.directives = extend(extend(&#123;&#125;, baseDirectives), options.directives)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以从<code>generate(ast, options)</code>的options来源找到<code>options.directives</code>的出处。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/platforms/web/comiler/index.js </span></div><div class="line"><span class="keyword">const</span> &#123; compile, compileToFunctions &#125; = createCompiler(baseOptions)</div></pre></td></tr></table></figure>
<p>说明我们可以为不同的平台声明不同的自定义指令，这在后面了解SSR可能会有帮助哦~先挖个坑</p>
<p><strong>自定义指令</strong></p>
<p>与内置指令不同的是，自定义指令作为配置参数在<code>createElement</code>中执行，我们去一探究竟</p>
<p>从<code>vm._c</code>出发，找到<code>_createElement</code>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/vdom/create-element.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></div><div class="line"><span class="function"><span class="params">  context: Component,</span></span></div><div class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></div><div class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></div><div class="line"><span class="function"><span class="params">  children?: any,</span></span></div><div class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></div><div class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> vnode = <span class="keyword">new</span> VNode(</div><div class="line">  	tag, data, children,</div><div class="line">  	<span class="literal">undefined</span>, <span class="literal">undefined</span>, context</div><div class="line">  )</div><div class="line">  <span class="keyword">return</span> vnode;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发现只是将配置参数传入了VNode的构造函数中，那么只剩下<code>patch</code>了（转念一想实际上也是对的，因为执行相关的钩子函数是在构建DOM树的时候才触发的）</p>
<p>以<code>insert</code>钩子函数为例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/vdom/patch.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeInsertHook</span> (<span class="params">vnode, queue, initial</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (isTrue(initial) &amp;&amp; isDef(vnode.parent)) &#123;</div><div class="line">    vnode.parent.data.pendingInsert = queue</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; queue.length; ++i) &#123;</div><div class="line">      queue[i].data.hook.insert(queue[i])</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createPatchFunction</span> (<span class="params">backend</span>) </span>&#123;</div><div class="line">  	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly, parentElm, refElm</span>) </span>&#123;</div><div class="line">    <span class="comment">// 依次调用insertedVnodeQueue队列中每个vnode的insert钩子，此时就是执行对应指令的钩子函数</span></div><div class="line">    invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch)  </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义指令还有其他一些钩子函数，除了<code>insert</code>之外，常用的还有<code>update</code>等。</p>
<p>大家可能对于<code>vnode.data.hook</code>的来源有一些疑惑，实际上是通过<code>invokeCreateHooks</code>添加的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</div><div class="line">    cbs.create[i](emptyNode, vnode)</div><div class="line">  &#125;</div><div class="line">  i = vnode.data.hook</div><div class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</div><div class="line">    <span class="keyword">if</span> (isDef(i.create)) i.create(emptyNode, vnode)</div><div class="line">    <span class="keyword">if</span> (isDef(i.insert)) insertedVnodeQueue.push(vnode)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>cbs.create</code>有一个<code>updateDirectives</code>的钩子函数，其内部调用<code>_update</code>函数对新指令进行注册，对已存在指令进行更新</p>
<h3 id="component"><a href="#component" class="headerlink" title="component"></a>component</h3><p>组件系统跟前面的props相呼应，我们下一章见~</p>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>回头看看模板语法，我们现在貌似还剩下了事件绑定。接下来让我们来看看Vue中的事件系统。</p>
<p><strong>自定义事件</strong></p>
<p>在<code>eventsMixin(Vue)</code>函数中，为Vue原型添加了相关事件的接口，包括<code>$on</code>、<code>$once</code>、<code>$emit</code>和<code>$off</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/core/instance/events.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">eventsMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</div><div class="line">  	<span class="comment">// 注册事件处理函数</span></div><div class="line">  Vue.prototype.$on = <span class="function"><span class="keyword">function</span> (<span class="params">event: string | Array&lt;string&gt;, fn: Function</span>): <span class="title">Component</span> </span>&#123;</div><div class="line">      <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></div><div class="line">      <span class="comment">// 实例内部维护一个_events对象，属性即为事件名，对应的属性值为一个维护处理函数的数组</span></div><div class="line">      (vm._events[event] || (vm._events[event] = [])).push(fn)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> vm</div><div class="line">  &#125;</div><div class="line">  	<span class="comment">// 注册只执行一次的事件处理函数</span></div><div class="line">  Vue.prototype.$once = <span class="function"><span class="keyword">function</span> (<span class="params">event: string, fn: Function</span>): <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></div><div class="line">    <span class="comment">// 使用on()函数替代默认的事件处理函数，</span></div><div class="line">    <span class="comment">// 在函数内部先取消对应处理函数，再执行该处理函数</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">on</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      vm.$off(event, on)</div><div class="line">      fn.apply(vm, <span class="built_in">arguments</span>)</div><div class="line">    &#125;</div><div class="line">    on.fn = fn</div><div class="line">    vm.$on(event, on)</div><div class="line">    <span class="keyword">return</span> vm</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 取消事件处理函数</span></div><div class="line">  Vue.prototype.$off = <span class="function"><span class="keyword">function</span> (<span class="params">event?: string | Array&lt;string&gt;, fn?: Function</span>): <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></div><div class="line">    <span class="comment">// 取消事件的本质实际上就是修改对应事件键值所维护的处理函数队列</span></div><div class="line">    <span class="comment">// 根据参数形式有取消全部事件及其处理函数、取消多个事件的处理函数、取消特定事件的处理函数、取消特性的处理函数等处理，这里就不粘贴代码了</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">return</span> vm</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 触发自定义事件</span></div><div class="line">  Vue.prototype.$emit = <span class="function"><span class="keyword">function</span> (<span class="params">event: string</span>): <span class="title">Component</span> </span>&#123;</div><div class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></div><div class="line">    <span class="comment">// 获取对应事件的所有处理函数，然后依次执行，即相当于触发了对应的事件</span></div><div class="line">    <span class="keyword">let</span> cbs = vm._events[event]</div><div class="line">    <span class="keyword">if</span> (cbs) &#123;</div><div class="line">      cbs = cbs.length &gt; <span class="number">1</span> ? toArray(cbs) : cbs</div><div class="line">      <span class="comment">// 获取额外的参数并作为事件处理函数的参数</span></div><div class="line">      <span class="keyword">const</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>)</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = cbs.length; i &lt; l; i++) &#123;</div><div class="line">          cbs[i].apply(vm, args)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> vm</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这几个接口是组件通信的基础，同样会在下一章进行讲解。实际上事件系统跟发布-订阅者模式十分相似，理解起来也有相同之处。</p>
<p><strong>原生事件</strong></p>
<p>但是上面的接口跟我们在模板中通过<code>@on</code>或者<code>v-on</code>注册的事件好像不一样。来个简单的例子</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;input v-focus @blur.stop=<span class="string">"blur"</span>&gt;</div></pre></td></tr></table></figure>
<p>有了前面的经验，我们直接从render函数入手然后去研究对应vnode在Patch过程中的处理即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">_c(<span class="string">"input"</span>, &#123;</div><div class="line">  directives: [&#123; <span class="attr">name</span>: <span class="string">"focus"</span>, <span class="attr">rawName</span>: <span class="string">"v-focus"</span> &#125;],</div><div class="line">  on: &#123;</div><div class="line">      blur: <span class="function"><span class="keyword">function</span>(<span class="params">$event</span>) </span>&#123;</div><div class="line">        $event.stopPropagation();</div><div class="line">        blur($event);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>可以render函数的生成过程中会直接将事件修饰符转换成对应的代码片段，而事件则会注册在on属性上，跟着断点我们可以找到，<strong>将on属性的每个事件的处理函数注册到对应的DOM元素</strong>这个过程是在<code>invokeCreateHooks</code>这里进行的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</div><div class="line">      <span class="comment">// cbs.create[2]就是updateDOMListeners</span></div><div class="line">      cbs.create[i](emptyNode, vnode)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /src/platforms/web/runtime/modules/events.js</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</div><div class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</div><div class="line">  target = vnode.elm</div><div class="line">  normalizeEvents(on)</div><div class="line">  <span class="comment">// 内部调用add方法会调用vnode.elm.addEventListener来注册事件处理函数</span></div><div class="line">  updateListeners(on, oldOn, add, remove, vnode.context)</div><div class="line">  target = <span class="literal">undefined</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK，现在我们算是知道了原生事件是如何绑定在DOM元素上的了。实际上这里的<code>cbs</code>有7个初始化方法，均会在invokeCreateHooks时调用，用来在vnode生成真实DOM节点时进行初始化。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这篇文章粗略整理了不少东西，主要是分析了Vue构造函数配置项中的相关选项及其内部的流程（当然还是忽略了具体的实现细节）。其中，<code>props</code>、<code>components</code>和事件的深入了解，我把它放到下一章<em>组件系统</em>中。</p>
<p>这篇文章本身就是在分析组件系统时回头重新整理的，大概花了一周的时间~回头一看，怎么这么长了（虽然大部分都是复制的源码~哈哈）</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/Vue" class="article_tag">#Vue</a>
        
        <a href="/tags/源码分析" class="article_tag">#源码分析</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#模板语法"><span class="toc-number">1.</span> <span class="toc-text">模板语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#入门示例"><span class="toc-number">1.1.</span> <span class="toc-text">入门示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析render函数"><span class="toc-number">1.2.</span> <span class="toc-text">分析render函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板解析的细节"><span class="toc-number">1.3.</span> <span class="toc-text">模板解析的细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generate函数"><span class="toc-number">1.4.</span> <span class="toc-text">generate函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他的state"><span class="toc-number">2.</span> <span class="toc-text">其他的state</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#computed"><span class="toc-number">2.1.</span> <span class="toc-text">computed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#watch"><span class="toc-number">2.2.</span> <span class="toc-text">watch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods"><span class="toc-number">2.3.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#props"><span class="toc-number">2.4.</span> <span class="toc-text">props</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#资源"><span class="toc-number">3.</span> <span class="toc-text">资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filters"><span class="toc-number">3.1.</span> <span class="toc-text">filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#directive"><span class="toc-number">3.2.</span> <span class="toc-text">directive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#component"><span class="toc-number">3.3.</span> <span class="toc-text">component</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事件"><span class="toc-number">4.</span> <span class="toc-text">事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>