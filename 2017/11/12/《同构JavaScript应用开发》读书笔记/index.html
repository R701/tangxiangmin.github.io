<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
            <a class="nav_item" href="/test">Test</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">《同构JavaScript应用开发》读书笔记</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/11/12 11:30:6</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>当持续迭代更新一个产品的时候，会遇见很多的问题。其中，技术选型决定了整个项目的<strong>模板渲染</strong>方案。在过去的项目中，尝试了如下几种模板渲染：</p>
<ul>
<li>服务端渲染，Ajax刷新局部页面</li>
<li>客户端渲染，采用Vue等框架构建单页面应用</li>
<li>纯静态资源，采用Hexo的框架在本地生成静态页面，然后进行部署</li>
<li>SSR，基于Vue-SSR和express等框架完成的单页面应用服务端渲染</li>
</ul>
<p>根据应用场景，每种方案均有优劣。恰好最近决定继续倒腾博客，正在阅读《同构JavaScript应用开发》这本书，稍作记录与思考。</p>
<p>&lt;!—more—&gt;</p>
<h2 id="几种渲染方案的问题"><a href="#几种渲染方案的问题" class="headerlink" title="几种渲染方案的问题"></a>几种渲染方案的问题</h2><p>回到开篇的渲染方案，现在列出他们存在的一些问题。（感觉这就是我的博客的更新史啊~）</p>
<h3 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h3><p>这是最原始的渲染方式，通过服务端输出经过数据填充的页面模板。页面上需要通过局部刷新的区域，通过ajax异步请求数据，然后操作DOM修改对应的内容。</p>
<p>这里ajax请求的数据可以有两种返回形式，</p>
<ul>
<li>继续通过后端模板引擎渲染数据，并返回html内容</li>
<li>只返回json数据，通过前端解析并生成对应的html内容</li>
</ul>
<p>如果采用第一种形式，不可避免会增加服务端压力以及网络传输成本（比如之前接触到的<a href="http://jui.org/" target="_blank" rel="external">J-UI后台管理框架</a>）。</p>
<p>如果采用第二种形式，相当于我们需要管理两份模板，一份是最初渲染页面时后端需要的模板，一份是异步更新时前端需要的模板。而后端和前端的模板引擎很可能是完全不同的语法和实现逻辑（比如<code>blade</code>和<code>ejs</code>什么的）。毫无疑问，管理两份模板，修改和维护的成本都会成倍增加。</p>
<h3 id="客户端渲染"><a href="#客户端渲染" class="headerlink" title="客户端渲染"></a>客户端渲染</h3><p>在SPA中，前后端分离会大大提升效率。API服务器只负责返回数据，应用服务器提供原始的静态页面数据（在vue-cli中对应的就是dist文件夹下面的资源），客户端负责展示数据。SPA应用中我们只需要维护一份模板，并且MVVM模式可以很方便地维护数据和模板。</p>
<p>但是单页面应用存在两个问题:</p>
<p>一是所有的模板和逻辑代码都放在js文件中进行，如果项目过大，则初始页面的加载速度可能会比较缓慢（因为打包后的静态资源体积可能会过于庞大）。利用CDN和组件按需打包可能可以缓解这个问题</p>
<p>第二个问题就是SEO的问题了。对于这个问题我深有体会，我司官网最初是采用<code>AngularJS</code>实现的，导致无法被百度收入，百度快照两个月才会更新一次，且内容全部为空。这是因为传统的爬虫只收录页面内容，而不会执行JavaScript代码。（貌似谷歌的爬虫现在可以了，但是国内…）</p>
<h3 id="SSR"><a href="#SSR" class="headerlink" title="SSR"></a>SSR</h3><p>对于SSR这块并不是十分了解，之前采用<code>Nuxt</code>对整个博客进行了SSR更新，同样参考官网这句话</p>
<blockquote>
<p>将同一个组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将静态标记”混合”为客户端上完全交互的应用程序</p>
</blockquote>
<p>似乎解决了SEO的问题，但是SSR会增加服务器的压力，因为需要将虚拟DOM的<code>vnode</code>渲染成实际的html代码。此外，还包括学习成本过高、颗粒化SEO等问题。</p>
<h3 id="纯静态资源"><a href="#纯静态资源" class="headerlink" title="纯静态资源"></a>纯静态资源</h3><p>用来搭建静态博客是个很好的选择，但是在实际的产品开发中，这种实现方式明显是不科学的~</p>
<h3 id="同构JavaScript"><a href="#同构JavaScript" class="headerlink" title="同构JavaScript"></a>同构JavaScript</h3><p>通过JavaScript是传统web应用和SPA的结合，可以上述的一些问题:</p>
<ul>
<li>支持SEO与路径优化</li>
<li>完全的JavaScript开发环境，只需要维护一套模板</li>
<li>通过服务端渲染优化首屏加载速度</li>
</ul>
<p>当然，同构JavaScript也不是万能的，所以这就是学习的乐趣啊…</p>
<h2 id="同构相关的概念"><a href="#同构相关的概念" class="headerlink" title="同构相关的概念"></a>同构相关的概念</h2><p>同构指的是需要实现某种映射，能够将客户端的功能映射到服务端的环境中，反之亦然。</p>
<p>根据客户端和服务端共享代码的程度：</p>
<ul>
<li>最低程度的同构，通过共享模板的方式共享视图层，并共用辅助函数</li>
<li>最大程度的同构，共享整个应用，包括视图层、模型、路由和控制器等</li>
<li>介于二者之间的共享</li>
</ul>
<h3 id="共享视图"><a href="#共享视图" class="headerlink" title="共享视图"></a>共享视图</h3><p>共享视图意味着模板和相应的视图逻辑都需要共享。</p>
<p>客户端的模板渲染只需要对模板进行数据填充；而在服务端，同一个模板会被渲染成字符串并作为响应结果返回，客户端需要接手完成服务端未完成的工作。</p>
<p>而视图逻辑无非就是对应的JavaScript代码，只要与执行环境无关，就可以实现对应的逻辑共享。</p>
<h3 id="共享路由"><a href="#共享路由" class="headerlink" title="共享路由"></a>共享路由</h3><p>在同构应用中，我们需要一套路由配置，并且能够在服务端和客户端之间进行共享。由于路由需要访问与环境相关的API，导致共享路由需要执行某些处理机制（比如在服务端需要获取当前的url并将其映射到对应的控制器方法上，而在客户端需要使用浏览器的API）</p>
<h3 id="共享模型"><a href="#共享模型" class="headerlink" title="共享模型"></a>共享模型</h3><p>模型为数据建立了一种抽象，同构应用可以使用服务端返回首屏响应之前一模一样的状态，对客户端进行初始化。</p>
<p>（PS:表示共享模型并不是十分理解，总体来说就是确保数据的一致性？）</p>
<h3 id="API的shim"><a href="#API的shim" class="headerlink" title="API的shim"></a>API的shim</h3><p><code>shim</code>这个单词在RequireJS中并不陌生。依赖于特定环境的API，我们可以通过环境判断抽象出一个统一的API，从而保证代码在两端运行，比如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> == <span class="string">'undefined'</span>)&#123;</div><div class="line">  ...</div><div class="line">&#125;<span class="keyword">else</span> &#123;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而对于与环境无关的公共模块，我们可以通过<code>webpack</code>对代码进行打包，从而将对应的Node模块转换到浏览器中。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>书中的思路是先实现服务端的请求，然后将相关的代码共享到客户端。关于具体的实现部分我打算在完成博客的重构之后单独整理一篇文章，因此下面只是简单梳理一下思路，至于相关的环境安装这里就不提了~。</p>
<p><a href="https://github.com/isomorphic-javascript-book/thaumoctopus-mimicus" target="_blank" rel="external">github项目地址</a>传送门。说实话这跟我预期的同构实现方案有很大出入（也许是我之前的设想并不能算作是同构吧）</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>由于写了不少后台代码，对于MVC框架的基本思路还是有一点了解的：定义路由并绑定对应的控制器方法，根据参数渲染模板最终返回给客户端完整的HTML代码。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>为了在客户端执行请求、响应周期，基本思路是劫持点击操作，然后异步请求数据并渲染模板。为了保持浏览器历史记录的完整性，我们可以使用HTML5的<code>History</code>接口来实现，这在之前的<a href="/article/history与单页面应用路由">history与单页面应用路由</a>已经整理过了。</p>
<h3 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h3><p>前后端均需要操作的对象包括cookie、重定向等，书中对这两个进行了示范，保证了前后端可以统一的接口。</p>
<h2 id="其他同构方案"><a href="#其他同构方案" class="headerlink" title="其他同构方案"></a>其他同构方案</h2><p>本书的第三部分介绍了已经用于生产环境的同构解决方案，包括使用React、全栈AngularJS等，后面再做了解。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这本书我看开头觉得十分精彩，因为作者关于模板提出的几个问题我都在实际项目中遇到过，并且在此之前并没有很好的解决方案。也许同构方案在我目前的工作项目中也不一定能用的上，因为将后端逻辑从PHP迁往NodeJS成本太大了。</p>
<p>不过多了解一点东西也不错嘛~当下的任务是先实现一个同构项目，也就是先把博客实现同构…虽然不知道最后做出来的到底算不算是同构呢~</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/同构" class="article_tag">#同构</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#几种渲染方案的问题"><span class="toc-number">1.</span> <span class="toc-text">几种渲染方案的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端渲染"><span class="toc-number">1.1.</span> <span class="toc-text">服务端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端渲染"><span class="toc-number">1.2.</span> <span class="toc-text">客户端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSR"><span class="toc-number">1.3.</span> <span class="toc-text">SSR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#纯静态资源"><span class="toc-number">1.4.</span> <span class="toc-text">纯静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同构JavaScript"><span class="toc-number">1.5.</span> <span class="toc-text">同构JavaScript</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#同构相关的概念"><span class="toc-number">2.</span> <span class="toc-text">同构相关的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#共享视图"><span class="toc-number">2.1.</span> <span class="toc-text">共享视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#共享路由"><span class="toc-number">2.2.</span> <span class="toc-text">共享路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#共享模型"><span class="toc-number">2.3.</span> <span class="toc-text">共享模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API的shim"><span class="toc-number">2.4.</span> <span class="toc-text">API的shim</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-number">3.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-number">3.2.</span> <span class="toc-text">客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽象"><span class="toc-number">3.3.</span> <span class="toc-text">抽象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他同构方案"><span class="toc-number">4.</span> <span class="toc-text">其他同构方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>