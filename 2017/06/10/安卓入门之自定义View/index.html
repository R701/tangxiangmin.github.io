<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
            <a class="nav_item" href="/test">Test</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">安卓入门之自定义View</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/6/10 9:22:10</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/Android" class="hover-highlight">Android</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近在打算用Anroid写一个IOS的原生计算器（咔嚓截个图就可以开始切了），然而在布局的实现过程中遇见了N多问题，随之而来的便是Android中的自定义View，下面待我一一道来。</p>
<a id="more"></a>
<p>下面的问题极有可能是目前我不了解安卓开发，导致走了弯路，恳请各位大佬帮忙指正。<br>参考下面自定义view系列文章，强烈推荐： </p>
<ul>
<li><a href="http://cherylgood.cn/articles/2017/06/01/1496288058132.html" target="_blank" rel="external">Android之View的诞生之谜</a></li>
<li><a href="http://a.codekk.com/detail/Android/lightSky/%E5%85%AC%E5%85%B1%E6%8A%80%E6%9C%AF%E7%82%B9%E4%B9%8B%20View%20%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B" target="_blank" rel="external">公共技术点之 View 绘制流程</a></li>
<li><a href="https://github.com/xinghongfei/awesome-view" target="_blank" rel="external">awesome-view</a></li>
</ul>
<h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>首先来看一看我们要实现的计算器，就是下面这个样子</p>
<p><img src="http://shymean.com/resource/calaulator.jpg" alt="IOS计算器"></p>
<h3 id="原生控件的缺陷"><a href="#原生控件的缺陷" class="headerlink" title="原生控件的缺陷"></a>原生控件的缺陷</h3><p>这个布局看起来用个<code>LinearLayout</code>和<code>TableLayout</code>就可以解决了，显示屏用<code>EditText</code>实现，按键用<code>Button</code>实现。但是，问题就出现在这个按键上面。</p>
<p>首先是样式的问题，折腾了半天，查了不少资料，发现要在xml中使用属性实现一个正方形的按键不是很容易的事情，百分比的宽度可以使用<code>layout_weight</code>属性实现，但是高度呢（并没有<code>vw</code>,<code>vh</code>这样的单位）？实际上我没有找到解决方案，换做CSS最多二十分钟就可以搞定整个页面了~。</p>
<p>其次，在每个控件上使用相同的样式（这里有19个按钮控件），想想都可怕。然而我并没有找到类似于样式表和类相似的概念，只有一个预定义样式的概念。另外，重置系统默认的按钮样式也挺麻烦的。</p>
<p>接着是事件的问题每个按钮都必须有唯一的id，但是他们都点击事件都可以抽象为同一个操作，只需要获取点击按钮对应的值就可以了。但是，如何在点击事件上快速获取对应按钮的值是一个很蛋疼的问题。类似于下面这样，简直没法忍受。控件能够按组划分然后批量获取吗?<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 很多按钮</span></div><div class="line">btn_0 = (Button) findViewById(R.id.btn_0);</div><div class="line">btn_1 = (Button) findViewById(R.id.btn_1);</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// 通过实现View.OnClickListener注册统一的事件处理函数</span></div><div class="line">btn_0.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">btn_1.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>一个折衷的办法是使用<code>onClick</code>属性，然而从HTML转过来的我表示不服。</p>
<p>上面的三个问题让我纠结了很久，最终的收获是：既然系统的Button不能满足需求，试试自定义view吧。</p>
<h3 id="渲染流程"><a href="#渲染流程" class="headerlink" title="渲染流程"></a>渲染流程</h3><p>在之前的布局那篇提到，所有的控件和布局都是继承自<code>View</code>的。因此，我们只需要实现一个继承自View（或者其他控件的类），在类的实现中按步骤完成一个控件（包括定制样式，事件封装等），最后在xml文件中像使用原生控件一样引用这个自定义控件就可以了。</p>
<p>在动手之前，弄明白“一个view控件是如何渲染在屏幕上的”这个问题是很有必要的，现在还没有到弄清楚整个源码的地步，只需大致了解整个渲染流程。</p>
<p>布局的操作分为两步：</p>
<ul>
<li>在<code>layout.xml</code>中定义布局，在布局中声明控件（包括指定样式，资源等）</li>
<li>在<code>activity</code>中调用<code>setContentView(R.layout.layout_id)</code>渲染整个页面</li>
</ul>
<p>上面这个过程已经高度封装了，导致我们并不能明白为什么声明了一些xml标签，系统就会按照我们指定的样式绘制出完整的页面呢？（在网页中，甚至都不需要我们调用<code>setContentView</code>之类的接口，只需要写好页面然后用浏览器打开就可以了）</p>
<p>实际上，<code>setContentView</code>这个方法实例化了<code>DecorView</code>，这个布局包含两个子布局：</p>
<ul>
<li>顶部状态栏，会处理配置的<code>FEATURE_NO_TITLE</code>这些属性，</li>
<li>页面内部区域，加载实际的<code>layout.xml</code></li>
</ul>
<p>相关控件的测量、布局、绘制等属性是通过<code>ActivityThread</code>来实现的：</p>
<ul>
<li>每个控件在定义时都继承了一系列方法用于获取渲染需要的属性</li>
<li>通过<code>setView</code>方法设置控件，包括注册事件，<strong>绘制view</strong>等</li>
<li>通过<code>addView</code>将控件添加到布局上，此时在控件标签上面的属性也会作为参数传入，</li>
</ul>
<p>具体的细节现在深入可能会很吃力，我的理解大概就是这个样子，需要明白的是：自定义控件是我们先声明和实现一个控件，然后在布局中使用这个组件的时候，系统会自动执行相关的绘制方法，最终将我们的组件绘制在activity上面。</p>
<p>因此，这里的重点就落在了如何实现一个控件的绘制，OK，有针对性的学习就简单多了。</p>
<h2 id="绘制步骤"><a href="#绘制步骤" class="headerlink" title="绘制步骤"></a>绘制步骤</h2><p>本来打算对着原生组件的源码学习的，打开最简单的<code>TextView</code>组件一看，一万多行的实现代码，吓得我哆哆嗦嗦地把窗口给关闭了，还是先理清基本的概念吧。<br>View的绘制基本上由measure()、layout()、draw()这个三个方法完成，对应的就是组件的测量，布局和绘制</p>
<h3 id="测量"><a href="#测量" class="headerlink" title="测量"></a>测量</h3><p>回到最前面的计算器需求，我只是想实现一个简单的正方形按钮，思路很简单，</p>
<ul>
<li>获取控件的宽度，</li>
<li>设置其高度等于其宽度</li>
</ul>
<p>那么问题来了，如何获取这个控件的宽度呢？肯定是需要测量的嘛。<br>测量过程由<code>measure(int, int)</code>发起，在view树中从上到下有序的测量 View，在测量过程的最后每个view存储了自己的尺寸大小和测量规格。<br>这里需要注意的是<code>measure</code>方法（被定义为<code>final</code>类型）内部调用的是<code>onMeasure</code>方法，自定义组件的时候重写<code>onMeasure</code>方法就可以了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// </div><div class="line">protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec)&#123;</div><div class="line">	// widthMeasureSpec 和 heightMeasureSpec是在测量过程中自动赋值的</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>onMeasure</code>内部又</p>
<h3 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h3><h3 id="绘制"><a href="#绘制" class="headerlink" title="绘制"></a>绘制</h3><p><code>onDraw(Canvas canvas)</code>，当看见这个<code>Canvas</code>参数的时候激动的不行~，原来是<br>在Android中，绘制由画布和画笔两部分组成</p>
<ul>
<li>画布就是这个canvas参数，系统提供了用于绘制组件的画布，拿到参数，然后把组件绘制出来就可以了，至于怎么绘制，这个就是翻手册的事情了（跟Web中的Canvas基本一样吧）。</li>
<li>画笔呢？new一个啊，画笔实际上就是一个<code>Paint</code>对象（跟Web中的context(“2d”)类似）</li>
</ul>
<h4 id="获取xml传入的参数"><a href="#获取xml传入的参数" class="headerlink" title="获取xml传入的参数"></a>获取xml传入的参数</h4><p><code>TypedArray</code></p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/自定义View" class="article_tag">#自定义View</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引子"><span class="toc-number">1.</span> <span class="toc-text">引子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原生控件的缺陷"><span class="toc-number">1.1.</span> <span class="toc-text">原生控件的缺陷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#渲染流程"><span class="toc-number">1.2.</span> <span class="toc-text">渲染流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#绘制步骤"><span class="toc-number">2.</span> <span class="toc-text">绘制步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#测量"><span class="toc-number">2.1.</span> <span class="toc-text">测量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#布局"><span class="toc-number">2.2.</span> <span class="toc-text">布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#绘制"><span class="toc-number">2.3.</span> <span class="toc-text">绘制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取xml传入的参数"><span class="toc-number">2.3.1.</span> <span class="toc-text">获取xml传入的参数</span></a></li></ol></li></ol></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>