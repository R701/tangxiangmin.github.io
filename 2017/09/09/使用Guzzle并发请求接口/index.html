<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">使用Guzzle并发请求接口</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/9/9 22:54:22</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/PHP" class="hover-highlight">PHP</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近在重构官网，为了支持SEO，整个项目的结构从采用<code>AngularJs</code>的单页面应用结构回归到PHP服务端渲染。问题来了：之前统一调用接口可以保证三端（APP，PC和移动web端）数据同步，现在如果是单独为PC端写一套业务逻辑，需要花费大量的时间精力，且后期维护可能比较困难（需要维护两处）。因此为了最大程度上保证数据同步，决定在通过服务器中转请求原始数据接口，然后渲染页面。经过筛选最终选定了<a href="http://docs.guzzlephp.org/en/stable/quickstart.html#making-a-request" target="_blank" rel="external">Guzzle</a>框架，随之而来的便是网络请求效率的问题~</p>
<a id="more"></a>
<p>这篇文章不是<code>Guzzle</code>的教程，虽然我也是看着文档刚折腾的。</p>
<h2 id="模拟环境"><a href="#模拟环境" class="headerlink" title="模拟环境"></a>模拟环境</h2><p>由于首页需要展示很多模块的数据，这意味着需要发送多个请求（大概估算了一下有18个接口）。在开发初期便发现首页打开速度非常慢，当时还以为只是接口效率的问题。后来才发现原因是：<strong>Guzzle的默认网络请求是串行的*</strong>，这意味着首页打开时间是大于等于等于所有接口请求消耗时间总和的，这是一件完全不能容忍的事情（你能忍受首页打开时间超过8秒？）。</p>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>下面是为了测试并解决这个问题所搭建的一个接口环境，采用的是node的<code>restify</code>框架。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> Restify = <span class="built_in">require</span>(<span class="string">'restify'</span>);</div><div class="line"><span class="keyword">let</span> plugins = <span class="built_in">require</span>(<span class="string">'restify-plugins'</span>);</div><div class="line"><span class="keyword">let</span> server = Restify.createServer();</div><div class="line"></div><div class="line">server.use(plugins.acceptParser(server.acceptable));</div><div class="line">server.use(plugins.authorizationParser());</div><div class="line">server.use(plugins.queryParser());</div><div class="line">server.use(plugins.bodyParser(&#123;<span class="attr">mapParams</span>: <span class="literal">true</span>&#125;));</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 等待一段时间后发送响应，模拟接口耗时，根据需要可创建多个接口</span></div><div class="line">server.get(<span class="string">"test_2000"</span>,(req, res, next)=&gt;&#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        res.send(<span class="string">"hello after 2s"</span>);</div><div class="line">    &#125;, <span class="number">2000</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.get(<span class="string">"test_1000"</span>,(req, res, next)=&gt;&#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        res.send(<span class="string">"hello after 1s"</span>);</div><div class="line">    &#125;, <span class="number">1000</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 请求路径 如 localhost:9999/test_100</span></div><div class="line">server.listen(<span class="number">9999</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'%s listening at %s'</span>, server.name, server.url);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这里的<code>test_1000</code>接口会延迟1s响应，<code>test_2000</code>会延迟2s响应，由于均为本地环境，且接口没有什么复杂的逻辑操作，因此实际的网络请求耗时可估算为代码中指定的延迟时间。</p>
<h3 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h3><p>接下来在PHP总进行测试，这里使用了<code>Laravel</code>，<code>HTTPModel</code>是对<code>Guzzle</code>进行的封装，后面我们会重写这个基类<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">ApiModel</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Promise</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestModel</span> <span class="keyword">extends</span> <span class="title">HTTPModel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_2000</span><span class="params">()</span></span>&#123;</div><div class="line">        $url = <span class="string">"/test_2000"</span>;</div><div class="line"></div><div class="line">        $data = <span class="keyword">$this</span>-&gt;get($url, []);</div><div class="line">        <span class="keyword">return</span> $data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_1000</span><span class="params">()</span></span>&#123;</div><div class="line">        $url = <span class="string">"/test_1000"</span>;</div><div class="line"></div><div class="line">        $data = <span class="keyword">$this</span>-&gt;get($url, []);</div><div class="line">        <span class="keyword">return</span> $data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里是控制器，代码就不贴全了，根据前面的接口，我们估算控制器从接受到浏览器的请求，到返回响应大概需要3s的时间<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(Request $request)</span></span>&#123;</div><div class="line">    $data1 = TestModel::getInstance()-&gt;test_1000();</div><div class="line">    $data2 = TestModel::getInstance()-&gt;test_2000();</div><div class="line"></div><div class="line">    <span class="keyword">echo</span> TestModel::getCostTime(); </div><div class="line"></div><div class="line">    dd($data1);</div><div class="line">    dd($data2);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实际输出为<code>3042ms</code>，刷新页面重复几次测试，尽管每次的结果并不是固定的，但也可以初步认为推断没有错误：整个页面的耗时是由于串行的请求接口造成的。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>由于平常基本是写Node和前端的接口，在使用PHP的时候下意识的就以为都是异步接口，导致页面打开速度太慢。既然找到了原因，那么就该解决这个问题了。</p>
<h2 id="Guzzle并发请求"><a href="#Guzzle并发请求" class="headerlink" title="Guzzle并发请求"></a>Guzzle并发请求</h2><p>实际上<a href="http://docs.guzzlephp.org/en/stable/quickstart.html#concurrent-requests" target="_blank" rel="external">文档中</a>已经提到了通过异步请求和Promise来实现并发请求，这个确实是文档的时候疏忽了（现在起码有二十多个控制器要修改~）</p>
<h3 id="并发请求"><a href="#并发请求" class="headerlink" title="并发请求"></a>并发请求</h3><p>为<code>TestModel</code>增加一个测试并发请求的方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_concurrent</span><span class="params">()</span></span>&#123;</div><div class="line">    $url_1 = <span class="string">"/test_1000"</span>;</div><div class="line">    $url_2 = <span class="string">"/test_2000"</span>;</div><div class="line"></div><div class="line">    $promises = [</div><div class="line">        <span class="keyword">$this</span>-&gt;getAsync($url_1, []),</div><div class="line">        <span class="keyword">$this</span>-&gt;getAsync($url_2, []),</div><div class="line">    ];</div><div class="line"></div><div class="line">	<span class="comment">// 这里会将请求挂起并等待请求请求结果，对于长期使用异步的前端来讲可能有点陌生，理解成async 和 await即可</span></div><div class="line">    $results = Promise\unwrap($promises);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($results <span class="keyword">as</span> $res)&#123;</div><div class="line">        $data[] = <span class="keyword">$this</span>-&gt;getResult($res);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $data;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>同上在控制器中进行测试，理论上响应的时间是由耗时最长的那个接口所决定的，这里应该是2s<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public function concurrent()&#123;</div><div class="line">    $data3 = TestModel::getInstance()-&gt;test_concurrent();</div><div class="line">    echo TestModel::getCostTime();</div><div class="line"></div><div class="line">    dd($data3);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>得到的结果是<code>2044ms</code>，与估算基本相同。当然这里没有考虑接口服务器限制最大并发请求数量的情况，这个后面再提。</p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>从上面的两个测试可以看出，确实是由于串行的请求导致了响应时间过慢，而当前的解决办法就是将串行请求，比如由于业务逻辑的不同，页面上的某个数据需要请求多个接口，我们可以在Model中进行异步请求，最终合并结果并返回数据。</p>
<p>但是，考虑另外一个问题：一个页面可能需要调用多个接口，这些接口由不同的Model抽象，这意味着不同Model接口的调用仍旧是串行的，而我们最终需要的效果应当是<strong>将某个控制器方法中的所有请求都进行并发处理</strong>，这样才能最大程度上减少接口调用所带来的网络延迟。</p>
<p>也就是说，我们需要实现的是：先由不同的模型准备接口请求，然后再统一发起请求。下面我们尝试着对<code>Guzzle</code>进行封装并实现这个需求。</p>
<h2 id="封装Guzzle"><a href="#封装Guzzle" class="headerlink" title="封装Guzzle"></a>封装Guzzle</h2><p>虽然具体的方向已经确定了，但还有很多细节需要整理：</p>
<ul>
<li>请求由不同的模型生成，最后统一发送，这里可以使用单例实现。</li>
<li>需要保证模型在控制器中的调用习惯（即同步代码），这是因为需要根据返回的数据处理部分业务逻辑，可以使用闭包和数据引用传递实现</li>
</ul>
<h3 id="初步实现"><a href="#初步实现" class="headerlink" title="初步实现"></a>初步实现</h3><p>首先实现请求基类<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Cookie</span>\<span class="title">CookieJar</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Promise</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPModel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">protected</span> $hostname = <span class="string">"localhost:9999"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> $client;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $count = <span class="number">0</span>;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $start_at;</div><div class="line">    <span class="comment">// 用来保存异步请求</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> $asyncRequest = [];</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instances = [];</div><div class="line">	</div><div class="line">	<span class="comment">// 实例化guzzle client对象</span></div><div class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// 统计请求耗时</span></div><div class="line">        <span class="keyword">self</span>::$start_at = <span class="keyword">self</span>::getMicrTime();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;client = <span class="keyword">new</span> Client([</div><div class="line">            <span class="string">'base_uri'</span> =&gt; <span class="string">"http://&#123;$this-&gt;hostname&#125;/index.php"</span>,</div><div class="line">            <span class="string">'timeout'</span>  =&gt; <span class="number">3.0</span>,</div><div class="line">        ]);</div><div class="line">    &#125;</div><div class="line">		</div><div class="line">	<span class="comment">// 单例	</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $name = get_called_class();</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">self</span>::$instances[$name])) &#123;</div><div class="line">            <span class="keyword">self</span>::$instances[$name] = <span class="keyword">new</span> <span class="keyword">static</span>();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$instances[$name];</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 异步请求</span></div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAsync</span><span class="params">($url, $opts, $callback)</span></span>&#123;</div><div class="line">        <span class="keyword">self</span>::$count++;</div><div class="line">        $async = <span class="keyword">$this</span>-&gt;client-&gt;getAsync($url, $opts);</div><div class="line">		</div><div class="line">		<span class="comment">// 这里只是简单处理将请求和回调函数关联在一起</span></div><div class="line">        $obj = <span class="keyword">new</span> \stdClass();</div><div class="line">        $obj-&gt;request = $async;</div><div class="line">        $obj-&gt;callback = $callback;</div><div class="line">		</div><div class="line">		<span class="comment">// 将请求保存起来</span></div><div class="line">        <span class="keyword">self</span>::$asyncRequest[] = $obj;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $async;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	<span class="comment">// 统一发送请求</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">startAsync</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">        $asyncRequest = <span class="keyword">self</span>::$asyncRequest;</div><div class="line">        <span class="keyword">foreach</span> ($asyncRequest <span class="keyword">as</span> $request)&#123;</div><div class="line">            $promises[] = $request-&gt;request;</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 发送请求，等待响应 </span></div><div class="line">        $results = Promise\unwrap($promises);</div><div class="line"></div><div class="line">        <span class="keyword">foreach</span> ($results <span class="keyword">as</span> $index=&gt;$res)&#123;</div><div class="line">            $data = <span class="keyword">$this</span>-&gt;getResult($res);</div><div class="line">            $callback = $asyncRequest[$index]-&gt;callback;</div><div class="line">            <span class="comment">// 执行回调函数</span></div><div class="line">            $callback($data);</div><div class="line">        &#125;</div><div class="line">		</div><div class="line">		<span class="comment">// 清空请求队列</span></div><div class="line">        <span class="keyword">self</span>::$asyncRequest = [];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 还有一些其他的工具方法，暂时不列出来了</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们还是定义一个<code>TestModel</code>，用于接口测试，由于在模型类中需要处理数据，因此在这里声明回调函数用于处理响应结果，其中<code>$result</code>是控制器中的引用变量，用于在控制器中获取结果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestModel</span> <span class="keyword">extends</span> <span class="title">HTTPModel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_2000_c</span><span class="params">(&amp;$result)</span></span>&#123;</div><div class="line">        $url = <span class="string">"/test_2000"</span>;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getAsync($url, [], <span class="function"><span class="keyword">function</span><span class="params">($data)</span><span class="title">use</span><span class="params">(&amp;$result)</span></span>&#123;</div><div class="line">            $result = $data;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_1000_c</span><span class="params">(&amp;$result)</span></span>&#123;</div><div class="line">        $url = <span class="string">"/test_1000"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getAsync($url, [], <span class="function"><span class="keyword">function</span><span class="params">($data)</span><span class="title">use</span><span class="params">(&amp;$result)</span></span>&#123;</div><div class="line">            $result = $data;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后在控制器中调用<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line"> 	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">async</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">		<span class="comment">// 预先定义引用变量</span></div><div class="line">        $data[<span class="string">'data1'</span>] = [];</div><div class="line">        $data[<span class="string">'data2'</span>] = [];</div><div class="line">			</div><div class="line">		<span class="comment">// 生成请求	</span></div><div class="line">        TestModel::getInstance()-&gt;test_1000_c($data[<span class="string">'data1'</span>]);</div><div class="line">        TestModel::getInstance()-&gt;test_2000_c($data[<span class="string">'data2'</span>]);</div><div class="line">		</div><div class="line">		<span class="comment">// 发送并发请求</span></div><div class="line">        TestModel::getInstance()-&gt;startAsync();</div><div class="line"> 		</div><div class="line"> 		<span class="comment">// 查看结果</span></div><div class="line">        <span class="comment">// echo TestModel::getCostTime(); // 2026ms</span></div><div class="line">        <span class="comment">// var_dump($data1); // hello after 1s</span></div><div class="line">        <span class="comment">// var_dump($data2); // hello after 2s</span></div><div class="line">		</div><div class="line">		<span class="comment">// 输出数据</span></div><div class="line">        <span class="keyword">return</span> view(<span class="string">"test"</span>,$data);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样貌似就达到了我们的目的，其中核心的思想是通过单例来维护所有模型需要调用的接口请求（这样就不用纠结于到底是哪个模型需要调用接口），然后手动触发网络请求。<br>很明显，这比串行调用接口的效率要高很多，尤其是需要调用很多接口的页面（比如首页）。而在控制器中，对数据的处理还基本维持了串行调用的同步习惯（只是需要手动调用<code>startAsync</code>而已）。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我对PHP并不是很了解，实际上这只是针对于三端数据统一所做的尝试，使用服务器中转调用第三方接口肯定会影响效率，后面这里的接口可能会被重构掉。事实上我当我把之前的串行代码替换之后，提高的速度也并不是那么明显，貌似真正的性能瓶颈在数据库那里，这完完全全是后端的事儿了~</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/Guzzle" class="article_tag">#Guzzle</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟环境"><span class="toc-number">1.</span> <span class="toc-text">模拟环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口"><span class="toc-number">1.1.</span> <span class="toc-text">接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求"><span class="toc-number">1.2.</span> <span class="toc-text">请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小结"><span class="toc-number">1.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Guzzle并发请求"><span class="toc-number">2.</span> <span class="toc-text">Guzzle并发请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#并发请求"><span class="toc-number">2.1.</span> <span class="toc-text">并发请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#思考"><span class="toc-number">2.2.</span> <span class="toc-text">思考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#封装Guzzle"><span class="toc-number">3.</span> <span class="toc-text">封装Guzzle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初步实现"><span class="toc-number">3.1.</span> <span class="toc-text">初步实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>