<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/blog.css">
    <link rel="stylesheet" href="/css/fonts/iconfont.css">
    <!--<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">-->
    <link rel="stylesheet" href="//cdn.bootcss.com/fancybox/3.1.25/jquery.fancybox.min.css">
    <script src="/js/require.js" data-main="/js/main"></script>
</head>
<body>
<div id="blog" class="page page-theme-base" v-cloak>
    <blog-header></blog-header>
    <header class="page_hd" data-v-04342fbc="">
    <div class="container header" data-v-04342fbc="">
        <h1 class="logo" data-v-04342fbc="">
            <a href="/" class="nuxt-link-exact-active nuxt-link-active" data-v-04342fbc="">橙红年代</a>
        </h1>
        <div class="show-md" data-v-04342fbc="">
            <div class="btn-list" data-v-04342fbc="">
                <div class="btn-icon" data-v-04342fbc="">
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                    <span class="btn-line" data-v-04342fbc=""></span>
                </div>
            </div>
        </div>
        <nav class="nav-responsive" data-v-04342fbc="">
            
            <a class="nav_item" href="/">首页</a>
            
            <a class="nav_item" href="/archives">归档</a>
            
            <a class="nav_item" href="/tags">标签</a>
            
            <a class="nav_item" href="/test">Test</a>
            
        </nav>
    </div>
</header>
    <main class="page_mn" >
        <div class="container">
            <article class="article article-detail">
    <header class="text-center">
        <h2 class="article_hd">npm与一次版本更新事故</h2>
        <div class="article_info">
            <span class="hide-sm">发表于</span>
            <span class="show-sm">
                <i class="iconfont icon-archives"></i>
            </span>
            <time>2017/10/29 23:43:36</time>
            |
            <span class="hide-sm">分类于</span>
            <span class="show-sm"><i class="iconfont icon-tag"></i></span>
            
                <a href="/categories/JavaScript" class="hover-highlight">JavaScript</a>
            

        </div>
    </header>
    <div class="article_ct">
        <p>最近<code>Element-ui</code>发布了2.0的版本，打算将之前为项目搭的后台管理系统进行升级，由于之前这方面的经验比较少，导致出现了一些比较蛋疼的问题，甚至导致本地的开发环境接近崩溃，于是记录下来，并整理的与npm相关的一些问题。</p>
<a id="more"></a>
<p>参考：</p>
<ul>
<li><a href="https://docs.npmjs.com/" target="_blank" rel="external">npm文档</a></li>
</ul>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>事情的经过是这样的：</p>
<p>去官网查文档的时候提示发布了<a href="https://github.com/ElemeFE/element/issues/7755" target="_blank" rel="external">2.0正式版</a>，发现添加了一些比较有用的功能（比如嵌套dialog、自定义icon以及组件样式更新等），于是在本地开了一个分支<code>update_ele</code>。</p>
<p>由于<code>node_modules</code>一般会放在<code>.gitignore</code>中忽略提交，因此对于这种需要进行依赖库升级的分支，必须在切换分支时手动更新依赖库。(实际上克隆仓库然后单独更新应该是更明智的做法，但是当时脑子抽了，导致了后面的一系列问题)</p>
<p>事实上我对于npm也只停留在初级使用的阶段，所以相关的更新操作等都是边查文档边进行的。</p>
<p>然后就开始折腾了。</p>
<h2 id="npm安装依赖包"><a href="#npm安装依赖包" class="headerlink" title="npm安装依赖包"></a>npm安装依赖包</h2><h3 id="安装细节"><a href="#安装细节" class="headerlink" title="安装细节"></a>安装细节</h3><p>通常在开发过程中，我们会按需安装相关的包，并且可以通过<code>save</code> 和<code>save-dev</code>连个参数将该包添加进<code>package.json</code>，方便多人协作开发。他们的区别在于：</p>
<ul>
<li><code>save</code>将包添加进<code>dependencies</code>字段下，对应的运行时依赖库，即项目本身依赖的库，比如vue，jQuery等，简写方式<code>-S</code></li>
<li><code>save-dev</code>将包添加进<code>devDependencies</code>下，对应的时开发时依赖库，比如<code>gulp</code>等，简写方式<code>-D</code></li>
</ul>
<p>然而打开<code>package.json</code>我们会发现，大部分依赖包前面的都会有<code>^</code>或<code>~</code>的符号，他们的意思是，在使用<code>npm install</code>命令时：</p>
<ul>
<li><code>^</code>会匹配最新的大版本依赖包，比如^1.2.3会匹配所有1.x.x的包，包括1.3.0，但是不包括2.0.0</li>
<li><code>~</code>会匹配最近的小版本依赖包，比如~1.2.3会匹配所有1.2.x版本，但是不包括1.3.0</li>
<li>如果没有任何前置修饰符，则表示安装对应制定的版本号</li>
</ul>
<p>详情可见<a href="https://docs.npmjs.com/getting-started/semantic-versioning" target="_blank" rel="external">文档</a>。默认使用<code>-S</code>或<code>-D</code>安装时会自动添加<code>^</code>修饰符，因此在某些时候会造成版本的不兼容（所以说发版本包的时候版本号不能乱取啊）</p>
<h3 id="查看已安装的版本"><a href="#查看已安装的版本" class="headerlink" title="查看已安装的版本"></a>查看已安装的版本</h3><p>通过上面我们知道<code>package.json</code>中的版本号，如果有前缀修饰符，则不能代表当前项目中具体使用的版本，如果我们需要查看具体的版本号，可以使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm list --depth=0</div></pre></td></tr></table></figure>
<p>对应包名后面的<code>@x.x.x</code>即为当前使用的版本号，由npm自动帮助我们管理版本依赖。</p>
<h3 id="安装指定版本"><a href="#安装指定版本" class="headerlink" title="安装指定版本"></a>安装指定版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看对应包的所有可用版本</span></div><div class="line">npm view element-ui versions</div><div class="line"></div><div class="line"><span class="comment"># 安装2.0.0</span></div><div class="line">npm i element-ui@2.0.0 -S</div></pre></td></tr></table></figure>
<h3 id="锁定版本"><a href="#锁定版本" class="headerlink" title="锁定版本"></a>锁定版本</h3><p><code>npm install</code>会根据修饰符更新版本带来的一个问题就是版本兼容，如果我们自己的项目依赖于某个包的某个版本的特性，在该依赖包升级之后，向后兼容的代价也许会比较大。因此我们可能需要某种锁定包版本的问题。</p>
<p>一种方法是使用去除<code>package.json</code>的前缀修饰符，仅保留精确的版本号。</p>
<p>另一种方法是<a href="https://docs.npmjs.com/files/package-lock.json" target="_blank" rel="external">package-lock.json</a>。</p>
<p>升级到node8.0以后，npm也会升级到npm5，在之前的项目中使用npm进行安装的时候，会发现多了一个<code>package-lock.json</code>的文件，</p>
<ul>
<li>该文件中已经记录了整个 <code>node_modules</code> 文件夹的树状结构，甚至连模块的下载地址都记录了，再重新安装的时候只需要直接下载文件即可。</li>
<li>当存在<code>package-lock.json</code>的文件时，使用<code>npm install</code>将不会再根据前缀修饰符更新模块（准确的说不会根据<code>package.json</code>文件安装模块），更新模块只能使用<code>npm install xxx@v.v.v</code>这样的形式进行，此时会自动更新<code>package-lock.json</code>的信息。</li>
</ul>
<p>通过<code>package-lock</code>的文件可以保证项目保持一系列固定的依赖版本，而不同担心依赖库升级导致的版本冲突。</p>
<p>在之前使用过的PHP包管理工具<code>composer</code>中貌似也有对应的用于锁定版本的处理机制，即<code>composer-lock</code>文件。</p>
<h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><p>国内使用npm安装包比较慢，一般会使用镜像比如<a href="http://npm.taobao.org/" target="_blank" rel="external">淘宝镜像</a>，这里存在的坑是：尽量使用修改镜像仓库地址的方式，而不是使用<code>cnpm</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm config <span class="built_in">set</span> registry http://registry.npm.taobao.org/</div></pre></td></tr></table></figure>
<p>因为早前使用<code>cnpm</code>遇见了很多依赖库版本不一致产生的冲突问题，比如</p>
<ul>
<li><a href="https://segmentfault.com/q/1010000011206338/a-1020000011403855" target="_blank" rel="external">weex的Demo报错</a></li>
</ul>
<h2 id="版本升级"><a href="#版本升级" class="headerlink" title="版本升级"></a>版本升级</h2><p>上面整理了npm使用过程中遇见的一些知识点。接下来就是回顾这次<code>element-ui</code>版本升级中遇见的一些问题。这应该也是大部分依赖库的升级过程中可能会遇到的问题。</p>
<h3 id="接口兼容"><a href="#接口兼容" class="headerlink" title="接口兼容"></a>接口兼容</h3><p>类似于<code>1.x</code>到<code>2.x</code>之类的大版本更新，相关的接口改动可能会比较多，因此动手之前记得先查看官方的更新日志，比如<a href="https://github.com/ElemeFE/element/releases" target="_blank" rel="external">releases</a>。这样对于可能产生冲突的地方会有大致的了解。</p>
<p>比如<code>element-ui</code>2.0的版本对图标、dialog等组件进行了调整，在控制台也可以看见相关的警告（侧面说明选择一个稳定的库是多么重要）</p>
<h3 id="版本兼容"><a href="#版本兼容" class="headerlink" title="版本兼容"></a>版本兼容</h3><p>当我在新分支安装了2.0，更新了新接口之后，切换到旧分支时，需要重新安装对应版本的<code>element-ui</code>，通过查看<code>package.json</code>中的分支</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">"dependencies": &#123;</div><div class="line">    "element-ui": "^1.2.9",</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后手动安装了<code>npm i element-ui@1.2.9 -S</code>，然后发现样式不对~想必您已经知道原因了：前缀修饰符的存在导致<code>package.json</code>中的版本不一定正确。</p>
<p>然而当时我并不知道这个原因，然后又升级了<code>vue</code>的版本，接着<code>vue-loader</code>等一系列脚手架依赖库都报出了版本不对的错误，整个人都懵逼了。最后折腾了半天，删除了<code>node_modules</code>文件重新安装，最终可以跑起来了，然而我到现在都还不知道有没有引入新的BUG。</p>
<p>正如前面提到的，针对项目依赖库的升级，更明智的选择应当是克隆一个本地仓库然后独立进行开发，由于<code>.gitignore</code>的存在，多个分支会公用这部分本地文件，而来回的改动肯定会比较麻烦。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>git</code>用的不是很熟，<code>npm</code>用的也不熟，所以导致了这次事故的发生，幸好只是本地的开发环境崩掉了，不然后果还是比较严重的。</p>
<p>另外关于<code>yarn</code>基本上也没有接触过，有空可以试试。</p>

    </div>
    <footer class="article_ft">
        
        <a href="/tags/npm" class="article_tag">#npm</a>
        
    </footer>

    <div class="article_nav"><a href="/article/mockjs使用心得" class="hover-highlight article_prev">mockjs使用心得</a><a
                href="/article/博客SSR实践总结" class="hover-highlight article_next">博客SSR实践总结</a></div>
</article>
        </div>
    </main>

    <aside>
    <div class="page_sd hide-md">
        <div class="tab">
            <!---->
            
            <ul class="tab_nav">
                <li class="tab_item active" data-target="#J_toc">
                    文章目录
                </li>
                <li class="tab_item" data-target="#J_profile">
                    站点资料
                </li>
            </ul>
            <div class="tab_panel active" id="J_toc">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起因"><span class="toc-number">1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm安装依赖包"><span class="toc-number">2.</span> <span class="toc-text">npm安装依赖包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装细节"><span class="toc-number">2.1.</span> <span class="toc-text">安装细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看已安装的版本"><span class="toc-number">2.2.</span> <span class="toc-text">查看已安装的版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装指定版本"><span class="toc-number">2.3.</span> <span class="toc-text">安装指定版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#锁定版本"><span class="toc-number">2.4.</span> <span class="toc-text">锁定版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#镜像"><span class="toc-number">2.5.</span> <span class="toc-text">镜像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#版本升级"><span class="toc-number">3.</span> <span class="toc-text">版本升级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口兼容"><span class="toc-number">3.1.</span> <span class="toc-text">接口兼容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#版本兼容"><span class="toc-number">3.2.</span> <span class="toc-text">版本兼容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li></ol>
            </div>
            
            <div class="tab_panel " id="J_profile">
                <div>
                    <div class="me">
                        <img src="http://shymean.com/_nuxt/img/head.dd612ee.jpg" alt="shymean" width="100" height="100">
                        <h3>shymean</h3>
                        <p>一个不学无术且无趣的人。</p>
                    </div>
                    <div class="nav-border">
                        <a href="/book" class="nav_item">
                            <i class="iconfont icon-bookshelf"></i>
                            <br>书架
                        </a>
                        <a href="/message" class="nav_item">
                            <i class="iconfont icon-comment"></i>
                            <br>留言
                        </a>
                        <a href="/about" class="nav_item">
                            <i class="iconfont icon-info"></i>
                            <br>关于
                        </a>
                    </div>
                    <div class="contact">
                        <a href="https://github.com/tangxiangmin" target="_blank" class="contact_link">
                            <i class="iconfont icon-github"></i> GitHub</a>
                        <a href="http://wpa.qq.com/msgrd?v=3&amp;uin=645234650&amp;site=qq&amp;menu=yes"
                            target="_blank" class="contact_link">
                            <i class="iconfont icon-qq"></i> QQ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tool">
        <div class="btn-list hide-md" id="J_toggleSide">
            <div class="btn-icon">
                <span class="btn-line"></span>
                <span class="btn-line"></span>
                <span class="btn-line"></span>
            </div>
        </div>
        <div class="btn-top">
            <i class="iconfont icon-top"></i>
        </div>
    </div>
</aside>
    <footer class="page_ft">
    <div class="container footer">
        <p>世人的悲欢并不相通，我只是觉得他们吵闹。</p>
        <p>
            Copyright © Shymean 2016 - 2017
            <a href="http://www.miitbeian.gov.cn" rel="nofollow" target="_blank" style="display:inline-block;">粤ICP备17060238号-1</a>
        </p>
    </div>
    <div class="hide-xs">
        <script src="https://s19.cnzz.com/z_stat.php?id=1264491168&amp;web_id=1264491168" language="JavaScript"></script>
    </div>
</footer>

</div>

</body>
</html>